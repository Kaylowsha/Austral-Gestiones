<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barber√≠a SaaS - Sistema de Gesti√≥n</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Configuraci√≥n -->
    <script src="config.js"></script>
    
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Animaciones personalizadas */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Pantalla de Login -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full fade-in">
            <div class="text-center mb-8">
                <i class="fas fa-cut text-6xl text-blue-600 mb-4"></i>
                <h1 class="text-3xl font-bold text-gray-800">Barber√≠a SaaS</h1>
                <p class="text-gray-600 mt-2">Sistema de Gesti√≥n Profesional</p>
            </div>
            
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-envelope mr-2"></i>Email
                    </label>
                    <input 
                        type="email" 
                        id="email" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="tu@email.com"
                        required
                    >
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-lock mr-2"></i>Contrase√±a
                    </label>
                    <input 
                        type="password" 
                        id="password" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                        required
                    >
                </div>
                
                <button 
                    type="submit" 
                    class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-200"
                >
                    <i class="fas fa-sign-in-alt mr-2"></i>Iniciar Sesi√≥n
                </button>
            </form>
            
            <div id="loginError" class="mt-4 p-3 bg-red-100 text-red-700 rounded-lg hidden">
                <i class="fas fa-exclamation-circle mr-2"></i>
                <span id="loginErrorText"></span>
            </div>
            
            <div class="mt-6 text-center text-sm text-gray-600">
                <p>¬øPrimera vez? Contacta al administrador</p>
            </div>
        </div>
    </div>
    
    <!-- Pantalla Principal (oculta inicialmente) -->
    <div id="mainApp" class="hidden">
        <!-- Barra de Navegaci√≥n -->
        <nav class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <i class="fas fa-cut text-2xl text-blue-600 mr-3"></i>
                        <span class="font-bold text-xl">Barber√≠a SaaS</span>
                        <span id="barberiaName" class="ml-4 text-gray-600"></span>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <span id="userName" class="text-gray-700"></span>
                        <span id="userRole" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm"></span>
                        <button onclick="logout()" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-sign-out-alt"></i> Salir
                        </button>
                    </div>
                </div>
            </div>
        </nav>
        
        <!-- Alerta de Trial -->
        <div id="trialAlert" class="hidden bg-yellow-100 border-l-4 border-yellow-500 p-4">
            <div class="flex items-center">
                <i class="fas fa-exclamation-triangle text-yellow-700 mr-3"></i>
                <p id="trialMessage" class="text-yellow-700"></p>
            </div>
        </div>
        
        <!-- Tabs de Navegaci√≥n -->
        <div class="bg-white border-b">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex space-x-1 overflow-x-auto py-2" id="tabContainer">
                    <!-- Los tabs se generar√°n din√°micamente seg√∫n el rol -->
                </div>
            </div>
        </div>
        
        <!-- Contenido Principal -->
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div id="contentArea" class="bg-white rounded-lg shadow p-6">
                <!-- El contenido se cargar√° din√°micamente -->
            </div>
        </div>
    </div>
    
    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg">
            <div class="loading-spinner mx-auto"></div>
            <p class="mt-4 text-gray-600">Cargando...</p>
        </div>
    </div>
    
    <!-- Script Principal -->
    <script>
        // ===============================
        // CONFIGURACI√ìN DE SUPABASE
        // ===============================
        const SUPABASE_URL = SUPABASE_CONFIG.url;
        const SUPABASE_ANON_KEY = SUPABASE_CONFIG.anonKey;
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
       // Variables globales
let currentUser = null;
let currentBarberia = null;
let userRole = null;

// Variables del carrito de productos
let carritoProductos = [];

// ===============================
// FUNCIONES DE FECHA CHILE
// ===============================
function getFechaChile() {
    const ahora = new Date();
    const fechaChile = new Date(ahora.toLocaleString("en-US", {timeZone: "America/Santiago"}));
    const a√±o = fechaChile.getFullYear();
    const mes = String(fechaChile.getMonth() + 1).padStart(2, '0');
    const dia = String(fechaChile.getDate()).padStart(2, '0');
    return `${a√±o}-${mes}-${dia}`;
}

function getTimestampChile() {
    const ahora = new Date();
    const fechaChile = new Date(ahora.toLocaleString("en-US", {timeZone: "America/Santiago"}));
    return fechaChile.toISOString();
}

function parseFechaChile(fechaString) {
    const [a√±o, mes, dia] = fechaString.split('-');
    return new Date(parseInt(a√±o), parseInt(mes) - 1, parseInt(dia));
}
        // ===============================
        // FUNCIONES DE AUTENTICACI√ìN
        // ===============================
     document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    
    showLoading();
    hideError();
    
    try {
        // LOGIN DIN√ÅMICO - Consultas separadas para evitar RLS
        console.log('üîç Buscando usuario:', email);
        
// Buscar usuario por email (sin filtrar por activo todav√≠a)
const { data: usuarios, error } = await supabase
    .from('usuarios')
    .select('*')
    .eq('email', email)
    .single();

if (error || !usuarios) {
    console.error('‚ùå Usuario no encontrado:', error);
    showError('Usuario no encontrado.');
    hideLoading();
    return;
}

// Verificar si est√° activo (con excepci√≥n para admin)
if (!usuarios.activo) {
    // Si es ADMIN, permitir entrar aunque est√© inactivo (para ver mensaje de pago)
    if (usuarios.role === 'admin') {
        console.log('‚ö†Ô∏è Admin de barber√≠a inactiva - Permitiendo acceso para gestionar pago');
    } else {
        // Si es EMPLEADO, bloquear acceso
        console.log('‚ö†Ô∏è Empleado de barber√≠a inactiva - Bloqueando acceso');
        showError('Tu cuenta est√° inactiva. Contacta al administrador.');
        hideLoading();
        return;
    }
}

console.log('‚úÖ Usuario encontrado:', usuarios.nombre);

// Consultar barber√≠a por separado
console.log('üîç Buscando barber√≠a ID:', usuarios.barberia_id);

const { data: barberia, error: errorBarberia } = await supabase
    .from('barberias')
    .select('id, nombre, plan, trial_hasta, activa')
    .eq('id', usuarios.barberia_id)
    .single();

if (errorBarberia || !barberia) {
    console.error('‚ùå Barber√≠a no encontrada:', errorBarberia);
    showError('Error del sistema. Contacta soporte.');
    hideLoading();
    return;
}

// Verificar si la barber√≠a est√° activa
if (!barberia.activa) {
    console.log('‚ö†Ô∏è Barber√≠a inactiva:', barberia.nombre);
    
    // Si es ADMIN, permitir entrar para que vea el banner de pago
    if (usuarios.role === 'admin') {
        console.log('‚úÖ Admin puede entrar aunque barber√≠a inactiva - Ver√° banner de pago');
        // Continuar con el login normalmente (no hacer return)
    } else {
        // Si es EMPLEADO, bloquear completamente
        console.log('üö´ Empleado bloqueado - Barber√≠a inactiva');
        
        // Verificar si es por trial vencido
        if (barberia.plan === 'trial' && barberia.trial_hasta) {
            const hoy = new Date();
            const trialHasta = new Date(barberia.trial_hasta);
            if (hoy > trialHasta) {
                showError('Tu per√≠odo de prueba ha terminado. Contacta al administrador para activar tu cuenta.');
            } else {
                showError('Tu barber√≠a est√° temporalmente inactiva. Contacta al administrador.');
            }
        } else {
            showError('Tu barber√≠a est√° inactiva. Contacta al administrador para reactivarla.');
        }
        hideLoading();
        return;
    }
}

console.log('‚úÖ Barber√≠a encontrada:', barberia.nombre);
    
    

      // Validar contrase√±a contra la base de datos
        if (password !== usuarios.password) {
            console.log('‚ùå Contrase√±a incorrecta. Ingresada:', password, 'Esperada:', usuarios.password);
            showError('Contrase√±a incorrecta.');
            hideLoading();
            return;
        }
        
        console.log('‚úÖ Contrase√±a correcta');

        // Login exitoso - Datos din√°micos reales
        const userData = {
            id: usuarios.id,
            email: usuarios.email,
            nombre: usuarios.nombre,
            role: usuarios.role,
            barberia_id: usuarios.barberia_id,
            barberias: barberia  // Asignar barber√≠a correctamente
        };

        // Crear variables globales din√°micas (SIN DUPLICAR)
        window.CURRENT_BARBERIA_DATA = barberia;
        window.CURRENT_BARBERIA_ID = barberia.id;
        
        console.log('üéØ Variables globales establecidas:', {
            barberia_id: window.CURRENT_BARBERIA_ID,
            barberia_nombre: window.CURRENT_BARBERIA_DATA.nombre
        });
        
        // Asignar a variables globales del sistema
        currentUser = userData;
        currentBarberia = barberia;  // Usar barberia directamente
        userRole = userData.role;
        
        // Guardar en localStorage
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        localStorage.setItem('userRole', userRole);
        
        console.log('‚úÖ Login exitoso, iniciando aplicaci√≥n...');
        // VALIDACI√ìN FINAL antes de inicializar
        console.log('üîç VALIDACI√ìN FINAL:', {
            'window.CURRENT_BARBERIA_ID': window.CURRENT_BARBERIA_ID,
            'window.CURRENT_BARBERIA_DATA': window.CURRENT_BARBERIA_DATA,
            'currentUser.barberia_id': currentUser.barberia_id,
            'currentBarberia.id': currentBarberia.id
        });
        
        if (!window.CURRENT_BARBERIA_ID) {
            console.error('‚ùå CR√çTICO: barberia_id perdido antes de inicializar app');
            alert('Error cr√≠tico: barberia_id no disponible. Recarga la p√°gina.');
            return;
        }
        initializeApp();
        
    } catch (error) {
        console.error('‚ùå Error general:', error);
        showError('Error al iniciar sesi√≥n. Intenta nuevamente.');
    }
    
    hideLoading();
});
        
        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            const errorText = document.getElementById('loginErrorText');
            errorText.textContent = message;
            errorDiv.classList.remove('hidden');
        }
        
        function hideError() {
            document.getElementById('loginError').classList.add('hidden');
        }
        
        function showLoading() {
            document.getElementById('loadingSpinner').classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loadingSpinner').classList.add('hidden');
        }
        
        // ===============================
        // INICIALIZACI√ìN DE LA APP
        // ===============================
        function initializeApp() {
            // DEBUG: Verificar estado al inicializar
            console.log('üîç ESTADO AL INICIALIZAR APP:', {
                'window.CURRENT_BARBERIA_ID': window.CURRENT_BARBERIA_ID,
                'currentUser': currentUser,
                'currentBarberia': currentBarberia
            });
            // Ocultar login, mostrar app
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
          
            // üîÑ LIMPIAR CACHE AL INICIALIZAR
    // Esto fuerza recarga de datos frescos cada vez que se abre la app
    window.serviciosGlobales = [];
    window.serviciosGlobalesStats = [];
    window.serviciosGlobalesMetodos = [];
    window.serviciosGlobalesProductividad = [];
    window.serviciosGlobalesTendencia = [];
    console.log('üßπ Cache limpiado - datos frescos garantizados');
            
            // Actualizar informaci√≥n del usuario
            document.getElementById('userName').textContent = currentUser.nombre;
            document.getElementById('userRole').textContent = userRole === 'admin' ? 'Administrador' : 'Empleado';
            
         // Actualizar informaci√≥n de barber√≠a con datos reales
const barberiaInfo = window.CURRENT_BARBERIA_DATA;
if (barberiaInfo && barberiaInfo.nombre) {
    document.getElementById('barberiaName').textContent = barberiaInfo.nombre;
    console.log('‚úÖ Barber√≠a cargada:', barberiaInfo.nombre, 'Plan:', barberiaInfo.plan || 'Sin plan');
} else {
    document.getElementById('barberiaName').textContent = '';
    console.log('‚ö†Ô∏è No se pudo cargar informaci√≥n de barber√≠a');
}
            
            // Verificar y mostrar alerta de trial si aplica
            checkTrialStatus();
            
            // Generar tabs seg√∫n el rol
            generateTabs();
            
            // Cargar la primera pesta√±a
            loadTab('registrar');
        }
        
   async function checkTrialStatus() {
    const barberiaData = window.CURRENT_BARBERIA_DATA;
    
    if (!barberiaData) return;
    
    // Verificar si la barber√≠a est√° inactiva (plan vencido)
    if (!barberiaData.activa) {
        mostrarBannerVencimiento();
        bloquearFuncionesVencidas();
        return;
    }
    
    // Si est√° activa pero en trial, mostrar d√≠as restantes
    if (barberiaData.plan === 'trial') {
        document.getElementById('trialAlert').classList.remove('hidden');
        
        const diasRestantes = calcularDiasRestantes(barberiaData.trial_hasta);
        const mensaje = diasRestantes > 0 
            ? `Per√≠odo de prueba activo. ${diasRestantes} d√≠as restantes.`
            : 'Per√≠odo de prueba EXPIRADO. Contacta al administrador.';
            
        document.getElementById('trialMessage').textContent = mensaje;
        console.log('‚è∞ Trial status:', mensaje);
    }
}

// Funci√≥n para mostrar banner de vencimiento (bloqueo suave)
function mostrarBannerVencimiento() {
    const barberiaNombre = window.CURRENT_BARBERIA_DATA?.nombre || 'tu barber√≠a';
    
    // Crear banner prominente
    const banner = document.createElement('div');
    banner.id = 'bannerVencimiento';
    banner.className = 'bg-gradient-to-r from-red-600 to-red-700 text-white sticky top-0 z-50 shadow-2xl';
    banner.innerHTML = `
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                    <div class="bg-white bg-opacity-20 rounded-full p-3">
                        <i class="fas fa-exclamation-triangle text-3xl"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold">‚ö†Ô∏è Suscripci√≥n Vencida</h3>
                        <p class="text-red-100 text-sm">Tu per√≠odo de prueba ha terminado. Paga para seguir usando el sistema.</p>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button onclick="abrirMercadoPago()" 
                        class="bg-white text-red-600 px-6 py-3 rounded-lg font-bold hover:bg-red-50 transition-colors shadow-lg flex items-center gap-2">
                        <i class="fas fa-credit-card"></i>
                        Pagar $15.000
                    </button>
                    <button onclick="confirmarPagoWhatsApp()" 
                        class="bg-green-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-600 transition-colors shadow-lg flex items-center gap-2">
                        <i class="fab fa-whatsapp"></i>
                        Confirmar Pago
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Insertar despu√©s del nav
    const nav = document.querySelector('nav');
    nav.after(banner);
    
    console.log('üö´ Banner de vencimiento mostrado - Bloqueo suave activado');
}

// Funci√≥n para bloquear funciones (bloqueo suave)
function bloquearFuncionesVencidas() {
    console.log('üîí Aplicando bloqueo suave - Solo lectura');
    
    // Deshabilitar formularios de registro
    const formRegistro = document.getElementById('registroForm');
    if (formRegistro) {
        formRegistro.addEventListener('submit', (e) => {
            e.preventDefault();
            alert('‚ö†Ô∏è Suscripci√≥n vencida\n\nPara registrar servicios, debes renovar tu suscripci√≥n.\nPaga $15.000/mes y reactiva tu cuenta.');
        });
        
        // Agregar overlay visual
        const registroContainer = formRegistro.closest('.max-w-2xl');
        if (registroContainer) {
            registroContainer.style.opacity = '0.6';
            registroContainer.style.pointerEvents = 'none';
        }
    }
    
    // Deshabilitar botones de acci√≥n en otras pesta√±as
    setTimeout(() => {
        const botonesAccion = document.querySelectorAll('button[onclick*="registrar"], button[onclick*="agregar"], button[onclick*="eliminar"]');
        botonesAccion.forEach(btn => {
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            btn.title = 'Funci√≥n deshabilitada - Suscripci√≥n vencida';
        });
    }, 1000);
}

// Abrir Mercado Pago
function abrirMercadoPago() {
    console.log('üí≥ Abriendo Mercado Pago...');
    window.open('https://link.mercadopago.cl/australprints3d', '_blank');
}

// Confirmar pago por WhatsApp
function confirmarPagoWhatsApp() {
    const barberiaNombre = window.CURRENT_BARBERIA_DATA?.nombre || 'Barber√≠a';
    const mensaje = `Hola, soy ${barberiaNombre}. Ya realic√© el pago de $15.000 por Mercado Pago`;
    const numeroWhatsApp = '56922050705';
    const urlWhatsApp = `https://wa.me/${numeroWhatsApp}?text=${encodeURIComponent(mensaje)}`;
    
    console.log('üì± Abriendo WhatsApp para confirmar pago...');
    window.open(urlWhatsApp, '_blank');
}

// Funci√≥n auxiliar para calcular d√≠as restantes
function calcularDiasRestantes(fechaHasta) {
    if (!fechaHasta) return 0;
    const hoy = new Date(getFechaChile());
    const hasta = new Date(fechaHasta);
    const diferencia = hasta.getTime() - hoy.getTime();
    const dias = Math.ceil(diferencia / (1000 * 3600 * 24));
    return Math.max(0, dias);
}
        
        // ===============================
        // GENERACI√ìN DE TABS
        // ===============================
      function generateTabs() {
    const tabContainer = document.getElementById('tabContainer');
    const tabs = [];
    
    // Verificar si la barber√≠a est√° activa
    const barberiaActiva = window.CURRENT_BARBERIA_DATA?.activa !== false;
    
    // Tabs comunes para todos
    tabs.push(
        { id: 'registrar', label: 'Registrar', icon: 'fa-plus-circle', permitidoInactivo: false },
        { id: 'resumen', label: 'Resumen', icon: 'fa-chart-bar', permitidoInactivo: true },
        { id: 'servicios', label: 'Servicios', icon: 'fa-list', permitidoInactivo: false },
        { id: 'agenda', label: 'Agenda', icon: 'fa-calendar-alt', permitidoInactivo: false }
    );
    
    // Tabs exclusivos del admin
    if (userRole === 'admin') {
        tabs.push(
            { id: 'barberos', label: 'Gesti√≥n Barberos', icon: 'fa-users', permitidoInactivo: false },
            { id: 'cierre', label: 'Cierre de Caja', icon: 'fa-cash-register', permitidoInactivo: false },
            { id: 'estadisticas', label: 'Estad√≠sticas', icon: 'fa-chart-line', permitidoInactivo: false },
            { id: 'configuracion', label: 'Configuraci√≥n', icon: 'fa-cog', permitidoInactivo: true }
        );
    }
    
    // Generar HTML de tabs
    tabContainer.innerHTML = tabs.map(tab => {
        // Determinar si el tab debe estar bloqueado
        const bloqueado = !barberiaActiva && !tab.permitidoInactivo;
        const esAdmin = userRole === 'admin';
        
        // Admin puede ver Resumen y Configuraci√≥n incluso con barber√≠a inactiva
        const permitido = barberiaActiva || (esAdmin && tab.permitidoInactivo);
        
        return `
            <button 
                onclick="${permitido ? `loadTab('${tab.id}')` : 'mostrarMensajeBloqueo()'}"
                id="tab-${tab.id}"
                class="px-4 py-2 rounded-t-lg font-medium ${bloqueado ? 'opacity-50 cursor-not-allowed text-gray-400' : 'text-gray-600 hover:text-blue-600 hover:bg-gray-50'} transition-colors tab-button"
                ${bloqueado ? 'disabled title="üîí Requiere suscripci√≥n activa"' : ''}
            >
                <i class="fas ${tab.icon} mr-2"></i>${tab.label}
                ${bloqueado ? '<i class="fas fa-lock ml-1 text-xs"></i>' : ''}
            </button>
        `;
    }).join('');
}

function mostrarMensajeBloqueo() {
    alert('üîí Funcionalidad bloqueada\n\nTu suscripci√≥n ha vencido.\n\nPara acceder a todas las funciones:\n1. Ve a la pesta√±a "Configuraci√≥n"\n2. Paga la mensualidad de $15.000\n3. Confirma tu pago por WhatsApp');
}
        // ===============================
        // NAVEGACI√ìN ENTRE TABS
        // ===============================
        function loadTab(tabId) {
            // Actualizar estado visual de tabs
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('text-gray-600');
            });
            
            const activeTab = document.getElementById(`tab-${tabId}`);
            if (activeTab) {
                activeTab.classList.remove('text-gray-600');
                activeTab.classList.add('bg-blue-600', 'text-white');
            }
            
            // Cargar contenido seg√∫n el tab
            switch(tabId) {
                case 'registrar':
                    loadRegistrarServicio();
                    break;
                case 'resumen':
                    loadResumen();
                    break;
                case 'servicios':
                    loadServicios();
                    break;
                case 'barberos':
                    loadGestionBarberos();
                    break;
                case 'cierre':
                    loadCierreCaja();
                    break;
                case 'estadisticas':
                    loadEstadisticas();
                    break;
                case 'configuracion':
                    loadConfiguracion();
                    break;
                case 'agenda':
                    loadAgenda();
                    break;
                default:
                    document.getElementById('contentArea').innerHTML = '<p>Secci√≥n en desarrollo...</p>';
            }
        }
        
        // ===============================
        // PESTA√ëA: REGISTRAR 
        // ===============================
       function loadRegistrarServicio() {
    document.getElementById('contentArea').innerHTML = `
        <div class="max-w-2xl mx-auto">
            <h2 class="text-2xl font-bold mb-6">
                <i class="fas fa-plus-circle mr-2"></i>Registro Nuevo
            </h2>
            
            <form id="registroForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                           Servicio Principal (opcional)
                    </label>
             <select id="servicioPrincipal" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecciona un servicio...</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Servicio Adicional (opcional)
                    </label>
                    <select id="servicioAdicional" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Ninguno</option>
                    </select>
                </div>
                
                <!-- NUEVO: Selector de Producto -->
              <!-- NUEVO: CARRITO DE PRODUCTOS -->
<div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
    <label class="block text-sm font-medium text-gray-700 mb-3">
        <i class="fas fa-shopping-cart mr-2"></i>Productos a Vender (opcional)
    </label>
    
    <!-- Selector de producto -->
    <div class="grid grid-cols-12 gap-2 mb-3">
        <div class="col-span-7">
            <select id="productoVendido" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500">
                <option value="">Seleccionar producto...</option>
            </select>
        </div>
        <div class="col-span-3">
            <input type="number" id="cantidadProducto" min="1" value="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500" placeholder="Cant.">
        </div>
        <div class="col-span-2">
            <button type="button" onclick="agregarProductoAlCarrito()" class="w-full bg-purple-600 text-white px-3 py-2 rounded-lg hover:bg-purple-700 transition-colors text-sm font-medium">
                <i class="fas fa-plus"></i>
            </button>
        </div>
    </div>
    
    <!-- Info del producto seleccionado -->
    <div id="infoProductoSeleccionado" class="mb-3 text-xs text-gray-600 hidden">
        <div class="flex justify-between">
            <span>Precio unitario:</span>
            <span id="precioUnitarioMostrar" class="font-semibold"></span>
        </div>
        <div class="flex justify-between">
            <span>Stock disponible:</span>
            <span id="stockDisponibleMostrar" class="font-semibold"></span>
        </div>
    </div>
    
    <!-- Carrito de productos -->
    <div id="carritoProductos" class="hidden">
        <div class="bg-white rounded-lg p-3 mb-2">
            <div class="flex justify-between items-center mb-2">
                <span class="text-sm font-semibold text-gray-700">üõí Carrito:</span>
                <button type="button" onclick="limpiarCarrito()" class="text-xs text-red-600 hover:text-red-800">
                    <i class="fas fa-trash mr-1"></i>Limpiar todo
                </button>
            </div>
            <div id="listaCarrito" class="space-y-2">
                <!-- Items del carrito se insertan aqu√≠ -->
            </div>
        </div>
        <div class="bg-purple-100 rounded-lg p-3 flex justify-between items-center">
            <span class="font-semibold text-purple-900">Subtotal Productos:</span>
            <span id="subtotalCarrito" class="text-lg font-bold text-purple-900">$0</span>
        </div>
    </div>
    
    <p class="text-xs text-purple-600 mt-3">
        üí° Los productos NO generan comisi√≥n para empleados
    </p>
</div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                           Monto Total Cobrado * (servicio + productos)
                   </label>
                  <input type="number" id="monto" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="$">
                    <p class="text-xs text-gray-500 mt-1">Incluye servicio + producto (si aplica)</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Forma de Pago *
                    </label>
                   <select id="formaPago" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecciona...</option>
                        <option value="Efectivo">Efectivo</option>
                        <option value="Cuenta RUT">Cuenta RUT</option>
                        <option value="Transbank">Transbank</option>
                        <option value="Mercado Pago">Mercado Pago</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Notas (opcional)
                    </label>
                    <textarea id="notas" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Observaciones adicionales..."></textarea>
                </div>
                
                <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition duration-200">
                    <i class="fas fa-save mr-2"></i>Registrar Servicio
                </button>
            </form>
        </div>
    `;
    
    // Cargar servicios y productos
    loadServiciosDropdown();
    cargarProductosParaVenta();
    
    // Agregar evento al formulario
    document.getElementById('registroForm').addEventListener('submit', registrarServicio);
}
        
       async function loadServiciosDropdown() {
    try {
        console.log('üîç Cargando servicios desde BD para barber√≠a:', window.CURRENT_BARBERIA_ID);
        
        // Cargar servicios desde Supabase
        const { data: servicios, error } = await supabase
            .from('services')
            .select('*')
            .eq('barberia_id', window.CURRENT_BARBERIA_ID)
            .eq('activo', true)
            .order('orden', { ascending: true });
        
        if (error) {
            console.error('‚ùå Error cargando servicios:', error);
            throw error;
        }
        
        if (!servicios || servicios.length === 0) {
            console.warn('‚ö†Ô∏è No hay servicios activos para esta barber√≠a');
            alert('‚ö†Ô∏è No hay servicios configurados. Contacta al administrador.');
            return;
        }
        
        console.log(`‚úÖ ${servicios.length} servicios cargados correctamente`);
        
        // Guardar servicios en variable global para uso posterior
        window.serviciosActivos = servicios;
        
        // Generar opciones del dropdown
        const options = servicios.map(s => 
            `<option value="${s.id}" data-precio="${s.precio_sugerido || 0}" data-nombre="${s.nombre}">${s.nombre}</option>`
        ).join('');
        
        // Llenar dropdowns
        const principalSelect = document.getElementById('servicioPrincipal');
        const adicionalSelect = document.getElementById('servicioAdicional');
        
        if (principalSelect) {
            principalSelect.innerHTML = '<option value="">Selecciona un servicio...</option>' + options;
        }
        
        if (adicionalSelect) {
            adicionalSelect.innerHTML = '<option value="">Ninguno</option>' + options;
        }
        
    } catch (error) {
        console.error('‚ùå Error cr√≠tico cargando servicios:', error);
        alert('‚ùå Error del sistema al cargar servicios. Intenta recargar la p√°gina.');
    }
}
        // ===============================
// CARGAR PRODUCTOS PARA VENTA
// ===============================

async function cargarProductosParaVenta() {
    try {
        console.log('üß¥ Cargando productos para venta...');
        
        const { data: productos, error } = await supabase
            .from('productos')
            .select('*')
            .eq('barberia_id', window.CURRENT_BARBERIA_ID)
            .eq('activo', true)
            .gt('stock_actual', 0)
            .order('nombre', { ascending: true });
        
        if (error) throw error;
        
        const select = document.getElementById('productoVendido');
        if (!select) return;
        
        if (!productos || productos.length === 0) {
            select.innerHTML = '<option value="">No hay productos disponibles</option>';
            return;
        }
        
        // Guardar productos en variable global
        window.productosDisponibles = productos;
        
        // Generar opciones
        const options = productos.map(p => 
            `<option value="${p.id}" data-precio="${p.precio_venta}" data-stock="${p.stock_actual}" data-nombre="${p.nombre}">${p.nombre} - $${p.precio_venta.toLocaleString('es-CL')} (Stock: ${p.stock_actual})</option>`
        ).join('');
        
        select.innerHTML = '<option value="">Seleccionar producto...</option>' + options;
        
        // Agregar evento para mostrar info al seleccionar
        select.addEventListener('change', mostrarInfoProductoSeleccionado);
        
        console.log(`‚úÖ ${productos.length} productos cargados para venta`);
        
    } catch (error) {
        console.error('‚ùå Error cargando productos:', error);
    }
}
// ===============================
// FUNCIONES DEL CARRITO DE PRODUCTOS
// ===============================

function mostrarInfoProductoSeleccionado() {
    const select = document.getElementById('productoVendido');
    const infoDiv = document.getElementById('infoProductoSeleccionado');
    const precioSpan = document.getElementById('precioUnitarioMostrar');
    const stockSpan = document.getElementById('stockDisponibleMostrar');
    
    if (!select.value) {
        infoDiv.classList.add('hidden');
        return;
    }
    
    const option = select.options[select.selectedIndex];
    const precio = option.dataset.precio;
    const stock = option.dataset.stock;
    
    precioSpan.textContent = `$${parseFloat(precio).toLocaleString('es-CL')}`;
    stockSpan.textContent = `${stock} unidades`;
    infoDiv.classList.remove('hidden');
}

function agregarProductoAlCarrito() {
    const select = document.getElementById('productoVendido');
    const cantidadInput = document.getElementById('cantidadProducto');
    
    if (!select.value) {
        alert('‚ö†Ô∏è Por favor selecciona un producto');
        return;
    }
    
    const option = select.options[select.selectedIndex];
    const productoId = select.value;
    const productoNombre = option.dataset.nombre;
    const precioUnitario = parseFloat(option.dataset.precio);
    const stockDisponible = parseInt(option.dataset.stock);
    const cantidad = parseInt(cantidadInput.value);
    
    // Validar cantidad
    if (cantidad <= 0) {
        alert('‚ö†Ô∏è La cantidad debe ser mayor a 0');
        return;
    }
    
    // Validar stock disponible
    const cantidadEnCarrito = carritoProductos
        .filter(p => p.id === productoId)
        .reduce((sum, p) => sum + p.cantidad, 0);
    
    if (cantidadEnCarrito + cantidad > stockDisponible) {
        alert(`‚ö†Ô∏è Stock insuficiente\n\nDisponible: ${stockDisponible}\nYa en carrito: ${cantidadEnCarrito}\nIntentando agregar: ${cantidad}`);
        return;
    }
    
    // Agregar al carrito
    carritoProductos.push({
        id: productoId,
        nombre: productoNombre,
        precio: precioUnitario,
        cantidad: cantidad
    });
    
    console.log('üõí Producto agregado al carrito:', productoNombre, 'x', cantidad);
    
    // Actualizar UI
    actualizarVistaCarrito();
    
    // Limpiar selector
    select.value = '';
    cantidadInput.value = 1;
    document.getElementById('infoProductoSeleccionado').classList.add('hidden');
}

function actualizarVistaCarrito() {
    const carritoDiv = document.getElementById('carritoProductos');
    const listaDiv = document.getElementById('listaCarrito');
    const subtotalSpan = document.getElementById('subtotalCarrito');
    
    if (carritoProductos.length === 0) {
        carritoDiv.classList.add('hidden');
        return;
    }
    
    // Mostrar carrito
    carritoDiv.classList.remove('hidden');
    
    // Agrupar productos iguales
    const productosAgrupados = {};
    carritoProductos.forEach((item, index) => {
        if (!productosAgrupados[item.id]) {
            productosAgrupados[item.id] = {
                nombre: item.nombre,
                precio: item.precio,
                cantidad: 0,
                indices: []
            };
        }
        productosAgrupados[item.id].cantidad += item.cantidad;
        productosAgrupados[item.id].indices.push(index);
    });
    
    // Generar HTML de items
    let html = '';
    let subtotal = 0;
    
    Object.entries(productosAgrupados).forEach(([id, item]) => {
        const total = item.precio * item.cantidad;
        subtotal += total;
        
        html += `
            <div class="flex justify-between items-center text-sm bg-gray-50 p-2 rounded">
                <div class="flex-1">
                    <span class="font-medium text-gray-800">${item.nombre}</span>
                    <span class="text-gray-600"> (x${item.cantidad})</span>
                </div>
                <div class="flex items-center gap-3">
                    <span class="font-semibold text-purple-700">$${total.toLocaleString('es-CL')}</span>
                    <button type="button" onclick="eliminarProductoDelCarrito('${id}')" 
                        class="text-red-600 hover:text-red-800 transition-colors">
                        <i class="fas fa-times-circle"></i>
                    </button>
                </div>
            </div>
        `;
    });
    
    listaDiv.innerHTML = html;
    subtotalSpan.textContent = `$${subtotal.toLocaleString('es-CL')}`;
}

function eliminarProductoDelCarrito(productoId) {
    carritoProductos = carritoProductos.filter(item => item.id !== productoId);
    console.log('üóëÔ∏è Producto eliminado del carrito:', productoId);
    actualizarVistaCarrito();
}

function limpiarCarrito() {
    if (carritoProductos.length === 0) return;
    
    if (confirm('¬øLimpiar todo el carrito?')) {
        carritoProductos = [];
        console.log('üßπ Carrito limpiado');
        actualizarVistaCarrito();
    }
}        
     async function registrarServicio(e) {
    e.preventDefault();
    
    showLoading();
    
    const servicioPrincipal = document.getElementById('servicioPrincipal');
    const servicioAdicional = document.getElementById('servicioAdicional');
    const monto = document.getElementById('monto').value;
    const formaPago = document.getElementById('formaPago').value;
    const notas = document.getElementById('notas').value;
    
    // NUEVA VALIDACI√ìN: Al menos debe haber un servicio O productos
    const hayServicio = servicioPrincipal.value;
    const hayProductos = carritoProductos.length > 0;
    
    if (!hayServicio && !hayProductos) {
        alert('‚ö†Ô∏è Debes agregar al menos:\n‚Ä¢ Un servicio, O\n‚Ä¢ Uno o m√°s productos');
        hideLoading();
        return;
    }
    
   // Validar campos obligatorios
if (!monto) {
    alert('‚ö†Ô∏è Por favor ingresa el monto total cobrado');
    hideLoading();
    return;
}

if (!formaPago) {
    alert('‚ö†Ô∏è Por favor selecciona la forma de pago');
    hideLoading();
    return;
}

// Validar que el monto sea mayor a 0
if (parseFloat(monto) <= 0) {
    alert('‚ö†Ô∏è El monto debe ser mayor a $0');
    hideLoading();
    return;
}
    
    // Validar barberia_id
    if (!window.CURRENT_BARBERIA_ID) {
        console.error('‚ùå CURRENT_BARBERIA_ID no est√° definido');
        alert('Error del sistema: No se puede identificar la barber√≠a. Por favor, cierra sesi√≥n e inicia sesi√≥n nuevamente.');
        hideLoading();
        return;
    }
    
    try {
        // Obtener c√≥digo √∫nico
        console.log('üî¢ Obteniendo siguiente c√≥digo...');
        const { data: nuevoCodigo, error: rpcError } = await supabase.rpc('get_next_codigo_diario', { 
            p_barberia_id: window.CURRENT_BARBERIA_ID 
        });
        
        if (rpcError) {
            console.error('‚ùå Error en RPC del c√≥digo:', rpcError);
            alert('Error al generar c√≥digo de servicio. Intenta nuevamente.');
            hideLoading();
            return;
        }
        
        console.log(`‚úÖ C√≥digo asignado: #${nuevoCodigo}`);
        
        // Obtener datos del servicio (si hay)
        let servicioPrincipalData = null;
        let servicioAdicionalData = null;
        
        if (hayServicio) {
            const serviciosActivos = window.serviciosActivos || [];
            servicioPrincipalData = serviciosActivos.find(s => s.id === servicioPrincipal.value);
            servicioAdicionalData = servicioAdicional.value ? serviciosActivos.find(s => s.id === servicioAdicional.value) : null;
            
            if (!servicioPrincipalData) {
                console.error('‚ùå Servicio principal no encontrado');
                alert('‚ùå Error: Servicio no v√°lido. Recarga la p√°gina.');
                hideLoading();
                return;
            }
        }
        
        // Validar stock de productos en carrito
        if (hayProductos) {
            console.log('üì¶ Validando stock de productos...');
            
            for (const item of carritoProductos) {
                const producto = window.productosDisponibles?.find(p => p.id === item.id);
                
                if (!producto) {
                    alert(`‚ùå Error: Producto "${item.nombre}" no encontrado`);
                    hideLoading();
                    return;
                }
                
                // Contar cu√°ntas veces est√° el producto en el carrito
                const cantidadTotal = carritoProductos
                    .filter(p => p.id === item.id)
                    .reduce((sum, p) => sum + p.cantidad, 0);
                
                if (producto.stock_actual < cantidadTotal) {
                    alert(`‚ùå Stock insuficiente\n\nProducto: ${item.nombre}\nStock disponible: ${producto.stock_actual}\nIntentando vender: ${cantidadTotal}`);
                    hideLoading();
                    return;
                }
            }
            
            console.log('‚úÖ Stock validado correctamente');
        }
        
        // Crear objeto del registro
        const nuevoRegistro = {
            barberia_id: window.CURRENT_BARBERIA_ID,
            realizado_por_id: currentUser.id,
            realizado_por_nombre: currentUser.nombre,
            servicio_principal_id: servicioPrincipalData ? servicioPrincipalData.id : null,
            servicio_principal_nombre: servicioPrincipalData ? servicioPrincipalData.nombre : null,
            servicio_precio_sugerido: servicioPrincipalData ? servicioPrincipalData.precio_sugerido : null,
            servicio_adicional_id: servicioAdicionalData ? servicioAdicionalData.id : null,
            servicio_adicional_nombre: servicioAdicionalData ? servicioAdicionalData.nombre : null,
            productos_vendidos: hayProductos ? JSON.stringify(carritoProductos) : '[]',
            monto_total: parseFloat(monto),
            forma_pago: formaPago,
            notas: notas || null,
            fecha: getFechaChile(),
            codigo_diario: nuevoCodigo,
            created_at: getTimestampChile()
        };
        
        console.log('üíæ Guardando registro:', nuevoRegistro);
        
        // Guardar registro
        const { data, error } = await supabase
            .from('citas')
            .insert([nuevoRegistro])
            .select();
        
        if (error) {
            console.error('‚ùå Error de Supabase:', error);
            alert('Error al guardar: ' + error.message);
            hideLoading();
            return;
        }
        
        console.log('‚úÖ Registro guardado:', data);
        
        // Actualizar stock de productos
        if (hayProductos) {
            console.log('üì¶ Actualizando stock de productos...');
            
            // Agrupar productos para actualizar stock
            const stockUpdates = {};
            carritoProductos.forEach(item => {
                if (!stockUpdates[item.id]) {
                    stockUpdates[item.id] = 0;
                }
                stockUpdates[item.id] += item.cantidad;
            });
            
            // Actualizar stock de cada producto
            for (const [productoId, cantidadVendida] of Object.entries(stockUpdates)) {
                const producto = window.productosDisponibles.find(p => p.id === productoId);
                const nuevoStock = producto.stock_actual - cantidadVendida;
                
                const { error: errorStock } = await supabase
                    .from('productos')
                    .update({ stock_actual: nuevoStock })
                    .eq('id', productoId)
                    .eq('barberia_id', window.CURRENT_BARBERIA_ID);
                
                if (errorStock) {
                    console.error('‚ö†Ô∏è Error actualizando stock:', errorStock);
                    alert(`‚ö†Ô∏è Registro guardado pero no se pudo actualizar el stock de ${producto.nombre}`);
                } else {
                    console.log(`‚úÖ Stock actualizado: ${producto.nombre} (${producto.stock_actual} ‚Üí ${nuevoStock})`);
                }
            }
        }
        
        // Mensaje de √©xito
        let mensaje = `‚úÖ Registro #${nuevoCodigo} guardado exitosamente!`;
        
        if (hayServicio) {
            mensaje += `\n\n‚úÇÔ∏è Servicio: ${servicioPrincipalData.nombre}`;
        }
        
        if (hayProductos) {
            const totalProductos = carritoProductos.reduce((sum, p) => sum + p.cantidad, 0);
            mensaje += `\n\nüß¥ Productos vendidos: ${totalProductos}`;
            carritoProductos.forEach(item => {
                mensaje += `\n  ‚Ä¢ ${item.nombre} (x${item.cantidad})`;
            });
        }
        
        alert(mensaje);
        
        // Limpiar formulario
        document.getElementById('registroForm').reset();
        carritoProductos = [];
        actualizarVistaCarrito();
        
        // Recargar productos por si cambi√≥ el stock
        cargarProductosParaVenta();
        
    } catch (error) {
        console.error('‚ùå Error:', error);
        alert('Error al registrar: ' + error.message);
    }
    
    hideLoading();
}   
        // ===============================
        // PESTA√ëA: RESUMEN
        // ===============================
    function loadResumen() {
    document.getElementById('contentArea').innerHTML = `
        <div class="max-w-4xl mx-auto">
            <h2 class="text-2xl font-bold mb-6">
                <i class="fas fa-chart-bar mr-2"></i>Resumen
            </h2>
            
            <!-- Selector de Vista -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Seleccionar Vista:</label>
                <select id="vistaResumen" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="cambiarVistaResumen()">
                    <option value="diaria">Vista Diaria</option>
                    <option value="semanal">Vista Semanal</option>
                    <option value="mensual">Vista Mensual</option>
                </select>
            </div>

            <!-- Filtro de Barbero (solo para admin) -->
            <div id="filtroBarberoResumen" class="mb-4" style="display:none;">
                <label class="block text-sm font-medium text-gray-700 mb-2">Filtrar por Barbero:</label>
                <select id="selectBarberoResumen" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="cargarDatosResumen()">
                    <option value="todos">Ver Todos</option>
                    <option value="mi">Mi Resumen</option>
                </select>
            </div>

            <!-- Contenedor de Fechas -->
            <div id="contenedorFechas" class="mb-4">
                <label id="labelFechaResumen" class="block text-sm font-medium text-gray-700 mb-2">Fecha:</label>
                <input type="date" id="fechaResumen" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="cargarDatosResumen()">
            </div>

            <!-- Contenedor del Resumen -->
            <div id="contenidoResumen" class="mt-6">
                <div class="text-center py-8">
                    <div class="loading-spinner mx-auto"></div>
                    <p class="mt-4 text-gray-600">Cargando resumen...</p>
                </div>
            </div>
        </div>
    `;
    
    // Configurar fecha inicial y cargar datos
    setTimeout(function() {
        const fechaInput = document.getElementById('fechaResumen');
        if (fechaInput) {
            fechaInput.value = getFechaChile();
        }
        
        // Si es admin, mostrar filtro de barberos
        if (userRole === 'admin') {
            document.getElementById('filtroBarberoResumen').style.display = 'block';
            cargarBarberosEnFiltro();
        }
        
        // Cargar datos del resumen
        cargarDatosResumen();
    }, 100);
}
        
      async function cargarDatosResumen() {
    const contenido = document.getElementById('contenidoResumen');
    if (!contenido) return;
    
    contenido.innerHTML = '<div class="text-center py-8"><div class="loading-spinner mx-auto"></div><p class="mt-4 text-gray-600">Calculando resumen...</p></div>';
    
    try {
        const vista = document.getElementById('vistaResumen').value;
        const filtro = document.getElementById('selectBarberoResumen')?.value || 'mi';
        
        let fechaInicio, fechaFin, fecha;
        
        // Obtener fechas seg√∫n la vista actual
        if (vista === 'mensual') {
            fechaInicio = document.getElementById('fechaDesde')?.value;
            fechaFin = document.getElementById('fechaHasta')?.value;
            
            if (!fechaInicio || !fechaFin) {
                contenido.innerHTML = '<p class="text-gray-500">Por favor selecciona ambas fechas del rango</p>';
                return;
            }
        } else {
            // Para diaria y semanal
            fecha = document.getElementById('fechaResumen')?.value;
            
            if (!fecha) {
                contenido.innerHTML = '<p class="text-gray-500">Por favor selecciona una fecha</p>';
                return;
            }
            
            // Calcular rango seg√∫n la vista
            if (vista === 'diaria') {
                fechaInicio = fecha;
                fechaFin = fecha;
            } else if (vista === 'semanal') {
                const date = new Date(fecha + 'T00:00:00');
                const dayOfWeek = date.getDay();
                const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                
                const lunes = new Date(date);
                lunes.setDate(date.getDate() - diff);
                
                const domingo = new Date(lunes);
                domingo.setDate(lunes.getDate() + 6);
                
                fechaInicio = lunes.toISOString().split('T')[0];
                fechaFin = domingo.toISOString().split('T')[0];
            }
        }
        
        console.log(`üîç Cargando datos: ${vista} | ${fechaInicio} al ${fechaFin}`);
        
        // Construir query base
        let query = supabase
            .from('citas')
            .select('*')
            .eq('barberia_id', window.CURRENT_BARBERIA_ID)
            .gte('fecha', fechaInicio)
            .lte('fecha', fechaFin);
        
        // Aplicar filtro seg√∫n rol y selecci√≥n
        if (userRole === 'empleado') {
            query = query.eq('realizado_por_id', currentUser.id);
        } else if (userRole === 'admin' && filtro !== 'todos') {
            if (filtro === 'mi') {
                query = query.eq('realizado_por_id', currentUser.id);
            } else {
                query = query.eq('realizado_por_id', filtro);
            }
        }
        
        const { data: servicios, error } = await query;
        
        if (error) throw error;
        
  // Calcular totales SOLO DE SERVICIOS (sin productos)
        let totalRecaudadoSinComision = 0; // 100% real
        let totalRecaudado = 0; // Con comisi√≥n aplicada
        const totalServicios = servicios ? servicios.length : 0;
        
        if (servicios) {
            servicios.forEach(s => {
                let montoServicio = parseFloat(s.monto_total || 0);
                
                // Restar productos si los hay
                if (s.productos_vendidos) {
                    try {
                        const productos = typeof s.productos_vendidos === 'string' 
                            ? JSON.parse(s.productos_vendidos) 
                            : s.productos_vendidos;
                        
                        if (Array.isArray(productos)) {
                            productos.forEach(p => {
                                montoServicio -= parseFloat(p.precio || 0) * (p.cantidad || 1);
                            });
                        }
                    } catch (e) {
                        console.error('Error parseando productos:', e);
                    }
                }
                
                // Acumular monto real (sin comisi√≥n)
                totalRecaudadoSinComision += montoServicio;
                
                // Aplicar l√≥gica de comisi√≥n seg√∫n rol y filtro
                if (userRole === 'empleado') {
                    // EMPLEADO: Siempre ve 50% de sus servicios
                    totalRecaudado += montoServicio * 0.5;
                } else if (userRole === 'admin') {
                    if (filtro === 'todos') {
                        // ADMIN "Ver Todos": 100% real (sin comisi√≥n)
                        totalRecaudado += montoServicio;
                    } else if (filtro === 'mi') {
                        // ADMIN "Mi Resumen": 100% de sus servicios
                        totalRecaudado += montoServicio;
                    } else {
                        // ADMIN filtrando un empleado: 50% (lo que le debe pagar)
                        totalRecaudado += montoServicio * 0.5;
                    }
                }
            });
        }
        
        // Agrupar por forma de pago
        const porFormaPago = servicios ? servicios.reduce((acc, s) => {
            acc[s.forma_pago] = (acc[s.forma_pago] || 0) + parseFloat(s.monto_total || 0);
            return acc;
        }, {}) : {};
        
        // Obtener adelantos si es vista semanal o mensual
        let totalAdelantos = 0;
        if (vista !== 'diaria') {
            console.log('üîç Cargando adelantos para per√≠odo...');
            
            // Construir query de adelantos con filtro por barbero
            let queryAdelantos = supabase
                .from('adelantos')
                .select('barbero_id, monto')
                .eq('barberia_id', window.CURRENT_BARBERIA_ID)
                .gte('created_at', fechaInicio + 'T00:00:00')
                .lte('created_at', fechaFin + 'T23:59:59');
            
            console.log('üìä Mostrando todos los adelantos hist√≥ricos del per√≠odo');
            
            // Aplicar filtro seg√∫n rol y selecci√≥n (IGUAL que servicios)
            if (userRole === 'empleado') {
                queryAdelantos = queryAdelantos.eq('barbero_id', currentUser.id);
            } else if (userRole === 'admin' && filtro !== 'todos') {
                if (filtro === 'mi') {
                    queryAdelantos = queryAdelantos.eq('barbero_id', currentUser.id);
                } else {
                    queryAdelantos = queryAdelantos.eq('barbero_id', filtro);
                }
            }
            
            const { data: adelantos, error: errorAdelantos } = await queryAdelantos;
            
            if (errorAdelantos) {
                console.error('‚ùå Error cargando adelantos:', errorAdelantos);
            } else if (adelantos) {
                totalAdelantos = adelantos.reduce((sum, a) => sum + parseFloat(a.monto || 0), 0);
                console.log('üí∞ Adelantos filtrados:', adelantos.length, 'Total:', totalAdelantos);
            }
        }
        
        // Mostrar resumen
        let html = `
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-bold mb-4">
                    üìÖ Resumen ${vista === 'diaria' ? 'del D√≠a' : vista === 'semanal' ? 'Semanal' : 'del Rango'}
                </h3>
                <p class="text-gray-600 mb-6">${fechaInicio === fechaFin ? fechaInicio : fechaInicio + ' al ' + fechaFin}</p>
                
               <div class="grid grid-cols-1 md:grid-cols-${(userRole === 'admin' && filtro === 'todos') ? '3' : '2'} gap-4 mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="text-sm text-blue-600 mb-1">üí∞ Total Servicios</div>
                        <div class="text-2xl font-bold text-blue-900">$${totalRecaudado.toLocaleString('es-CL')}</div>
                    </div>
                    
                    <div class="bg-green-50 p-4 rounded-lg">
                        <div class="text-sm text-green-600 mb-1">üìä Servicios Realizados</div>
                        <div class="text-2xl font-bold text-green-900">${totalServicios}</div>
                    </div>
        `;
        
        // Agregar TOTAL GENERAL solo si es admin con "Ver Todos"
        if (userRole === 'admin' && filtro === 'todos') {
            // Calcular total de productos
            let totalProductos = 0;
            servicios.forEach(s => {
                if (s.productos_vendidos) {
                    try {
                        const productos = typeof s.productos_vendidos === 'string' 
                            ? JSON.parse(s.productos_vendidos) 
                            : s.productos_vendidos;
                        
                        if (Array.isArray(productos)) {
                            productos.forEach(p => {
                                totalProductos += parseFloat(p.precio || 0) * (p.cantidad || 1);
                            });
                        }
                    } catch (e) {
                        console.error('Error parseando productos:', e);
                    }
                }
            });
            
            const totalGeneral = totalRecaudadoSinComision + totalProductos;
            
            html += `
                    <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-4 rounded-lg border-2 border-purple-200">
                        <div class="text-sm text-purple-600 mb-1 font-semibold">üí∞ TOTAL GENERAL</div>
                        <div class="text-2xl font-bold text-purple-900">$${totalGeneral.toLocaleString('es-CL')}</div>
                        <div class="text-xs text-purple-600 mt-1">Servicios + Productos</div>
                    </div>
            `;
        }
        
        html += `
        `;
        
        if (vista !== 'diaria' && totalAdelantos > 0) {
            html += `
                    <div class="bg-yellow-50 p-4 rounded-lg">
                        <div class="text-sm text-yellow-600 mb-1">üí∏ Adelantos</div>
                        <div class="text-2xl font-bold text-yellow-900">$${totalAdelantos.toLocaleString('es-CL')}</div>
                    </div>
                    
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <div class="text-sm text-purple-600 mb-1">üí∞ Total Neto</div>
                        <div class="text-2xl font-bold text-purple-900">$${(totalRecaudado - totalAdelantos).toLocaleString('es-CL')}</div>
                    </div>
            `;
        }
        
        html += `
                </div>
        `;
        
     // Agregar productos vendidos SOLO SI ES ADMIN
        if (userRole === 'admin') {
            const productosVendidos = [];
            servicios.forEach(s => {
                if (s.productos_vendidos) {
                    try {
                        const productos = typeof s.productos_vendidos === 'string' 
                            ? JSON.parse(s.productos_vendidos) 
                            : s.productos_vendidos;
                        
                        if (Array.isArray(productos) && productos.length > 0) {
                            productosVendidos.push(...productos);
                        }
                    } catch (e) {
                        console.error('Error parseando productos:', e);
                    }
                }
            });
            
            if (productosVendidos.length > 0) {
                // Agrupar productos
                const productosAgrupados = {};
                let totalProductos = 0;
                
                productosVendidos.forEach(p => {
                    if (!productosAgrupados[p.nombre]) {
                        productosAgrupados[p.nombre] = { cantidad: 0, monto: 0 };
                    }
                    productosAgrupados[p.nombre].cantidad += (p.cantidad || 1);
                    productosAgrupados[p.nombre].monto += parseFloat(p.precio || 0) * (p.cantidad || 1);
                    totalProductos += parseFloat(p.precio || 0) * (p.cantidad || 1);
                });
                
                html += `
                    <div class="border-t pt-4 mt-4">
                        <h4 class="font-semibold mb-3 text-purple-700"><i class="fas fa-box mr-2"></i>Productos Vendidos</h4>
                        <div class="bg-purple-50 rounded-lg p-4">
                            <div class="space-y-2 mb-3">
                `;
                
                Object.entries(productosAgrupados).forEach(([nombre, data]) => {
                    html += `
                        <div class="flex justify-between text-sm">
                            <span class="text-purple-800">${nombre} (x${data.cantidad}):</span>
                            <span class="font-semibold text-purple-900">$${data.monto.toLocaleString('es-CL')}</span>
                        </div>
                    `;
                });
                
                html += `
                            </div>
                            <div class="flex justify-between pt-2 border-t border-purple-200 font-bold">
                                <span class="text-purple-900">Total Productos:</span>
                                <span class="text-purple-900">$${totalProductos.toLocaleString('es-CL')}</span>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">üí° Productos NO generan comisi√≥n para empleados</p>
                    </div>
                `;
            }
        }
        
        html += `
                <div class="border-t pt-4">
                    <h4 class="font-semibold mb-3">üí≥ Desglose por Forma de Pago</h4>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span>üíµ Efectivo:</span>
                            <span class="font-semibold">$${(porFormaPago['Efectivo'] || 0).toLocaleString('es-CL')}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>üí≥ Cuenta RUT:</span>
                            <span class="font-semibold">$${(porFormaPago['Cuenta RUT'] || 0).toLocaleString('es-CL')}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>üí≥ Transbank:</span>
                            <span class="font-semibold">$${(porFormaPago['Transbank'] || 0).toLocaleString('es-CL')}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>üì± Mercado Pago:</span>
                            <span class="font-semibold">$${(porFormaPago['Mercado Pago'] || 0).toLocaleString('es-CL')}</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        contenido.innerHTML = html;
        
    } catch (error) {
        console.error('‚ùå Error:', error);
        contenido.innerHTML = '<div class="bg-red-100 p-4 rounded-lg text-red-700">Error al cargar el resumen. Por favor intenta nuevamente.</div>';
    }
}
        
    function cambiarVistaResumen() {
    var vista = document.getElementById('vistaResumen').value;
    var fechaContainer = document.getElementById('contenedorFechas');
    
    if (!fechaContainer) {
        console.error('No se encontr√≥ el contenedor de fechas');
        return;
    }
    
    console.log('Cambiando vista a: ' + vista);
    
    if (vista === 'diaria') {
        fechaContainer.innerHTML = '<label id="labelFechaResumen" class="block text-sm font-medium text-gray-700 mb-2">Fecha:</label><input type="date" id="fechaResumen" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="cargarDatosResumen()">';
        
        setTimeout(function() {
            var fechaInput = document.getElementById('fechaResumen');
            if (fechaInput) {
                fechaInput.value = getFechaChile();
                cargarDatosResumen();
            }
        }, 100);
    } else if (vista === 'semanal') {
        fechaContainer.innerHTML = '<label id="labelFechaResumen" class="block text-sm font-medium text-gray-700 mb-2">Seleccionar cualquier d√≠a de la semana:</label><input type="date" id="fechaResumen" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="cargarDatosResumen()">';
        
        setTimeout(function() {
            var fechaInput = document.getElementById('fechaResumen');
            if (fechaInput) {
                fechaInput.value = getFechaChile();  // ‚úÖ CORRECTO
                cargarDatosResumen();
            }
        }, 100);
    } else if (vista === 'mensual') {
        var html = '<label class="block text-sm font-medium text-gray-700 mb-2">Rango de fechas:</label>';
        html += '<div class="grid grid-cols-2 gap-4">';
        html += '<div><label class="text-xs text-gray-600">Desde:</label>';
        html += '<input type="date" id="fechaDesde" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="cargarDatosResumen()"></div>';
        html += '<div><label class="text-xs text-gray-600">Hasta:</label>';
        html += '<input type="date" id="fechaHasta" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="cargarDatosResumen()"></div>';
        html += '</div>';
        
        fechaContainer.innerHTML = html;
        
        setTimeout(function() {
            var fechaDesde = document.getElementById('fechaDesde');
            var fechaHasta = document.getElementById('fechaHasta');
            if (fechaDesde && fechaHasta) {
                var now = new Date();
                var firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                var lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                fechaDesde.value = firstDay.toISOString().split('T')[0];
                fechaHasta.value = lastDay.toISOString().split('T')[0];
                cargarDatosResumen();
            }
        }, 100);
    }
}
        
  async function cargarBarberosEnFiltro() {
    try {
        console.log('üîç Cargando barberos din√°micamente para filtro...');
        
        const { data: barberos, error } = await supabase
            .from('usuarios')
            .select('id, nombre')
            .eq('barberia_id', window.CURRENT_BARBERIA_ID)
            .eq('activo', true);
        
        if (error) throw error;
        
        const select = document.getElementById('selectBarberoResumen');
        if (!select) return;
        
        // Limpiar opciones actuales (mantener las 2 primeras)
        while (select.children.length > 2) {
            select.removeChild(select.lastChild);
        }
        
        // Agregar todos los barberos din√°micamente
        barberos.forEach(barbero => {
            if (barbero.id !== currentUser.id) {  // No agregar al usuario actual
                const option = document.createElement('option');
                option.value = barbero.id;
                option.textContent = barbero.nombre;
                select.appendChild(option);
            }
        });
        
    } catch (error) {
        console.error('‚ùå Error cargando barberos:', error);
    }
}
        
        // ===============================
        // PESTA√ëA: SERVICIOS
        // ===============================
      async function loadServicios() {
    console.log('üîç Cargando servicios...');
    
    document.getElementById('contentArea').innerHTML = `
        <div class="max-w-6xl mx-auto">
            <h2 class="text-2xl font-bold mb-6">
                <i class="fas fa-list mr-2"></i>Servicios
            </h2>
            
          <!-- Filtros -->
<div class="grid grid-cols-1 md:grid-cols-${userRole === 'admin' ? '3' : '1'} gap-4 mb-4">
    <!-- Filtro de Fecha (para todos) -->
    <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Filtrar por Fecha:</label>
        <select id="vistaServicios" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="cambiarVistaServicios()">
            <option value="hoy">Hoy</option>
            <option value="semana">Esta Semana</option>
            <option value="mes">Este Mes</option>
            <option value="rango">Rango Personalizado</option>
        </select>
    </div>

    ${userRole === 'admin' ? `
    <!-- Filtro de Barbero (solo admin) -->
    <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Filtrar por Barbero:</label>
        <select id="selectBarberoServicios" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="cargarListaServicios()">
            <option value="todos">Ver Todos</option>
            <option value="mi">Mis Servicios</option>
        </select>
    </div>
    <!-- Buscar por C√≥digo -->
    <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Buscar por C√≥digo:</label>
        <input type="text" id="buscarCodigo" placeholder="Ej: 5, #5" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onkeyup="filtrarPorCodigo()">
    </div>
    ` : ''}
</div>

<!-- Contenedor de Fechas -->
<div id="contenedorFechasServicios" class="mb-4" style="display:none;">
    <label class="block text-sm font-medium text-gray-700 mb-2">Fecha:</label>
    <input type="date" id="fechaServicios" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="cargarListaServicios()">
</div>
               
            
            <div id="serviciosLista" class="mt-6">
                <div class="text-center py-8">
                    <div class="loading-spinner mx-auto"></div>
                    <p class="mt-4 text-gray-600">Cargando servicios...</p>
                </div>
            </div>
        </div>
    `;
    
    // Cargar barberos para filtro si es admin
    if (userRole === 'admin') {
        cargarBarberosEnFiltroServicios();
    }
    
    // Cargar servicios
    cargarListaServicios();
}

async function cargarBarberosEnFiltroServicios() {
   try {
        console.log('üîç Cargando barberos din√°micamente para filtro...');
        
        const { data: barberos, error } = await supabase
            .from('usuarios')
            .select('id, nombre')
            .eq('barberia_id', window.CURRENT_BARBERIA_ID)
            .eq('activo', true);
        
        if (error) throw error;
        
        const select = document.getElementById('selectBarberoServicios'); // ‚úÖ CORRECTO
        if (!select) return;
        
        // Limpiar opciones actuales (mantener las 2 primeras)
        while (select.children.length > 2) {
            select.removeChild(select.lastChild);
        }
        
        // Agregar todos los barberos din√°micamente
        barberos.forEach(barbero => {
            if (barbero.id !== currentUser.id) {  // No agregar al usuario actual
                const option = document.createElement('option');
                option.value = barbero.id;
                option.textContent = barbero.nombre;
                select.appendChild(option);
            }
        });
        
    } catch (error) {
        console.error('‚ùå Error cargando barberos:', error);
    }
}

let serviciosGlobales = []; // Para b√∫squeda por c√≥digo

async function cargarListaServicios() {
    try {
        console.log('üîç Cargando lista de servicios...');
        
        // Obtener fechas seg√∫n la vista seleccionada
const vista = document.getElementById('vistaServicios')?.value || 'hoy';
let fechaInicio, fechaFin;

if (vista === 'hoy') {
    const hoy = getFechaChile();
    fechaInicio = hoy;
    fechaFin = hoy;
} else if (vista === 'semana') {
    const fecha = document.getElementById('fechaServicios')?.value;
    if (!fecha) return;
    
    const date = new Date(fecha + 'T00:00:00');
    const dayOfWeek = date.getDay();
    const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
    
    const lunes = new Date(date);
    lunes.setDate(date.getDate() - diff);
    const domingo = new Date(lunes);
    domingo.setDate(lunes.getDate() + 6);
    
    fechaInicio = lunes.toISOString().split('T')[0];
    fechaFin = domingo.toISOString().split('T')[0];
} else if (vista === 'mes') {
    const fecha = document.getElementById('fechaServicios')?.value;
    if (!fecha) return;
    
    const date = new Date(fecha + 'T00:00:00');
    const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
    const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 0);
    
    fechaInicio = firstDay.toISOString().split('T')[0];
    fechaFin = lastDay.toISOString().split('T')[0];
} else if (vista === 'rango') {
    fechaInicio = document.getElementById('fechaDesdeServicios')?.value;
    fechaFin = document.getElementById('fechaHastaServicios')?.value;
    
    if (!fechaInicio || !fechaFin) return;
}

console.log(`üîç Cargando servicios: ${vista} | ${fechaInicio} al ${fechaFin}`);
        let query = supabase
            .from('citas')
            .select('*')
            .eq('barberia_id', window.CURRENT_BARBERIA_ID)
            .gte('fecha', fechaInicio)
            .lte('fecha', fechaFin);

        // Aplicar filtros seg√∫n rol
        if (userRole === 'empleado') {
            query = query.eq('realizado_por_id', currentUser.id);
        } else if (userRole === 'admin') {
            const filtro = document.getElementById('selectBarberoServicios')?.value || 'todos';
            if (filtro !== 'todos') {
                if (filtro === 'mi') {
                    query = query.eq('realizado_por_id', currentUser.id);
                } else {
                    query = query.eq('realizado_por_id', filtro);
                }
            }
        }

        const { data, error } = await query.order('codigo_diario', { ascending: false });

        if (error) throw error;

        serviciosGlobales = data || [];
        mostrarListaServicios(serviciosGlobales);

    } catch (error) {
        console.error('‚ùå Error cargando servicios:', error);
        document.getElementById('serviciosLista').innerHTML =
            '<div class="text-red-600 text-center">‚ùå Error al cargar servicios</div>';
    }
}
function cambiarVistaServicios() {
    const vista = document.getElementById('vistaServicios').value;
    const fechaContainer = document.getElementById('contenedorFechasServicios');
    
    if (!fechaContainer) return;
    
    console.log('üîÑ Cambiando vista servicios a:', vista);
    
    if (vista === 'hoy') {
        fechaContainer.style.display = 'none';
    } else if (vista === 'semana') {
        fechaContainer.style.display = 'block';
        fechaContainer.innerHTML = '<label class="block text-sm font-medium text-gray-700 mb-2">Seleccionar cualquier d√≠a de la semana:</label><input type="date" id="fechaServicios" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="cargarListaServicios()">';
        
        setTimeout(() => {
            const fechaInput = document.getElementById('fechaServicios');
            if (fechaInput) {
                fechaInput.value = getFechaChile();
                cargarListaServicios();
            }
        }, 100);
    } else if (vista === 'mes') {
        fechaContainer.style.display = 'block';
        fechaContainer.innerHTML = '<label class="block text-sm font-medium text-gray-700 mb-2">Seleccionar cualquier d√≠a del mes:</label><input type="date" id="fechaServicios" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="cargarListaServicios()">';
        
        setTimeout(() => {
            const fechaInput = document.getElementById('fechaServicios');
            if (fechaInput) {
                fechaInput.value = getFechaChile();  // ‚úÖ CORRECTO
                cargarListaServicios();
            }
        }, 100);
    } else if (vista === 'rango') {
        fechaContainer.style.display = 'block';
        const html = '<label class="block text-sm font-medium text-gray-700 mb-2">Rango de fechas:</label>' +
                    '<div class="grid grid-cols-2 gap-4">' +
                    '<div><label class="text-xs text-gray-600">Desde:</label>' +
                    '<input type="date" id="fechaDesdeServicios" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="cargarListaServicios()"></div>' +
                    '<div><label class="text-xs text-gray-600">Hasta:</label>' +
                    '<input type="date" id="fechaHastaServicios" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="cargarListaServicios()"></div>' +
                    '</div>';
        
        fechaContainer.innerHTML = html;
        
        setTimeout(() => {
            const fechaDesde = document.getElementById('fechaDesdeServicios');
            const fechaHasta = document.getElementById('fechaHastaServicios');
            if (fechaDesde && fechaHasta) {
                const now = new Date();
                const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                fechaDesde.value = firstDay.toISOString().split('T')[0];
                fechaHasta.value = lastDay.toISOString().split('T')[0];
                cargarListaServicios();
            }
        }, 100);
    }
}

function mostrarListaServicios(servicios) {
    const container = document.getElementById('serviciosLista');
    
    if (!servicios || servicios.length === 0) {
        container.innerHTML = '<div class="text-gray-500 text-center py-8">No hay servicios registrados hoy</div>';
        return;
    }

    const esAdmin = userRole === 'admin';
    let html = `
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">C√≥digo</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Barbero</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Servicio</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Productos</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Monto</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Pago</th>
                        ${esAdmin ? '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>' : ''}
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
    `;

   servicios.forEach(servicio => {
        // Parsear productos vendidos
        let productosHTML = '<span class="text-gray-400">-</span>';
        if (servicio.productos_vendidos) {
            try {
                const productos = typeof servicio.productos_vendidos === 'string' 
                    ? JSON.parse(servicio.productos_vendidos) 
                    : servicio.productos_vendidos;
                
                if (Array.isArray(productos) && productos.length > 0) {
                    productosHTML = productos.map(p => 
                        `<div class="text-purple-600 text-xs"><i class="fas fa-box mr-1"></i>${p.nombre} (x${p.cantidad})</div>`
                    ).join('');
                }
            } catch (e) {
                console.error('Error parseando productos:', e);
            }
        }
        
        html += `
            <tr>
                <td class="px-4 py-3 text-sm font-mono">#${servicio.codigo_diario || servicio.id}</td>
                <td class="px-4 py-3 text-sm">${servicio.realizado_por_nombre}</td>
                <td class="px-4 py-3 text-sm">${servicio.servicio_principal_nombre || '<span class="text-gray-400 italic">Sin servicio</span>'}</td>
                <td class="px-4 py-3 text-sm">${productosHTML}</td>
                <td class="px-4 py-3 text-sm font-semibold text-green-600">$${servicio.monto_total.toLocaleString('es-CL')}</td>
                <td class="px-4 py-3 text-sm">${servicio.forma_pago}</td>
                ${esAdmin ? `<td class="px-4 py-3 text-sm">
                    <button class="bg-red-500 text-white px-3 py-1 rounded text-xs hover:bg-red-600" onclick="confirmarEliminarServicio(${servicio.id}, '${servicio.codigo_diario || servicio.id}')">
                        üóëÔ∏è Eliminar
                    </button>
                </td>` : ''}
            </tr>
        `;
    });

    html += `
                </tbody>
            </table>
        </div>
        <div class="mt-4 text-sm text-gray-600">
            Total mostrado: ${servicios.length} servicios
        </div>
    `;

    container.innerHTML = html;
}

function filtrarPorCodigo() {
    const codigo = document.getElementById('buscarCodigo').value.replace('#', '').trim();
   
    if (!codigo) {
        mostrarListaServicios(serviciosGlobales);
        return;
    }
    
    const serviciosFiltrados = serviciosGlobales.filter(servicio => {
        const codigoServicio = (servicio.codigo_diario || servicio.id).toString();
        return codigoServicio.includes(codigo);
    });
    
    mostrarListaServicios(serviciosFiltrados);
}

async function confirmarEliminarServicio(servicioId, codigo) {
    if (!confirm(`¬øEliminar servicio #${codigo}? Esta acci√≥n NO se puede deshacer y afectar√° los c√°lculos.`)) {
        return;
    }
    
    try {
        console.log(`üóëÔ∏è Eliminando servicio ID: ${servicioId}`);
        
        const { error } = await supabase
            .from('citas')
            .delete()
            .eq('id', servicioId)
            .eq('barberia_id', window.CURRENT_BARBERIA_ID);
        
        if (error) {
            console.error('‚ùå Error eliminando servicio:', error);
            alert(`‚ùå Error al eliminar: ${error.message}`);
        } else {
            alert(`‚úÖ Servicio #${codigo} eliminado correctamente`);
            // Recargar lista
            cargarListaServicios();
        }
        
    } catch (error) {
        console.error('‚ùå Error cr√≠tico:', error);
        alert('‚ùå Error del sistema al eliminar servicio');
    }
}
        // ===============================
// MODAL AGREGAR BARBERO
// ===============================
function mostrarModalAgregarBarbero() {
    // Crear modal
    const modalHTML = `
        <div id="modalAgregarBarbero" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">‚ûï Nuevo Barbero</h3>
                    <button onclick="cerrarModalAgregarBarbero()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="formAgregarBarbero">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nombre Completo *</label>
                            <input type="text" id="nombreBarbero" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Ej: Juan P√©rez" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                            <input type="email" id="emailBarbero" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="juan@email.com" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Rol *</label>
                            <select id="rolBarbero" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                <option value="">Seleccionar rol...</option>
                                <option value="empleado">Empleado</option>
                                <option value="admin">Administrador</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3 mt-6">
                        <button type="button" onclick="cerrarModalAgregarBarbero()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600">
                            Cancelar
                        </button>
                        <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">
                            ‚ûï Agregar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;
    
    // Insertar modal en el DOM
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Agregar evento al formulario
    document.getElementById('formAgregarBarbero').addEventListener('submit', procesarAgregarBarbero);
}

function cerrarModalAgregarBarbero() {
    const modal = document.getElementById('modalAgregarBarbero');
    if (modal) {
        modal.remove();
    }
}

async function procesarAgregarBarbero(e) {
    e.preventDefault();
    
    const nombre = document.getElementById('nombreBarbero').value.trim();
    const email = document.getElementById('emailBarbero').value.trim();
    const rol = document.getElementById('rolBarbero').value;
    
    // Validaciones
    if (!nombre || !email || !rol) {
        alert('‚ùå Por favor completa todos los campos obligatorios');
        return;
    }
    
    if (!email.includes('@')) {
        alert('‚ùå Por favor ingresa un email v√°lido');
        return;
    }
    
    try {
        showLoading();
        console.log('üë§ Creando barbero:', { nombre, email, rol });
        
        // Crear usuario en Supabase
const nuevoUsuario = {
    email: email,
    nombre: nombre,
    role: rol,
    barberia_id: window.CURRENT_BARBERIA_ID,
    activo: true
};

console.log('üíæ Guardando en Supabase:', nuevoUsuario);

const { data, error } = await supabase
    .from('usuarios')
    .insert([nuevoUsuario])
    .select();

if (error) {
    console.error('‚ùå Error de Supabase:', error);
    alert(`‚ùå Error al crear barbero: ${error.message}`);
} else {
    console.log('‚úÖ Usuario creado:', data);
    alert(`‚úÖ Barbero "${nombre}" creado exitosamente!\n\nYa puede iniciar sesi√≥n con:\nüìß ${email}\nüîë Contrase√±a temporal: 123456`);
    
    // Cerrar modal
    cerrarModalAgregarBarbero();
    
    // Recargar lista de barberos
    cargarListaBarberos();
}
        
    } catch (error) {
        console.error('‚ùå Error:', error);
        alert('‚ùå Error al crear barbero: ' + error.message);
    } finally {
        hideLoading();
    }
}
        // ===============================
// MODAL EDITAR BARBERO
// ===============================
function mostrarModalEditarBarbero(id, nombre, email, rol) {
    const modalHTML = `
        <div id="modalEditarBarbero" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">‚úèÔ∏è Editar Barbero</h3>
                    <button onclick="cerrarModalEditarBarbero()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="formEditarBarbero">
                    <input type="hidden" id="editarBarberoId" value="${id}">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nombre Completo *</label>
                            <input type="text" id="editarNombreBarbero" value="${nombre}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                            <input type="email" id="editarEmailBarbero" value="${email}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Rol *</label>
                            <select id="editarRolBarbero" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                <option value="empleado" ${rol === 'empleado' ? 'selected' : ''}>Empleado</option>
                                <option value="admin" ${rol === 'admin' ? 'selected' : ''}>Administrador</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3 mt-6">
                        <button type="button" onclick="cerrarModalEditarBarbero()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600">
                            Cancelar
                        </button>
                        <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">
                            üíæ Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    document.getElementById('formEditarBarbero').addEventListener('submit', procesarEditarBarbero);
}

function cerrarModalEditarBarbero() {
    const modal = document.getElementById('modalEditarBarbero');
    if (modal) modal.remove();
}

async function procesarEditarBarbero(e) {
    e.preventDefault();
    
    const id = document.getElementById('editarBarberoId').value;
    const nombre = document.getElementById('editarNombreBarbero').value.trim();
    const email = document.getElementById('editarEmailBarbero').value.trim();
    const rol = document.getElementById('editarRolBarbero').value;
    
    if (!nombre || !email || !rol) {
        alert('Por favor completa todos los campos');
        return;
    }
    
    try {
        showLoading();
        
        const { data, error } = await supabase
    .from('usuarios')
    .update({ nombre, email, role: rol })
    .eq('id', id)
    .select();

console.log('üîÑ Resultado update:', data, error);
        
        if (error) {
            alert(`Error al actualizar: ${error.message}`);
        } else {
            alert(`‚úÖ Barbero "${nombre}" actualizado correctamente`);
            cerrarModalEditarBarbero();
            cargarListaBarberos();
        }
        
    } catch (error) {
        alert('Error del sistema: ' + error.message);
    } finally {
        hideLoading();
    }
}
        // ===============================
        // PESTA√ëAS PENDIENTES
        // ===============================
        function loadGestionBarberos() {
    console.log('üîç Cargando gesti√≥n de barberos...');
    
    // Verificar que sea admin
    if (userRole !== 'admin') {
        document.getElementById('contentArea').innerHTML = '<div class="text-red-600">‚ùå Sin permisos de administrador</div>';
        return;
    }
    
    document.getElementById('contentArea').innerHTML = `
        <div class="max-w-4xl mx-auto">
            <h2 class="text-2xl font-bold mb-6">
                <i class="fas fa-users mr-2"></i>Gesti√≥n de Barberos
            </h2>
            <p class="text-gray-600 mb-6">Administra el personal y adelantos de la barber√≠a</p>
            
            <div class="barberos-container mb-8">
                <div class="text-center py-8">
                    <div class="loading-spinner mx-auto"></div>
                    <p class="mt-4 text-gray-600">‚è≥ Cargando barberos...</p>
                </div>
            </div>
            
            <div class="adelantos-resumen bg-gray-50 p-6 rounded-lg">
                <h3 class="text-lg font-bold mb-4">üîµ Resumen de Adelantos Semanal</h3>
                <div class="adelantos-loading">
                    <div class="loading-spinner mx-auto"></div>
                    <p class="mt-2 text-gray-600">‚è≥ Cargando adelantos...</p>
                </div>
            </div>
        </div>
    `;
    
    // Cargar barberos y adelantos
    cargarListaBarberos();
    cargarResumenAdelantos();
}

async function cargarListaBarberos() {
    try {
        console.log('üîç Cargando lista de barberos...');
        
       // Intentar cargar desde Supabase, si falla usar datos demo
try {
    console.log('üîç Intentando cargar barberos desde Supabase...');
    
    const { data: barberos, error } = await supabase
        .from('usuarios')
        .select('id, nombre, email, role')
        .eq('barberia_id', window.CURRENT_BARBERIA_ID)
        .eq('activo', true);
    
    if (error) {
        console.log('‚ö†Ô∏è Error RLS, usando datos demo:', error.message);
        // Fallback a datos demo
        const barberosDemo = [
            { id: '3fbc31cc-da0a-4f4a-b45b-e7a51320c92c', nombre: 'Administrador', email: 'israelparancan.n@gmail.com', role: 'admin' },
            { id: '1a0242b8-bc7a-4e61-9e33-ac182996a950', nombre: 'Misho', email: 'ispn4trade@gmail.com', role: 'empleado' }
        ];
        mostrarListaBarberos(barberosDemo);
    } else {
    console.log('‚úÖ Barberos cargados desde Supabase:', barberos);
    console.log('üìä Cantidad de barberos:', barberos ? barberos.length : 0);
    
    // Si no hay barberos en Supabase, usar demo
    if (!barberos || barberos.length === 0) {
        console.log('üîÑ No hay barberos en Supabase, usando demo');
        const barberosDemo = [
            { id: '3fbc31cc-da0a-4f4a-b45b-e7a51320c92c', nombre: 'Administrador', email: 'israelparancan.n@gmail.com', role: 'admin' },
            { id: '1a0242b8-bc7a-4e61-9e33-ac182996a950', nombre: 'Misho', email: 'ispn4trade@gmail.com', role: 'empleado' }
        ];
        mostrarListaBarberos(barberosDemo);
    } else {
        mostrarListaBarberos(barberos);
    }
}
} catch (error) {
    console.error('‚ùå Error cr√≠tico:', error);
    // Fallback final
    const barberosDemo = [
        { id: '3fbc31cc-da0a-4f4a-b45b-e7a51320c92c', nombre: 'Administrador', email: 'israelparancan.n@gmail.com', role: 'admin' },
        { id: '1a0242b8-bc7a-4e61-9e33-ac182996a950', nombre: 'Misho', email: 'ispn4trade@gmail.com', role: 'empleado' }
    ];
    mostrarListaBarberos(barberosDemo);
}
        
    } catch (error) {
        console.error('‚ùå Error en cargarListaBarberos:', error);
        document.querySelector('.barberos-container').innerHTML = 
            '<div class="text-red-600 text-center">‚ùå Error cargando barberos</div>';
    }
}

function mostrarListaBarberos(barberos) {
    const container = document.querySelector('.barberos-container');
    
    if (!barberos || barberos.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8">
                <div class="text-gray-500 mb-4">üë§ No hay barberos registrados</div>
                <button class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700" onclick="alert('Funcionalidad pr√≥ximamente')">
                    ‚ûï Agregar Primer Barbero
                </button>
            </div>
        `;
        return;
    }
    
    let html = '<div class="space-y-4">';
    
    barberos.forEach(barbero => {
        const roleBadge = barbero.role === 'admin' ? 
            '<span class="inline-block px-3 py-1 bg-purple-100 text-purple-700 text-sm rounded-full">üëë Administrador</span>' : 
            '<span class="inline-block px-3 py-1 bg-blue-100 text-blue-700 text-sm rounded-full">üíº Empleado</span>';
        
        html += `
            <div class="bg-white p-6 rounded-lg shadow border">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="text-lg font-semibold text-gray-900 mb-2">${barbero.nombre}</div>
                        <div class="text-gray-600 mb-2">${barbero.email}</div>
                        <div class="mb-3">${roleBadge}</div>
                    </div>
                    <div class="flex space-x-2">
                       <button class="bg-gray-100 text-gray-600 px-3 py-2 rounded hover:bg-gray-200" onclick="mostrarModalEditarBarbero('${barbero.id}', '${barbero.nombre}', '${barbero.email}', '${barbero.role}')">
                    ‚úèÔ∏è
                  </button>
                        <button class="bg-red-100 text-red-600 px-3 py-2 rounded hover:bg-red-200" onclick="confirmarEliminarBarbero('${barbero.id}', '${barbero.nombre}')">
                            üóëÔ∏è
                        </button>
                        <button class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700" onclick="mostrarFormularioAdelanto('${barbero.id}', '${barbero.nombre}')">
                            üí∞ + Adelanto
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += `
        </div>
        <div class="mt-6 text-center">
            <button class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700" onclick="mostrarModalAgregarBarbero()">
    ‚ûï Agregar Barbero
</button>
        </div>
    `;
    
    container.innerHTML = html;
}

async function confirmarEliminarBarbero(barberoId, nombre) {
    if (!confirm(`¬øDesactivar barbero "${nombre}"?\n\n‚ö†Ô∏è El barbero ya no podr√°:\n‚Ä¢ Iniciar sesi√≥n\n‚Ä¢ Registrar servicios\n‚Ä¢ Recibir adelantos\n\n‚úÖ Sus datos hist√≥ricos se mantendr√°n.`)) {
        return;
    }
    
    try {
        showLoading();
        console.log(`üóëÔ∏è Desactivando barbero: ${nombre} (${barberoId})`);
        
        const { data, error } = await supabase
            .from('usuarios')
            .update({ activo: false })
            .eq('id', barberoId)
            .eq('barberia_id', window.CURRENT_BARBERIA_ID)
            .select();
        
        if (error) {
            console.error('‚ùå Error:', error);
            alert(`‚ùå Error al desactivar: ${error.message}`);
        } else {
            alert(`‚úÖ Barbero "${nombre}" desactivado correctamente.\n\nYa no podr√° acceder al sistema.`);
            cargarListaBarberos(); // Recargar lista
        }
        
    } catch (error) {
        console.error('‚ùå Error cr√≠tico:', error);
        alert('‚ùå Error del sistema');
    } finally {
        hideLoading();
    }
}
function mostrarFormularioAdelanto(barberoId, nombre) {
    const monto = prompt(`üí∞ Ingresa el monto del adelanto para ${nombre}:`);
    if (monto && !isNaN(monto) && parseFloat(monto) > 0) {
        const motivo = prompt(`Motivo del adelanto (opcional):`);
        registrarAdelanto(barberoId, nombre, parseFloat(monto), motivo || 'Adelanto');
    } else if (monto !== null) {
        alert('‚ùå Por favor ingresa un monto v√°lido');
    }
}

async function registrarAdelanto(barberoId, barberoNombre, monto, motivo) {
    try {
        showLoading();
        console.log(`üí∞ Registrando adelanto: ${barberoNombre} - $${monto}`);
        
       // Calcular semana y a√±o actual
const hoy = new Date();
const inicioA√±o = new Date(hoy.getFullYear(), 0, 1);
const diasTranscurridos = Math.floor((hoy - inicioA√±o) / (24 * 60 * 60 * 1000));
const numeroSemana = Math.ceil((diasTranscurridos + inicioA√±o.getDay() + 1) / 7);

const nuevoAdelanto = {
    barberia_id: window.CURRENT_BARBERIA_ID,
    barbero_id: barberoId,
    barbero_nombre: barberoNombre,
    monto: monto,
    motivo: motivo,
    semana: numeroSemana,
    a√±o: hoy.getFullYear(),
    activo: true
};
        
        const { data, error } = await supabase
            .from('adelantos')
            .insert([nuevoAdelanto]);
        
        if (error) {
            console.error('‚ùå Error guardando adelanto:', error);
            alert(`‚ùå Error al registrar adelanto: ${error.message}`);
        } else {
            alert(`‚úÖ Adelanto registrado: $${monto.toLocaleString('es-CL')} para ${barberoNombre}`);
            // Recargar resumen de adelantos
            cargarResumenAdelantos();
        }
        
    } catch (error) {
        console.error('‚ùå Error cr√≠tico:', error);
        alert('‚ùå Error del sistema al registrar adelanto');
    } finally {
        hideLoading();
    }
}

async function cargarResumenAdelantos() {
    try {
        console.log('üîç Cargando resumen de adelantos...');
        
        // Calcular fechas de la semana actual (lunes a domingo)
        const hoy = new Date();
        const diaSemana = hoy.getDay();
        const diasDesdeInicio = diaSemana === 0 ? 6 : diaSemana - 1;
        
        const inicioSemana = new Date(hoy);
        inicioSemana.setDate(hoy.getDate() - diasDesdeInicio);
        inicioSemana.setHours(0, 0, 0, 0);
        
        const finSemana = new Date(inicioSemana);
        finSemana.setDate(inicioSemana.getDate() + 6);
        finSemana.setHours(23, 59, 59, 999);
        
        console.log('üìÖ Semana actual:', inicioSemana.toISOString().split('T')[0], 'al', finSemana.toISOString().split('T')[0]);
        
        const { data: adelantos, error } = await supabase
            .from('adelantos')
            .select('barbero_nombre, monto')
            .eq('barberia_id', window.CURRENT_BARBERIA_ID)
            .eq('activo', true)
            .gte('created_at', inicioSemana.toISOString())
            .lte('created_at', finSemana.toISOString());
        
        if (error) {
            console.error('‚ùå Error cargando adelantos:', error);
           const loadingElement = document.querySelector('.adelantos-loading');
if (loadingElement) {
    loadingElement.innerHTML = '<div class="text-red-600">‚ùå Error del sistema</div>';
}
            return;
        }
        
        console.log('‚úÖ Adelantos de la semana:', adelantos);
        mostrarResumenAdelantos(adelantos || []);
        
    } catch (error) {
        console.error('‚ùå Error cr√≠tico en adelantos:', error);
        document.querySelector('.adelantos-loading').innerHTML = 
            '<div class="text-red-600">‚ùå Error del sistema</div>';
    }
}

function mostrarResumenAdelantos(adelantos) {
    // Buscar contenedor principal de adelantos
    let container = document.querySelector('.adelantos-resumen');
    
    // Si no existe, buscar por clase alternativa
    if (!container) {
        const loadingElement = document.querySelector('.adelantos-loading');
        if (loadingElement && loadingElement.parentElement) {
            container = loadingElement.parentElement;
        }
    }
    
    // Si a√∫n no existe, salir silenciosamente
    if (!container) {
        console.log('üîÑ Contenedor de adelantos no disponible, omitiendo actualizaci√≥n');
        return;
    }
    
    if (!adelantos || adelantos.length === 0) {
        container.innerHTML = `
            <h3 class="text-lg font-bold mb-4">üîµ Resumen de Adelantos Semanal</h3>
            <div class="text-center py-6">
                <div class="text-gray-500 mb-4">üí∞ No hay adelantos esta semana</div>
                <div class="flex justify-center">
            <button class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700" onclick="mostrarModalHistorialAdelantos()">
          üìã Historial Completo
            </button>
</div>
            </div>
        `;
        return;
    }
    
    // Agrupar adelantos por barbero
    const adelantosPorBarbero = {};
    let totalGeneral = 0;
    
    adelantos.forEach(adelanto => {
        const barbero = adelanto.barbero_nombre;
        if (!adelantosPorBarbero[barbero]) {
            adelantosPorBarbero[barbero] = 0;
        }
        adelantosPorBarbero[barbero] += parseFloat(adelanto.monto || 0);
        totalGeneral += parseFloat(adelanto.monto || 0);
    });
    
    let html = '<h3 class="text-lg font-bold mb-4">üîµ Resumen de Adelantos Semanal</h3>';
    html += '<div class="bg-white p-4 rounded border mb-4">';
    
    Object.keys(adelantosPorBarbero).forEach(barbero => {
        const monto = adelantosPorBarbero[barbero];
        html += `
            <div class="flex justify-between items-center py-2 border-b border-gray-200">
                <span class="font-medium">${barbero}:</span>
                <span class="text-lg font-bold text-green-600">$${monto.toLocaleString('es-CL')}</span>
            </div>
        `;
    });
    
    html += `
        <div class="flex justify-between items-center py-3 pt-4 border-t border-gray-300">
            <span class="text-lg font-bold">Total:</span>
            <span class="text-xl font-bold text-blue-600">$${totalGeneral.toLocaleString('es-CL')}</span>
        </div>
    `;
    
  html += `
    </div>
    <div class="flex justify-center space-x-4">
        <button class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700" onclick="mostrarModalHistorialAdelantos()">
    üìã Historial Completo
</button>
    </div>
`;
    
    container.innerHTML = html;
}
function mostrarModalHistorialAdelantos() {
    const modalHTML = `
        <div id="modalHistorialAdelantos" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">üìã Historial Completo de Adelantos</h3>
                    <button onclick="cerrarModalHistorialAdelantos()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <!-- Filtros -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Barbero:</label>
                        <select id="filtroBarberoHistorial" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="cargarHistorialAdelantos()">
                            <option value="todos">Todos los barberos</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Desde:</label>
                        <input type="date" id="fechaDesdeHistorial" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="cargarHistorialAdelantos()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Hasta:</label>
                        <input type="date" id="fechaHastaHistorial" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="cargarHistorialAdelantos()">
                    </div>
                </div>
                
                <!-- Contenido del historial -->
                <div id="contenidoHistorialAdelantos">
                    <div class="text-center py-8">
                        <div class="loading-spinner mx-auto"></div>
                        <p class="mt-4 text-gray-600">Cargando historial...</p>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Configurar fechas por defecto (√∫ltimo mes)
    const hoy = new Date();
    const haceUnMes = new Date();
    haceUnMes.setMonth(hoy.getMonth() - 1);
    
    document.getElementById('fechaDesdeHistorial').value = haceUnMes.toISOString().split('T')[0];
    document.getElementById('fechaHastaHistorial').value = hoy.toISOString().split('T')[0];
    
    // Cargar barberos en filtro
    cargarBarberosEnHistorial();
    
    // Cargar historial inicial
    cargarHistorialAdelantos();
}

function cerrarModalHistorialAdelantos() {
    const modal = document.getElementById('modalHistorialAdelantos');
    if (modal) {
        modal.remove();
    }
}

async function cargarBarberosEnHistorial() {
    try {
        const { data: barberos, error } = await supabase
            .from('usuarios')
            .select('id, nombre')
            .eq('barberia_id', window.CURRENT_BARBERIA_ID);
        
        if (error) throw error;
        
        const select = document.getElementById('filtroBarberoHistorial');
        if (!select) return;
        
        // Agregar barberos al filtro (incluyendo inactivos para historial)
        barberos.forEach(barbero => {
            const option = document.createElement('option');
            option.value = barbero.id;
            option.textContent = barbero.nombre;
            select.appendChild(option);
        });
        
    } catch (error) {
        console.error('‚ùå Error cargando barberos:', error);
    }
}

async function cargarHistorialAdelantos() {
    const contenido = document.getElementById('contenidoHistorialAdelantos');
    if (!contenido) return;
    
    contenido.innerHTML = '<div class="text-center py-8"><div class="loading-spinner mx-auto"></div><p class="mt-4 text-gray-600">Cargando historial...</p></div>';
    
    try {
        const fechaDesde = document.getElementById('fechaDesdeHistorial').value;
        const fechaHasta = document.getElementById('fechaHastaHistorial').value;
        const barberoFiltro = document.getElementById('filtroBarberoHistorial').value;
        
        if (!fechaDesde || !fechaHasta) {
            contenido.innerHTML = '<p class="text-gray-500">Por favor selecciona ambas fechas</p>';
            return;
        }
        
        // Construir query
        let query = supabase
            .from('adelantos')
            .select('*')
            .eq('barberia_id', window.CURRENT_BARBERIA_ID)
            .gte('created_at', fechaDesde + 'T00:00:00')
            .lte('created_at', fechaHasta + 'T23:59:59')
            .order('created_at', { ascending: false });
        
        // Aplicar filtro por barbero si no es "todos"
        if (barberoFiltro !== 'todos') {
            query = query.eq('barbero_id', barberoFiltro);
        }
        
        const { data: adelantos, error } = await query;
        
        if (error) throw error;
        
        mostrarTablaHistorial(adelantos || []);
        
    } catch (error) {
        console.error('‚ùå Error:', error);
        contenido.innerHTML = '<div class="text-red-600 text-center">‚ùå Error al cargar historial</div>';
    }
}

function mostrarTablaHistorial(adelantos) {
    const contenido = document.getElementById('contenidoHistorialAdelantos');
    
    if (!adelantos || adelantos.length === 0) {
        contenido.innerHTML = '<div class="text-center py-8 text-gray-500">üìã No hay adelantos en el per√≠odo seleccionado</div>';
        return;
    }
    
    const total = adelantos.reduce((sum, a) => sum + parseFloat(a.monto || 0), 0);
    
    let html = `
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Barbero</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Monto</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Motivo</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
    `;
    
    adelantos.forEach(adelanto => {
        const fecha = new Date(adelanto.created_at).toLocaleDateString('es-CL');
        html += `
            <tr>
                <td class="px-4 py-3 text-sm">${fecha}</td>
                <td class="px-4 py-3 text-sm">${adelanto.barbero_nombre}</td>
                <td class="px-4 py-3 text-sm font-semibold text-green-600">$${parseFloat(adelanto.monto).toLocaleString('es-CL')}</td>
                <td class="px-4 py-3 text-sm">${adelanto.motivo}</td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
        <div class="mt-4 p-4 bg-gray-50 rounded-lg">
            <div class="flex justify-between items-center">
                <span class="font-semibold">Total del per√≠odo:</span>
                <span class="text-xl font-bold text-blue-600">$${total.toLocaleString('es-CL')}</span>
            </div>
            <div class="text-sm text-gray-600 mt-1">
                ${adelantos.length} adelanto${adelantos.length !== 1 ? 's' : ''} encontrado${adelantos.length !== 1 ? 's' : ''}
            </div>
        </div>
    `;
    
    contenido.innerHTML = html;
}
    // ===============================
        // PESTA√ëA: CIERRE DE CAJA
        // ===============================
        function loadCierreCaja() {
            console.log('üîç Cargando cierre de caja...');
            
            // Verificar que sea admin
            if (userRole !== 'admin') {
                document.getElementById('contentArea').innerHTML = '<div class="text-red-600">‚ùå Sin permisos de administrador</div>';
                return;
            }
            
            document.getElementById('contentArea').innerHTML = `
                <div class="max-w-5xl mx-auto">
                    <h2 class="text-2xl font-bold mb-6">
                        <i class="fas fa-cash-register mr-2"></i>Cierre de Caja
                    </h2>
                    
                    <!-- Selector de Vista -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Cierre:</label>
                            <select id="vistaCierre" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="cambiarVistaCierre()">
                                <option value="diaria">üìÖ Cierre Diario</option>
                                <option value="semanal">üìä Cierre Semanal</option>
                                <option value="rango">üóìÔ∏è Rango Personalizado</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filtrar por Barbero:</label>
                            <select id="selectBarberoCierre" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="cargarDatosCierre()">
                                <option value="todos">Ver Todos</option>
                                <option value="mi">Mi Resumen</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Contenedor de Fechas -->
                    <div id="contenedorFechasCierre" class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Fecha:</label>
                        <input type="date" id="fechaCierre" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="cargarDatosCierre()">
                    </div>
                    
                    <!-- Contenedor del Cierre -->
                    <div id="contenidoCierre" class="mt-6">
                        <div class="text-center py-8">
                            <div class="loading-spinner mx-auto"></div>
                            <p class="mt-4 text-gray-600">Calculando cierre...</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Configurar fecha inicial
            setTimeout(() => {
                const fechaInput = document.getElementById('fechaCierre');
                if (fechaInput) {
                   fechaInput.value = getFechaChile();
                }
                cargarBarberosEnFiltroCierre();
                cargarDatosCierre();
            }, 100);
        }
        
        async function cargarBarberosEnFiltroCierre() {
            try {
        console.log('üîç Cargando barberos din√°micamente para filtro...');
        
        const { data: barberos, error } = await supabase
            .from('usuarios')
            .select('id, nombre')
            .eq('barberia_id', window.CURRENT_BARBERIA_ID)
            .eq('activo', true);
        
        if (error) throw error;
        
        const select = document.getElementById('selectBarberoCierre'); // ‚úÖ CORRECTO
        if (!select) return;
        
        // Limpiar opciones actuales (mantener las 2 primeras)
        while (select.children.length > 2) {
            select.removeChild(select.lastChild);
        }
        
        // Agregar todos los barberos din√°micamente
        barberos.forEach(barbero => {
            if (barbero.id !== currentUser.id) {  // No agregar al usuario actual
                const option = document.createElement('option');
                option.value = barbero.id;
                option.textContent = barbero.nombre;
                select.appendChild(option);
            }
        });
        
    } catch (error) {
        console.error('‚ùå Error cargando barberos:', error);
    }
}
        
        function cambiarVistaCierre() {
            const vista = document.getElementById('vistaCierre').value;
            const fechaContainer = document.getElementById('contenedorFechasCierre');
            
            if (!fechaContainer) return;
            
            console.log('üîÑ Cambiando vista de cierre a:', vista);
            
            if (vista === 'diaria') {
                fechaContainer.innerHTML = `
                    <label class="block text-sm font-medium text-gray-700 mb-2">Fecha del Cierre:</label>
                    <input type="date" id="fechaCierre" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="cargarDatosCierre()">
                `;
            } else if (vista === 'semanal') {
                fechaContainer.innerHTML = `
                    <label class="block text-sm font-medium text-gray-700 mb-2">Seleccionar cualquier d√≠a de la semana:</label>
                    <input type="date" id="fechaCierre" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="cargarDatosCierre()">
                `;
            } else if (vista === 'rango') {
                fechaContainer.innerHTML = `
                    <label class="block text-sm font-medium text-gray-700 mb-2">Rango de fechas:</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs text-gray-600">Desde:</label>
                            <input type="date" id="fechaDesde" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="cargarDatosCierre()">
                        </div>
                        <div>
                            <label class="text-xs text-gray-600">Hasta:</label>
                            <input type="date" id="fechaHasta" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="cargarDatosCierre()">
                        </div>
                    </div>
                `;
            }
            
            // Configurar fechas iniciales despu√©s del cambio
            setTimeout(() => {
                if (vista === 'diaria' || vista === 'semanal') {
                    const fechaInput = document.getElementById('fechaCierre');
                    if (fechaInput) {
                        fechaInput.value = getFechaChile();
                    }
                } else if (vista === 'rango') {
                    const now = new Date();
                    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                    const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    
                    const fechaDesde = document.getElementById('fechaDesde');
                    const fechaHasta = document.getElementById('fechaHasta');
                    
                    if (fechaDesde && fechaHasta) {
                        fechaDesde.value = firstDay.toISOString().split('T')[0];
                        fechaHasta.value = lastDay.toISOString().split('T')[0];
                    }
                }
                cargarDatosCierre();
            }, 100);
        }
        
        async function cargarDatosCierre() {
            const contenido = document.getElementById('contenidoCierre');
            if (!contenido) return;
            
            contenido.innerHTML = '<div class="text-center py-8"><div class="loading-spinner mx-auto"></div><p class="mt-4 text-gray-600">üí∞ Calculando cierre...</p></div>';
            
            try {
                const vista = document.getElementById('vistaCierre').value;
                const filtro = document.getElementById('selectBarberoCierre')?.value || 'todos';
                
                let fechaInicio, fechaFin, fecha;
                
                // Obtener fechas seg√∫n la vista
                if (vista === 'rango') {
                    fechaInicio = document.getElementById('fechaDesde')?.value;
                    fechaFin = document.getElementById('fechaHasta')?.value;
                    
                    if (!fechaInicio || !fechaFin) {
                        contenido.innerHTML = '<p class="text-gray-500">Por favor selecciona ambas fechas del rango</p>';
                        return;
                    }
                } else {
                    fecha = document.getElementById('fechaCierre')?.value;
                    
                    if (!fecha) {
                        contenido.innerHTML = '<p class="text-gray-500">Por favor selecciona una fecha</p>';
                        return;
                    }
                    
                    if (vista === 'diaria') {
                        fechaInicio = fecha;
                        fechaFin = fecha;
                    } else if (vista === 'semanal') {
                        // Calcular semana completa (lunes a domingo)
                        const date = new Date(fecha + 'T00:00:00');
                        const dayOfWeek = date.getDay();
                        const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                        
                        const lunes = new Date(date);
                        lunes.setDate(date.getDate() - diff);
                        
                        const domingo = new Date(lunes);
                        domingo.setDate(lunes.getDate() + 6);
                        
                        fechaInicio = lunes.toISOString().split('T')[0];
                        fechaFin = domingo.toISOString().split('T')[0];
                    }
                }
                
                console.log(`üí∞ Cargando cierre: ${vista} | ${fechaInicio} al ${fechaFin}`);
                
                // Cargar servicios
                let queryServicios = supabase
                    .from('citas')
                    .select('*')
                    .eq('barberia_id', window.CURRENT_BARBERIA_ID)
                    .gte('fecha', fechaInicio)
                    .lte('fecha', fechaFin);
                
                // Aplicar filtro por barbero
                if (filtro !== 'todos') {
                    if (filtro === 'mi') {
                        queryServicios = queryServicios.eq('realizado_por_id', currentUser.id);
                    } else {
                        queryServicios = queryServicios.eq('realizado_por_id', filtro);
                    }
                }
                
                const { data: servicios, error } = await queryServicios;
                if (error) throw error;
                
                // Calcular totales de servicios
                const totalRecaudado = servicios ? servicios.reduce((sum, s) => sum + parseFloat(s.monto_total || 0), 0) : 0;
                const totalServicios = servicios ? servicios.length : 0;
                
                // Agrupar por forma de pago
                const porFormaPago = servicios ? servicios.reduce((acc, s) => {
                    acc[s.forma_pago] = (acc[s.forma_pago] || 0) + parseFloat(s.monto_total || 0);
                    return acc;
                }, {}) : {};
                
                // Cargar adelantos SOLO para vista semanal y rango
let totalAdelantos = 0;
if (vista !== 'diaria') {
    console.log('üí∏ Cargando adelantos para cierre...');
    
    let queryAdelantos = supabase
        .from('adelantos')
        .select('barbero_id, monto')
        .eq('barberia_id', window.CURRENT_BARBERIA_ID)
        .gte('created_at', fechaInicio + 'T00:00:00')
        .lte('created_at', fechaFin + 'T23:59:59');
    
    // Solo filtrar por activo si es vista SEMANAL
    if (vista === 'semanal') {
        queryAdelantos = queryAdelantos.eq('activo', true);
        console.log('üí∞ Cierre semanal: solo adelantos activos');
    } else {
        console.log('üí∞ Cierre rango: todos los adelantos hist√≥ricos');
    }
                    
                    // Aplicar mismo filtro que servicios
                    if (filtro !== 'todos') {
                        if (filtro === 'mi') {
                            queryAdelantos = queryAdelantos.eq('barbero_id', currentUser.id);
                        } else {
                            queryAdelantos = queryAdelantos.eq('barbero_id', filtro);
                        }
                    }
                    
                    const { data: adelantos, error: errorAdelantos } = await queryAdelantos;
                    
                    if (errorAdelantos) {
                        console.error('‚ùå Error cargando adelantos:', errorAdelantos);
                    } else if (adelantos) {
                        totalAdelantos = adelantos.reduce((sum, a) => sum + parseFloat(a.monto || 0), 0);
                        console.log('üí∏ Total adelantos:', totalAdelantos);
                    }
                }
                
                // Calcular monto a pagar
                const montoAPagar = totalRecaudado - totalAdelantos;
                
                // Generar HTML del cierre
                mostrarCierre({
                    vista,
                    fechaInicio,
                    fechaFin,
                    totalRecaudado,
                    totalServicios,
                    totalAdelantos,
                    montoAPagar,
                    porFormaPago
                });
                
            } catch (error) {
                console.error('‚ùå Error cargando cierre:', error);
                contenido.innerHTML = '<div class="bg-red-100 p-4 rounded-lg text-red-700">‚ùå Error al calcular el cierre. Intenta nuevamente.</div>';
            }
        }
        
        function mostrarCierre(datos) {
            const {
                vista,
                fechaInicio,
                fechaFin,
                totalRecaudado,
                totalServicios,
                totalAdelantos,
                montoAPagar,
                porFormaPago
            } = datos;
            
            const contenido = document.getElementById('contenidoCierre');
            
            let tituloVista = vista === 'diaria' ? 'DIARIO' : 
                             vista === 'semanal' ? 'SEMANAL' : 'RANGO PERSONALIZADO';
            
            let fechaTexto = fechaInicio === fechaFin ? fechaInicio : `${fechaInicio} al ${fechaFin}`;
            
            let html = `
                <div class="bg-white rounded-lg shadow-lg border-2 border-blue-200">
                    <!-- Encabezado -->
                    <div class="bg-blue-600 text-white p-6 rounded-t-lg">
                        <h3 class="text-2xl font-bold flex items-center">
                            üí∞ CIERRE DE CAJA ${tituloVista}
                        </h3>
                        <p class="text-blue-100 mt-2">üìÖ ${fechaTexto}</p>
                    </div>
                    
                    <!-- M√©tricas principales -->
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                <div class="text-sm text-green-600 mb-1">üí∞ Total Recaudado</div>
                                <div class="text-2xl font-bold text-green-900">$${totalRecaudado.toLocaleString('es-CL')}</div>
                            </div>
                            
                            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                <div class="text-sm text-blue-600 mb-1">üìä Servicios Realizados</div>
                                <div class="text-2xl font-bold text-blue-900">${totalServicios}</div>
                            </div>
            `;
            
            // Mostrar adelantos solo si no es vista diaria
            if (vista !== 'diaria') {
                html += `
                            <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                                <div class="text-sm text-yellow-600 mb-1">üí∏ Adelantos del Per√≠odo</div>
                                <div class="text-2xl font-bold text-yellow-900">$${totalAdelantos.toLocaleString('es-CL')}</div>
                            </div>
                `;
            } else {
                html += `
                            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <div class="text-sm text-gray-600 mb-1">‚ÑπÔ∏è Vista Diaria</div>
                                <div class="text-lg text-gray-700">Sin adelantos</div>
                            </div>
                `;
            }
            
            html += `
                        </div>
                        
                        <!-- MONTO A PAGAR - Destacado -->
                        <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-6 rounded-xl mb-6 shadow-lg">
                            <div class="text-center">
                                <div class="text-lg font-semibold mb-2">üí∞ MONTO A PAGAR</div>
                                <div class="text-4xl font-bold">${vista === 'diaria' ? 
                                    `$${totalRecaudado.toLocaleString('es-CL')}` : 
                                    `$${montoAPagar.toLocaleString('es-CL')}`}</div>
                                ${vista !== 'diaria' ? `
                                    <div class="text-purple-100 mt-2 text-sm">
                                        (Recaudado: $${totalRecaudado.toLocaleString('es-CL')} - Adelantos: $${totalAdelantos.toLocaleString('es-CL')})
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <!-- Desglose por forma de pago -->
                        <div class="border-t pt-6">
                            <h4 class="font-bold text-lg mb-4 flex items-center">
                                üí≥ Desglose por Forma de Pago
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <div class="flex justify-between items-center">
                                        <span class="font-medium">üíµ Efectivo:</span>
                                        <span class="text-xl font-bold text-green-600">$${(porFormaPago['Efectivo'] || 0).toLocaleString('es-CL')}</span>
                                    </div>
                                </div>
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <div class="flex justify-between items-center">
                                        <span class="font-medium">üí≥ Cuenta RUT:</span>
                                        <span class="text-xl font-bold text-blue-600">$${(porFormaPago['Cuenta RUT'] || 0).toLocaleString('es-CL')}</span>
                                    </div>
                                </div>
                                <div class="bg-purple-50 p-4 rounded-lg">
                                    <div class="flex justify-between items-center">
                                        <span class="font-medium">üì± Mercado Pago:</span>
                                        <span class="text-xl font-bold text-purple-600">$${(porFormaPago['Mercado Pago'] || 0).toLocaleString('es-CL')}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            contenido.innerHTML = html;
        }    
    function loadEstadisticas() {
            console.log('üîç Cargando estad√≠sticas...');
            
            // Verificar que sea admin
            if (userRole !== 'admin') {
                document.getElementById('contentArea').innerHTML = '<div class="text-red-600">‚ùå Sin permisos de administrador</div>';
                return;
            }
            
            document.getElementById('contentArea').innerHTML = `
                <div class="max-w-7xl mx-auto">
                    <h2 class="text-2xl font-bold mb-6">
                        <i class="fas fa-chart-line mr-2"></i>Estad√≠sticas y An√°lisis
                    </h2>
                    
                    <!-- Gr√°ficos Principales -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <!-- Top Servicios -->
                        <div class="bg-white p-6 rounded-lg shadow border">
                            <h3 class="text-lg font-bold mb-4">üî• Servicios M√°s Populares </h3>
                            <div id="topServicios">
                                <div class="text-center py-6">
                                    <div class="loading-spinner mx-auto"></div>
                                    <p class="mt-4 text-gray-600">Analizando popularidad...</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- M√©todos de Pago -->
                        <div class="bg-white p-6 rounded-lg shadow border">
                            <h3 class="text-lg font-bold mb-4">üí≥ Distribuci√≥n de Pagos </h3>
                            <div id="metodosPago">
                                <div class="text-center py-6">
                                    <div class="loading-spinner mx-auto"></div>
                                    <p class="mt-4 text-gray-600">Calculando m√©todos...</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Productividad por Barbero -->
                        <div class="bg-white p-6 rounded-lg shadow border">
                            <h3 class="text-lg font-bold mb-4">üë®‚Äçüíº Productividad por Barbero </h3>
                            <div id="productividadBarberos">
                                <div class="text-center py-6">
                                    <div class="loading-spinner mx-auto"></div>
                                    <p class="mt-4 text-gray-600">Midiendo rendimiento...</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tendencia Semanal -->
                        <div class="bg-white p-6 rounded-lg shadow border">
                            <h3 class="text-lg font-bold mb-4">üìÖ Ingresos por d√≠as</h3>
                            <div id="tendenciaSemanal">
                                <div class="text-center py-6">
                                    <div class="loading-spinner mx-auto"></div>
                                    <p class="mt-4 text-gray-600">Analizando tendencias...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Insights Inteligentes -->
                    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-bold mb-4">üéØ Insights del Negocio</h3>
                        <div id="insightsInteligentes">
                            <div class="text-center py-4">
                                <div class="loading-spinner mx-auto"></div>
                                <p class="mt-2 text-indigo-100">Generando an√°lisis inteligente...</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Cargar estad√≠sticas
            setTimeout(() => cargarEstadisticasOptimizadas(), 500);
        }
        
        async function cargarEstadisticasOptimizadas() {
            console.log('üìä Cargando estad√≠sticas optimizadas...');
            
            try {
                // √öltimos 7 d√≠as
                const hoy = new Date();
                const hace7Dias = new Date();
                hace7Dias.setDate(hoy.getDate() - 7);
                
                const fechaInicio = hace7Dias.toISOString().split('T')[0];
                const fechaFin = hoy.toISOString().split('T')[0];
                
                // Cargar servicios
                const { data: servicios, error } = await supabase
                    .from('citas')
                    .select('*')
                    .eq('barberia_id', window.CURRENT_BARBERIA_ID)
                    .gte('fecha', fechaInicio)
                    .lte('fecha', fechaFin);
                
                if (error) throw error;
                
                if (!servicios || servicios.length === 0) {
                    mostrarSinDatos();
                    return;
                }
                
                console.log(`‚úÖ ${servicios.length} servicios para analizar`);
                
                // Procesar y mostrar cada secci√≥n
                mostrarTopServiciosOptimizado(servicios);
                mostrarMetodosPagoOptimizado(servicios);
                mostrarProductividadOptimizada(servicios);
                mostrarTendenciaOptimizada(servicios);
                mostrarInsightsOptimizados(servicios);
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                mostrarErrorEstadisticas();
            }
        }
        
       function mostrarTopServiciosOptimizado(servicios) {
            // Mostrar botones de filtro y contenido inicial
            const container = document.getElementById('topServicios');
            
            container.innerHTML = `
                <!-- Botones de Filtro -->
                <div class="flex flex-wrap gap-2 mb-4 justify-center">
                    <button onclick="filtrarTopServicios('7d')" id="btn-7d" class="filtro-btn filtro-activo px-3 py-1 text-sm rounded-full bg-blue-600 text-white font-medium hover:bg-blue-700 transition-colors">
                        7 d√≠as
                    </button>
                    <button onclick="filtrarTopServicios('30d')" id="btn-30d" class="filtro-btn px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700 font-medium hover:bg-gray-300 transition-colors">
                        30 d√≠as
                    </button>
                    <button onclick="filtrarTopServicios('3m')" id="btn-3m" class="filtro-btn px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700 font-medium hover:bg-gray-300 transition-colors">
                        3 meses
                    </button>
                    <button onclick="filtrarTopServicios('1y')" id="btn-1y" class="filtro-btn px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700 font-medium hover:bg-gray-300 transition-colors">
                        1 a√±o
                    </button>
                    <button onclick="filtrarTopServicios('todo')" id="btn-todo" class="filtro-btn px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700 font-medium hover:bg-gray-300 transition-colors">
                        Siempre
                    </button>
                </div>
                
                <!-- Contenedor del Gr√°fico -->
                <div id="graficoTopServicios">
                    <div class="text-center py-4">
                        <div class="loading-spinner mx-auto"></div>
                        <p class="mt-2 text-gray-600">Cargando servicios...</p>
                    </div>
                </div>
            `;
            
            // Cargar datos inicial (7 d√≠as)
            window.serviciosGlobalesStats = servicios; // Guardar para uso posterior
            filtrarTopServicios('7d');
        }
        
        async function filtrarTopServicios(periodo) {
            console.log(`üìä Filtrando top servicios por: ${periodo}`);
            
            // Actualizar estado visual de botones
            document.querySelectorAll('.filtro-btn').forEach(btn => {
                btn.classList.remove('filtro-activo', 'bg-blue-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            
            const btnActivo = document.getElementById(`btn-${periodo}`);
            if (btnActivo) {
                btnActivo.classList.add('filtro-activo', 'bg-blue-600', 'text-white');
                btnActivo.classList.remove('bg-gray-200', 'text-gray-700');
            }
            
            // Mostrar loading
            const container = document.getElementById('graficoTopServicios');
            container.innerHTML = `
                <div class="text-center py-4">
                    <div class="loading-spinner mx-auto"></div>
                    <p class="mt-2 text-gray-600">Analizando ${periodo === '7d' ? '7 d√≠as' : periodo === '30d' ? '30 d√≠as' : periodo === '3m' ? '3 meses' : periodo === '1y' ? '1 a√±o' : 'todos los datos'}...</p>
                </div>
            `;
            
            try {
                // Calcular fechas seg√∫n el per√≠odo
                const hoy = new Date();
                let fechaInicio;
                
                switch(periodo) {
                    case '7d':
                        fechaInicio = new Date();
                        fechaInicio.setDate(hoy.getDate() - 7);
                        break;
                    case '30d':
                        fechaInicio = new Date();
                        fechaInicio.setDate(hoy.getDate() - 30);
                        break;
                    case '3m':
                        fechaInicio = new Date();
                        fechaInicio.setMonth(hoy.getMonth() - 3);
                        break;
                    case '1y':
                        fechaInicio = new Date();
                        fechaInicio.setFullYear(hoy.getFullYear() - 1);
                        break;
                    case 'todo':
                        fechaInicio = new Date('2020-01-01'); // Fecha muy antigua
                        break;
                }
                
                const fechaFin = hoy.toISOString().split('T')[0];
                const fechaInicioStr = fechaInicio.toISOString().split('T')[0];
                
                console.log(`üìÖ Consultando desde ${fechaInicioStr} hasta ${fechaFin}`);
                
                // Cargar servicios del per√≠odo
                const { data: servicios, error } = await supabase
                    .from('citas')
                    .select('servicio_principal_nombre, monto_total')
                   .eq('barberia_id', window.CURRENT_BARBERIA_ID)
                    .gte('fecha', fechaInicioStr)
                    .lte('fecha', fechaFin);
                
                if (error) throw error;
                
                if (!servicios || servicios.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <div class="text-4xl mb-2">üìä</div>
                            <p>No hay servicios registrados en ${periodo === '7d' ? 'los √∫ltimos 7 d√≠as' : periodo === '30d' ? 'los √∫ltimos 30 d√≠as' : periodo === '3m' ? 'los √∫ltimos 3 meses' : periodo === '1y' ? 'el √∫ltimo a√±o' : 'el hist√≥rico'}</p>
                        </div>
                    `;
                    return;
                }
                
                // Procesar datos
                const conteoServicios = {};
                servicios.forEach(s => {
                    const servicio = s.servicio_principal_nombre;
                    conteoServicios[servicio] = (conteoServicios[servicio] || 0) + 1;
                });
                
                const top5 = Object.entries(conteoServicios)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5);
                
                if (top5.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <p>No hay datos suficientes para mostrar</p>
                        </div>
                    `;
                    return;
                }
                
                // Generar gr√°fico
                const maxCount = top5[0]?.[1] || 1;
                const totalServicios = servicios.length;
                
                let html = '<div class="space-y-3">';
                top5.forEach(([servicio, cantidad], index) => {
                    const porcentaje = Math.round((cantidad / totalServicios) * 100);
                    const barWidth = Math.round((cantidad / maxCount) * 100);
                    
                    // Colores diferentes para cada barra
                    const colores = [
                        'from-red-400 to-red-600',
                        'from-orange-400 to-orange-600', 
                        'from-yellow-400 to-yellow-600',
                        'from-green-400 to-green-600',
                        'from-blue-400 to-blue-600'
                    ];
                    const color = colores[index] || 'from-gray-400 to-gray-600';
                    
                    const nombreCorto = servicio.length > 25 ? servicio.substring(0, 25) + '...' : servicio;
                    
                    html += `
                        <div class="mb-3">
                            <div class="flex items-center justify-between mb-1">
                                <div class="text-sm font-medium text-gray-700 flex-1" title="${servicio}">
                                    ${nombreCorto}
                                </div>
                                <div class="text-sm font-bold text-gray-600 ml-2">${cantidad} (${porcentaje}%)</div>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                                <div class="bg-gradient-to-r ${color} h-4 rounded-full transition-all duration-1000 flex items-center justify-end pr-2" style="width: ${barWidth}%">
                                    <span class="text-xs text-white font-semibold">${cantidad}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                // Agregar resumen del per√≠odo
                html += `
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <div class="text-xs text-gray-500 text-center">
                            üìä Total analizado: <span class="font-semibold">${totalServicios} servicios</span> en 
                            <span class="font-semibold">${periodo === '7d' ? '7 d√≠as' : periodo === '30d' ? '30 d√≠as' : periodo === '3m' ? '3 meses' : periodo === '1y' ? '1 a√±o' : 'todo el hist√≥rico'}</span>
                        </div>
                    </div>
                `;
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('‚ùå Error filtrando servicios:', error);
                container.innerHTML = `
                    <div class="text-center py-4 text-red-600">
                        <div class="text-2xl mb-2">‚ö†Ô∏è</div>
                        <p>Error al cargar datos del per√≠odo</p>
                    </div>
                `;
            }
        }
        // DISTIBUI√ìN DE PAGOS
async function filtrarMetodosPago(periodo) {
    console.log(`üí≥ Filtrando m√©todos de pago por: ${periodo}`);
    
    // Actualizar estado visual de botones
    document.querySelectorAll('.filtro-pago-btn').forEach(btn => {
        btn.classList.remove('filtro-pago-activo', 'bg-blue-600', 'text-white');
        btn.classList.add('bg-gray-200', 'text-gray-700');
    });
    
    const btnActivo = document.getElementById(`btn-pago-${periodo}`);
    if (btnActivo) {
        btnActivo.classList.add('filtro-pago-activo', 'bg-blue-600', 'text-white');
        btnActivo.classList.remove('bg-gray-200', 'text-gray-700');
    }
    
    // Mostrar loading
    const container = document.getElementById('graficoMetodosPago');
    container.innerHTML = `
        <div class="text-center py-4">
            <div class="loading-spinner mx-auto"></div>
            <p class="mt-2 text-gray-600">Analizando ${periodo === '7d' ? '7 d√≠as' : periodo === '30d' ? '30 d√≠as' : periodo === '3m' ? '3 meses' : periodo === '1y' ? '1 a√±o' : 'todos los datos'}...</p>
        </div>
    `;
    
    try {
        // Calcular fechas seg√∫n el per√≠odo
        const hoy = new Date();
        let fechaInicio;
        
        switch(periodo) {
            case '7d':
                fechaInicio = new Date();
                fechaInicio.setDate(hoy.getDate() - 7);
                break;
            case '30d':
                fechaInicio = new Date();
                fechaInicio.setDate(hoy.getDate() - 30);
                break;
            case '3m':
                fechaInicio = new Date();
                fechaInicio.setMonth(hoy.getMonth() - 3);
                break;
            case '1y':
                fechaInicio = new Date();
                fechaInicio.setFullYear(hoy.getFullYear() - 1);
                break;
            case 'todo':
                fechaInicio = new Date('2020-01-01'); // Fecha muy antigua
                break;
        }
        
        const fechaFin = hoy.toISOString().split('T')[0];
        const fechaInicioStr = fechaInicio.toISOString().split('T')[0];
        
        console.log(`üìÖ Consultando m√©todos desde ${fechaInicioStr} hasta ${fechaFin}`);
        
        // Cargar servicios del per√≠odo
        const { data: servicios, error } = await supabase
            .from('citas')
            .select('forma_pago, monto_total')
            .eq('barberia_id', window.CURRENT_BARBERIA_ID)
            .gte('fecha', fechaInicioStr)
            .lte('fecha', fechaFin);
        
        if (error) throw error;
        
        if (!servicios || servicios.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <div class="text-4xl mb-2">üí≥</div>
                    <p>No hay pagos registrados en ${periodo === '7d' ? 'los √∫ltimos 7 d√≠as' : periodo === '30d' ? 'los √∫ltimos 30 d√≠as' : periodo === '3m' ? 'los √∫ltimos 3 meses' : periodo === '1y' ? 'el √∫ltimo a√±o' : 'el hist√≥rico'}</p>
                </div>
            `;
            return;
        }
        
        // Procesar datos de m√©todos de pago
        const metodos = {};
        let total = 0;
        
        servicios.forEach(s => {
            const metodo = s.forma_pago;
            const monto = parseFloat(s.monto_total || 0);
            metodos[metodo] = (metodos[metodo] || 0) + monto;
            total += monto;
        });
        
        if (total === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <p>No hay datos suficientes para mostrar</p>
                </div>
            `;
            return;
        }
        
        // Generar gr√°fico
        const colores = {
            'Efectivo': 'from-green-400 to-green-600',
            'Cuenta RUT': 'from-blue-400 to-blue-600',
            'Mercado Pago': 'from-purple-400 to-purple-600'
        };
        
        let html = '<div class="space-y-4">';
        Object.entries(metodos).forEach(([metodo, monto]) => {
            const porcentaje = Math.round((monto / total) * 100);
            const color = colores[metodo] || 'from-gray-400 to-gray-600';
            
            html += `
                <div class="bg-gradient-to-r ${color} text-white p-4 rounded-lg">
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="text-sm opacity-90">${metodo}</div>
                            <div class="text-xl font-bold">$${monto.toLocaleString('es-CL')}</div>
                        </div>
                        <div class="text-2xl font-bold">${porcentaje}%</div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        
        // Agregar resumen del per√≠odo
        html += `
            <div class="mt-4 pt-4 border-t border-gray-200">
                <div class="text-xs text-gray-500 text-center">
                    üí≥ Total analizado: <span class="font-semibold">$${total.toLocaleString('es-CL')}</span> en 
                    <span class="font-semibold">${periodo === '7d' ? '7 d√≠as' : periodo === '30d' ? '30 d√≠as' : periodo === '3m' ? '3 meses' : periodo === '1y' ? '1 a√±o' : 'todo el hist√≥rico'}</span>
                </div>
            </div>
        `;
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('‚ùå Error filtrando m√©todos de pago:', error);
        container.innerHTML = `
            <div class="text-center py-4 text-red-600">
                <div class="text-2xl mb-2">‚ö†Ô∏è</div>
                <p>Error al cargar datos del per√≠odo</p>
            </div>
        `;
    }
}
async function filtrarProductividad(periodo) {
    console.log(`üë®‚Äçüíº Filtrando productividad por: ${periodo}`);
    
    // Actualizar estado visual de botones
    document.querySelectorAll('.filtro-productividad-btn').forEach(btn => {
        btn.classList.remove('filtro-productividad-activo', 'bg-blue-600', 'text-white');
        btn.classList.add('bg-gray-200', 'text-gray-700');
    });
    
    const btnActivo = document.getElementById(`btn-prod-${periodo}`);
    if (btnActivo) {
        btnActivo.classList.add('filtro-productividad-activo', 'bg-blue-600', 'text-white');
        btnActivo.classList.remove('bg-gray-200', 'text-gray-700');
    }
    
    // Mostrar loading
    const container = document.getElementById('graficoProductividad');
    container.innerHTML = `
        <div class="text-center py-4">
            <div class="loading-spinner mx-auto"></div>
            <p class="mt-2 text-gray-600">Analizando ${periodo === '7d' ? '7 d√≠as' : periodo === '30d' ? '30 d√≠as' : periodo === '3m' ? '3 meses' : periodo === '1y' ? '1 a√±o' : 'todos los datos'}...</p>
        </div>
    `;
    
    try {
        // Calcular fechas seg√∫n el per√≠odo
        const hoy = new Date();
        let fechaInicio;
        
        switch(periodo) {
            case '7d':
                fechaInicio = new Date();
                fechaInicio.setDate(hoy.getDate() - 7);
                break;
            case '30d':
                fechaInicio = new Date();
                fechaInicio.setDate(hoy.getDate() - 30);
                break;
            case '3m':
                fechaInicio = new Date();
                fechaInicio.setMonth(hoy.getMonth() - 3);
                break;
            case '1y':
                fechaInicio = new Date();
                fechaInicio.setFullYear(hoy.getFullYear() - 1);
                break;
            case 'todo':
                fechaInicio = new Date('2020-01-01'); // Fecha muy antigua
                break;
        }
        
        const fechaFin = hoy.toISOString().split('T')[0];
        const fechaInicioStr = fechaInicio.toISOString().split('T')[0];
        
        console.log(`üìÖ Consultando productividad desde ${fechaInicioStr} hasta ${fechaFin}`);
        
        // Cargar servicios del per√≠odo
        const { data: servicios, error } = await supabase
            .from('citas')
            .select('realizado_por_id, monto_total, usuarios!inner(nombre)')
            .eq('barberia_id', window.CURRENT_BARBERIA_ID)
            .gte('fecha', fechaInicioStr)
            .lte('fecha', fechaFin)
            .eq('usuarios.activo', true);
        
        if (error) throw error;
        
        if (!servicios || servicios.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <div class="text-4xl mb-2">üë®‚Äçüíº</div>
                    <p>No hay servicios registrados en ${periodo === '7d' ? 'los √∫ltimos 7 d√≠as' : periodo === '30d' ? 'los √∫ltimos 30 d√≠as' : periodo === '3m' ? 'los √∫ltimos 3 meses' : periodo === '1y' ? 'el √∫ltimo a√±o' : 'el hist√≥rico'}</p>
                </div>
            `;
            return;
        }
        
        // Procesar datos de productividad
       const barberos = {};
servicios.forEach(s => {
    const barberoId = s.realizado_por_id;
    const barberoNombre = s.usuarios.nombre;
    
    if (!barberos[barberoId]) {
        barberos[barberoId] = { 
            nombre: barberoNombre, 
            servicios: 0, 
            monto: 0 
        };
    }
    barberos[barberoId].servicios++;
    barberos[barberoId].monto += parseFloat(s.monto_total || 0);
});
        
        if (Object.keys(barberos).length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <p>No hay datos suficientes para mostrar</p>
                </div>
            `;
            return;
        }
        
        // Ordenar por n√∫mero de servicios
        const barberosArray = Object.entries(barberos)
            .sort(([,a], [,b]) => b.servicios - a.servicios);
        
        // Generar gr√°fico
        const coloresBarberos = [
            'from-blue-500 to-indigo-600', 
            'from-green-500 to-teal-600', 
            'from-purple-500 to-pink-600',
            'from-orange-500 to-red-600',
            'from-yellow-500 to-orange-600'
        ];
        
        let html = '<div class="space-y-3">';
       barberosArray.forEach(([barberoId, data], index) => {
            const porcentajeServicios = Math.round((data.servicios / servicios.length) * 100);
            const promedioPorServicio = Math.round(data.monto / data.servicios);
            const color = coloresBarberos[index] || 'from-gray-500 to-gray-600';
            
            html += `
                <div class="bg-gradient-to-r ${color} text-white p-4 rounded-lg">
                    <div class="flex justify-between items-start">
                        <div>
                           <div class="font-bold text-lg">${data.nombre}</div>
                            <div class="text-sm opacity-90">${data.servicios} servicios (${porcentajeServicios}%)</div>
                            <div class="text-sm opacity-90">Promedio: $${promedioPorServicio.toLocaleString('es-CL')}/servicio</div>
                        </div>
                        <div class="text-right">
                            <div class="text-xl font-bold">$${data.monto.toLocaleString('es-CL')}</div>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        
        // Agregar resumen del per√≠odo
        const totalServicios = servicios.length;
        const totalMonto = servicios.reduce((sum, s) => sum + parseFloat(s.monto_total || 0), 0);
        
        html += `
            <div class="mt-4 pt-4 border-t border-gray-200">
                <div class="text-xs text-gray-500 text-center">
                    üë®‚Äçüíº Total analizado: <span class="font-semibold">${totalServicios} servicios</span> - 
                    <span class="font-semibold">$${totalMonto.toLocaleString('es-CL')}</span> en 
                    <span class="font-semibold">${periodo === '7d' ? '7 d√≠as' : periodo === '30d' ? '30 d√≠as' : periodo === '3m' ? '3 meses' : periodo === '1y' ? '1 a√±o' : 'todo el hist√≥rico'}</span>
                </div>
            </div>
        `;
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('‚ùå Error filtrando productividad:', error);
        container.innerHTML = `
            <div class="text-center py-4 text-red-600">
                <div class="text-2xl mb-2">‚ö†Ô∏è</div>
                <p>Error al cargar datos del per√≠odo</p>
            </div>
        `;
    }
}
        async function filtrarTendencia(periodo) {
    console.log(`üìÖ Filtrando tendencia por: ${periodo}`);
    
    // Actualizar estado visual de botones
    document.querySelectorAll('.filtro-tendencia-btn').forEach(btn => {
        btn.classList.remove('filtro-tendencia-activo', 'bg-blue-600', 'text-white');
        btn.classList.add('bg-gray-200', 'text-gray-700');
    });
    
    const btnActivo = document.getElementById(`btn-tend-${periodo}`);
    if (btnActivo) {
        btnActivo.classList.add('filtro-tendencia-activo', 'bg-blue-600', 'text-white');
        btnActivo.classList.remove('bg-gray-200', 'text-gray-700');
    }
    
    // Mostrar loading
    const container = document.getElementById('graficoTendencia');
    container.innerHTML = `
        <div class="text-center py-4">
            <div class="loading-spinner mx-auto"></div>
            <p class="mt-2 text-gray-600">Analizando ${periodo === '7d' ? '7 d√≠as' : periodo === '30d' ? '30 d√≠as' : periodo === '3m' ? '3 meses' : periodo === '1y' ? '1 a√±o' : 'todos los datos'}...</p>
        </div>
    `;
    
    try {
        // Calcular fechas seg√∫n el per√≠odo
        const hoy = new Date();
        let fechaInicio;
        
        switch(periodo) {
            case '7d':
                fechaInicio = new Date();
                fechaInicio.setDate(hoy.getDate() - 7);
                break;
            case '30d':
                fechaInicio = new Date();
                fechaInicio.setDate(hoy.getDate() - 30);
                break;
            case '3m':
                fechaInicio = new Date();
                fechaInicio.setMonth(hoy.getMonth() - 3);
                break;
            case '1y':
                fechaInicio = new Date();
                fechaInicio.setFullYear(hoy.getFullYear() - 1);
                break;
            case 'todo':
                fechaInicio = new Date('2020-01-01'); // Fecha muy antigua
                break;
        }
        
        const fechaFin = hoy.toISOString().split('T')[0];
        const fechaInicioStr = fechaInicio.toISOString().split('T')[0];
        
        console.log(`üìÖ Consultando tendencia desde ${fechaInicioStr} hasta ${fechaFin}`);
        
        // Cargar servicios del per√≠odo
        const { data: servicios, error } = await supabase
            .from('citas')
            .select('fecha, monto_total')
            .eq('barberia_id', window.CURRENT_BARBERIA_ID)
            .gte('fecha', fechaInicioStr)
            .lte('fecha', fechaFin)
            .order('fecha', { ascending: true });
        
        if (error) throw error;
        
        if (!servicios || servicios.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <div class="text-4xl mb-2">üìÖ</div>
                    <p>No hay ingresos registrados en ${periodo === '7d' ? 'los √∫ltimos 7 d√≠as' : periodo === '30d' ? 'los √∫ltimos 30 d√≠as' : periodo === '3m' ? 'los √∫ltimos 3 meses' : periodo === '1y' ? 'el √∫ltimo a√±o' : 'el hist√≥rico'}</p>
                </div>
            `;
            return;
        }
        
        // Procesar datos por d√≠a
        const porDia = {};
        servicios.forEach(s => {
            const fecha = s.fecha;
            if (!porDia[fecha]) {
                porDia[fecha] = { servicios: 0, monto: 0 };
            }
            porDia[fecha].servicios++;
            porDia[fecha].monto += parseFloat(s.monto_total || 0);
        });
        
        // Convertir a array y ordenar por fecha
        const dias = Object.entries(porDia)
            .sort(([a], [b]) => a.localeCompare(b))
            .map(([fecha, data]) => ({
                fecha,
                dia: new Date(fecha + 'T00:00:00').toLocaleDateString('es-CL', { 
                    weekday: 'short', 
                    day: 'numeric',
                    month: 'short'
                }),
                servicios: data.servicios,
                monto: data.monto
            }));
        
        if (dias.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <p>No hay datos suficientes para mostrar tendencias</p>
                </div>
            `;
            return;
        }
        
        // Generar gr√°fico de barras por d√≠a
        const maxMonto = Math.max(...dias.map(d => d.monto));
        
        let html = '<div class="space-y-2">';
        dias.forEach(dia => {
            const altura = maxMonto > 0 ? Math.round((dia.monto / maxMonto) * 100) : 0;
            const intensidad = altura > 80 ? 'from-red-400 to-red-600' : 
                              altura > 60 ? 'from-orange-400 to-orange-600' :
                              altura > 40 ? 'from-yellow-400 to-yellow-600' : 
                              altura > 20 ? 'from-green-400 to-green-600' : 'from-gray-400 to-gray-500';
            
            const montoK = dia.monto >= 1000 ? `$${Math.round(dia.monto/1000)}k` : `$${Math.round(dia.monto)}`;
            
            html += `
                <div class="flex items-center space-x-3">
                    <div class="w-20 text-sm font-medium text-gray-700 text-right">${dia.dia}</div>
                    <div class="flex-1 bg-gray-200 rounded-full h-8 relative min-w-0">
                        <div class="bg-gradient-to-r ${intensidad} h-8 rounded-full transition-all duration-1000 min-w-max" style="width: ${Math.max(altura, 15)}%"></div>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span class="text-xs font-bold text-white px-2">${dia.servicios} serv - ${montoK}</span>
                        </div>
                    </div>
                    <div class="w-24 text-right text-sm font-semibold text-gray-800">
                        $${dia.monto.toLocaleString('es-CL')}
                    </div>
                </div>
            `;
        });
        html += '</div>';
        
        // Agregar resumen del per√≠odo
        const totalDias = dias.length;
        const totalMonto = dias.reduce((sum, d) => sum + d.monto, 0);
        const totalServicios = dias.reduce((sum, d) => sum + d.servicios, 0);
        const promedioDiario = Math.round(totalMonto / totalDias);
        
        html += `
            <div class="mt-4 pt-4 border-t border-gray-200">
                <div class="text-xs text-gray-500 text-center">
                    üìÖ Per√≠odo analizado: <span class="font-semibold">${totalDias} d√≠as</span> - 
                    <span class="font-semibold">${totalServicios} servicios</span> - 
                    <span class="font-semibold">$${totalMonto.toLocaleString('es-CL')}</span><br>
                    üí∞ Promedio diario: <span class="font-semibold">$${promedioDiario.toLocaleString('es-CL')}</span>
                </div>
            </div>
        `;
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('‚ùå Error filtrando tendencia:', error);
        container.innerHTML = `
            <div class="text-center py-4 text-red-600">
                <div class="text-2xl mb-2">‚ö†Ô∏è</div>
                <p>Error al cargar datos del per√≠odo</p>
            </div>
        `;
    }
}
        // Mostrar M√©todos de pago
      function mostrarMetodosPagoOptimizado(servicios) {
    // Mostrar botones de filtro y contenido inicial
    const container = document.getElementById('metodosPago');
    
    container.innerHTML = `
        <!-- Botones de Filtro -->
        <div class="flex flex-wrap gap-2 mb-4 justify-center">
            <button onclick="filtrarMetodosPago('7d')" id="btn-pago-7d" class="filtro-pago-btn filtro-pago-activo px-3 py-1 text-sm rounded-full bg-blue-600 text-white font-medium hover:bg-blue-700 transition-colors">
                7 d√≠as
            </button>
            <button onclick="filtrarMetodosPago('30d')" id="btn-pago-30d" class="filtro-pago-btn px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700 font-medium hover:bg-gray-300 transition-colors">
                30 d√≠as
            </button>
            <button onclick="filtrarMetodosPago('3m')" id="btn-pago-3m" class="filtro-pago-btn px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700 font-medium hover:bg-gray-300 transition-colors">
                3 meses
            </button>
            <button onclick="filtrarMetodosPago('1y')" id="btn-pago-1y" class="filtro-pago-btn px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700 font-medium hover:bg-gray-300 transition-colors">
                1 a√±o
            </button>
            <button onclick="filtrarMetodosPago('todo')" id="btn-pago-todo" class="filtro-pago-btn px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700 font-medium hover:bg-gray-300 transition-colors">
                Siempre
            </button>
        </div>
        
        <!-- Contenedor del Gr√°fico -->
        <div id="graficoMetodosPago">
            <div class="text-center py-4">
                <div class="loading-spinner mx-auto"></div>
                <p class="mt-2 text-gray-600">Cargando m√©todos...</p>
            </div>
        </div>
    `;
    
    // Guardar servicios para filtros y cargar datos inicial (7 d√≠as)
    window.serviciosGlobalesMetodos = servicios;
    filtrarMetodosPago('7d');
}
        // PRODUCTIVIDAD POR BARBERO
        
      function mostrarProductividadOptimizada(servicios) {
    // Mostrar botones de filtro y contenido inicial
    const container = document.getElementById('productividadBarberos');
    
    container.innerHTML = `
        <!-- Botones de Filtro -->
        <div class="flex flex-wrap gap-2 mb-4 justify-center">
            <button onclick="filtrarProductividad('7d')" id="btn-prod-7d" class="filtro-productividad-btn filtro-productividad-activo px-3 py-1 text-sm rounded-full bg-blue-600 text-white font-medium hover:bg-blue-700 transition-colors">
                7 d√≠as
            </button>
            <button onclick="filtrarProductividad('30d')" id="btn-prod-30d" class="filtro-productividad-btn px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700 font-medium hover:bg-gray-300 transition-colors">
                30 d√≠as
            </button>
            <button onclick="filtrarProductividad('3m')" id="btn-prod-3m" class="filtro-productividad-btn px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700 font-medium hover:bg-gray-300 transition-colors">
                3 meses
            </button>
            <button onclick="filtrarProductividad('1y')" id="btn-prod-1y" class="filtro-productividad-btn px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700 font-medium hover:bg-gray-300 transition-colors">
                1 a√±o
            </button>
            <button onclick="filtrarProductividad('todo')" id="btn-prod-todo" class="filtro-productividad-btn px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700 font-medium hover:bg-gray-300 transition-colors">
                Siempre
            </button>
        </div>
        
        <!-- Contenedor del Gr√°fico -->
        <div id="graficoProductividad">
            <div class="text-center py-4">
                <div class="loading-spinner mx-auto"></div>
                <p class="mt-2 text-gray-600">Midiendo rendimiento...</p>
            </div>
        </div>
    `;
    
    // Guardar servicios para filtros y cargar datos inicial (7 d√≠as)
    window.serviciosGlobalesProductividad = servicios;
    filtrarProductividad('7d');
}
        
      function mostrarTendenciaOptimizada(servicios) {
    // Mostrar botones de filtro y contenido inicial
    const container = document.getElementById('tendenciaSemanal');
    
    container.innerHTML = `
        <!-- Botones de Filtro -->
        <div class="flex flex-wrap gap-2 mb-4 justify-center">
            <button onclick="filtrarTendencia('7d')" id="btn-tend-7d" class="filtro-tendencia-btn filtro-tendencia-activo px-3 py-1 text-sm rounded-full bg-blue-600 text-white font-medium hover:bg-blue-700 transition-colors">
                7 d√≠as
            </button>
            <button onclick="filtrarTendencia('30d')" id="btn-tend-30d" class="filtro-tendencia-btn px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700 font-medium hover:bg-gray-300 transition-colors">
                30 d√≠as
            </button>
            <button onclick="filtrarTendencia('3m')" id="btn-tend-3m" class="filtro-tendencia-btn px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700 font-medium hover:bg-gray-300 transition-colors">
                3 meses
            </button>
            <button onclick="filtrarTendencia('1y')" id="btn-tend-1y" class="filtro-tendencia-btn px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700 font-medium hover:bg-gray-300 transition-colors">
                1 a√±o
            </button>
            <button onclick="filtrarTendencia('todo')" id="btn-tend-todo" class="filtro-tendencia-btn px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700 font-medium hover:bg-gray-300 transition-colors">
                Siempre
            </button>
        </div>
        
        <!-- Contenedor del Gr√°fico -->
        <div id="graficoTendencia">
            <div class="text-center py-4">
                <div class="loading-spinner mx-auto"></div>
                <p class="mt-2 text-gray-600">Analizando tendencias...</p>
            </div>
        </div>
    `;
    
    // Guardar servicios para filtros y cargar datos inicial (7 d√≠as)
    window.serviciosGlobalesTendencia = servicios;
    filtrarTendencia('7d');
}
        
        function mostrarInsightsOptimizados(servicios) {
            // Calcular insights
            const totalMonto = servicios.reduce((sum, s) => sum + parseFloat(s.monto_total || 0), 0);
            const promedioServicio = Math.round(totalMonto / servicios.length);
            
            // D√≠a con m√°s servicios
            const porDia = {};
            servicios.forEach(s => {
                porDia[s.fecha] = (porDia[s.fecha] || 0) + 1;
            });
            
            const mejorDia = Object.entries(porDia)
                .sort(([,a], [,b]) => b - a)[0];
            
            const diaNombre = mejorDia ? new Date(mejorDia[0] + 'T00:00:00').toLocaleDateString('es-CL', { weekday: 'long' }) : 'N/A';
            
            // Servicio m√°s popular
            const serviciosCount = {};
            servicios.forEach(s => {
                serviciosCount[s.servicio_principal_nombre] = (serviciosCount[s.servicio_principal_nombre] || 0) + 1;
            });
            
            const servicioTop = Object.entries(serviciosCount)
                .sort(([,a], [,b]) => b - a)[0];
            
            // Barbero m√°s productivo
            const barberoStats = {};
            servicios.forEach(s => {
                barberoStats[s.realizado_por_nombre] = (barberoStats[s.realizado_por_nombre] || 0) + 1;
            });
            
            const topBarbero = Object.entries(barberoStats)
                .sort(([,a], [,b]) => b - a)[0];
            
            const insights = [
                `üí∞ Ticket promedio por servicio: $${promedioServicio.toLocaleString('es-CL')}`,
                `üóìÔ∏è Tu mejor d√≠a de la semana es: ${diaNombre} (${mejorDia?.[1] || 0} servicios)`,
                `üî• Servicio estrella: "${servicioTop?.[0] || 'N/A'}" (${servicioTop?.[1] || 0} veces)`,
                `üèÜ Barbero m√°s activo: ${topBarbero?.[0] || 'N/A'} (${topBarbero?.[1] || 0} servicios)`
            ];
            
            let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
            insights.forEach(insight => {
                html += `
                    <div class="bg-white bg-opacity-20 p-4 rounded-lg">
                        <div class="text-white font-medium">${insight}</div>
                    </div>
                `;
            });
            html += '</div>';
            
            document.getElementById('insightsInteligentes').innerHTML = html;
        }
        
        function mostrarSinDatos() {
            const elementos = ['topServicios', 'metodosPago', 'productividadBarberos', 'tendenciaSemanal', 'insightsInteligentes'];
            elementos.forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento) {
                    elemento.innerHTML = '<div class="text-center py-8 text-gray-500">üìä Sin datos suficientes para mostrar estad√≠sticas</div>';
                }
            });
        }
        // ===============================
// PESTA√ëA: AGENDA
// ===============================
function loadAgenda() {
    console.log('üìÖ Cargando agenda...');
    
    document.getElementById('contentArea').innerHTML = `
        <div class="max-w-5xl mx-auto">
            <h2 class="text-2xl font-bold mb-6">
                <i class="fas fa-calendar-alt mr-2"></i>Agenda de Citas
            </h2>
            
            ${userRole === 'admin' ? `
            <!-- Filtro de Barbero (solo admin) -->
            <div class="mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Filtrar por Barbero:</label>
                        <select id="selectBarberoAgenda" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="cargarCitasAgenda()">
                            <option value="todos">Ver Todas las Citas</option>
                            <option value="mi">Mis Citas</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Per√≠odo:</label>
                        <select id="periodoAgenda" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="cargarCitasAgenda()">
                            <option value="proximas">Pr√≥ximas Citas</option>
                            <option value="hoy">Solo Hoy</option>
                            <option value="semana">Esta Semana</option>
                            <option value="mes">Este Mes</option>
                            <option value="todas">Todas</option>
                        </select>
                    </div>
                </div>
            </div>
            ` : `
            <!-- Empleado: Solo per√≠odo -->
            <div class="mb-6">
                <div class="max-w-md">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Ver mis citas:</label>
                    <select id="periodoAgenda" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="cargarCitasAgenda()">
                        <option value="proximas">Pr√≥ximas Citas</option>
                        <option value="hoy">Solo Hoy</option>
                        <option value="semana">Esta Semana</option>
                        <option value="mes">Este Mes</option>
                        <option value="todas">Todas</option>
                    </select>
                </div>
            </div>
            `}
            
            <!-- Contenedor de Citas -->
            <div id="contenidoAgenda" class="mt-6">
                <div class="text-center py-8">
                    <div class="loading-spinner mx-auto"></div>
                    <p class="mt-4 text-gray-600">Cargando citas...</p>
                </div>
            </div>
        </div>
    `;
    
    // Cargar barberos para filtro si es admin
    if (userRole === 'admin') {
        cargarBarberosEnFiltroAgenda();
    }
    
   // Cargar citas inicial
cargarCitasAgenda();

// Auto-refresh cada 30 segundos
if (window.agendaInterval) {
    clearInterval(window.agendaInterval);
}
window.agendaInterval = setInterval(() => {
    console.log('üîÑ Auto-refresh agenda...');
    cargarCitasAgenda();
}, 30000); // 30 segundos
}

async function cargarBarberosEnFiltroAgenda() {
    try {
        console.log('üîç Cargando barberos para filtro agenda...');
        
        const { data: barberos, error } = await supabase
            .from('usuarios')
            .select('id, nombre')
            .eq('barberia_id', window.CURRENT_BARBERIA_ID)
            .eq('activo', true);
        
        if (error) throw error;
        
        const select = document.getElementById('selectBarberoAgenda');
        if (!select) return;
        
        // Limpiar opciones actuales (mantener las 2 primeras)
        while (select.children.length > 2) {
            select.removeChild(select.lastChild);
        }
        
        // Agregar todos los barberos din√°micamente
        barberos.forEach(barbero => {
            if (barbero.id !== currentUser.id) {  // No agregar al usuario actual
                const option = document.createElement('option');
                option.value = barbero.id;
                option.textContent = barbero.nombre;
                select.appendChild(option);
            }
        });
        
    } catch (error) {
        console.error('‚ùå Error cargando barberos:', error);
    }
}

async function cargarCitasAgenda() {
    const contenido = document.getElementById('contenidoAgenda');
    if (!contenido) return;
    
    contenido.innerHTML = '<div class="text-center py-8"><div class="loading-spinner mx-auto"></div><p class="mt-4 text-gray-600">üìÖ Cargando citas...</p></div>';
    
    try {
        console.log('üìÖ Cargando citas de agenda...');
        
        // Obtener filtros
        const periodo = document.getElementById('periodoAgenda').value;
        const filtro = document.getElementById('selectBarberoAgenda')?.value || 'mi';
        
        // Calcular fechas seg√∫n per√≠odo
        const hoy = new Date();
        let fechaDesde, fechaHasta;
        
        switch(periodo) {
            case 'hoy':
                fechaDesde = hoy.toISOString().split('T')[0];
                fechaHasta = hoy.toISOString().split('T')[0];
                break;
            case 'proximas':
                fechaDesde = hoy.toISOString().split('T')[0];
                const en30Dias = new Date(hoy);
                en30Dias.setDate(hoy.getDate() + 30);
                fechaHasta = en30Dias.toISOString().split('T')[0];
                break;
            case 'semana':
                const inicioSemana = new Date(hoy);
                inicioSemana.setDate(hoy.getDate() - hoy.getDay() + 1); // Lunes
                const finSemana = new Date(inicioSemana);
                finSemana.setDate(inicioSemana.getDate() + 6); // Domingo
                fechaDesde = inicioSemana.toISOString().split('T')[0];
                fechaHasta = finSemana.toISOString().split('T')[0];
                break;
            case 'mes':
                fechaDesde = new Date(hoy.getFullYear(), hoy.getMonth(), 1).toISOString().split('T')[0];
                fechaHasta = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0).toISOString().split('T')[0];
                break;
            case 'todas':
                fechaDesde = '2024-01-01'; // Fecha muy antigua
                fechaHasta = new Date(hoy.getFullYear() + 1, 11, 31).toISOString().split('T')[0]; // A√±o siguiente
                break;
        }
        
        console.log(`üìä Buscando citas desde ${fechaDesde} hasta ${fechaHasta}`);
        
        // Simular carga desde Formspree (por ahora datos demo)
        const citasReales = await obtenerCitasDesdeSupabase(fechaDesde, fechaHasta, filtro);
        
        mostrarCitasAgenda(citasReales, periodo);
        
    } catch (error) {
        console.error('‚ùå Error cargando citas:', error);
        contenido.innerHTML = '<div class="bg-red-100 p-4 rounded-lg text-red-700 text-center">‚ùå Error al cargar las citas</div>';
    }
}

async function obtenerCitasDesdeSupabase(fechaDesde, fechaHasta, filtro) {
    console.log('üîÑ Cargando citas reales desde Supabase...');
    
    try {
        // Construir query base
        let query = supabase
            .from('reservas')
            .select(`
                *,
                usuarios!barbero_id(nombre)
            `)
            .eq('barberia_id', window.CURRENT_BARBERIA_ID)
            .gte('fecha', fechaDesde)
            .lte('fecha', fechaHasta)
            .order('fecha', { ascending: true })
            .order('hora', { ascending: true });
        
        // Aplicar filtro seg√∫n rol y selecci√≥n
        if (userRole === 'empleado') {
            // Empleado: solo SUS citas
            query = query.eq('barbero_id', currentUser.id);
        } else if (userRole === 'admin') {
            // Admin: aplicar filtro seleccionado
            if (filtro === 'mi') {
                query = query.eq('barbero_id', currentUser.id);
            } else if (filtro !== 'todos') {
                query = query.eq('barbero_id', filtro);
            }
            // Si es 'todos', no agregar filtro (mostrar todas)
        }
        
        const { data: reservas, error } = await query;
        
        if (error) {
            console.error('‚ùå Error cargando reservas:', error);
            throw error;
        }
        
        console.log(`‚úÖ ${reservas?.length || 0} reservas cargadas desde Supabase`);
        
        // Convertir formato Supabase al formato esperado por la agenda
        const citasFormateadas = (reservas || []).map(reserva => ({
            fecha: reserva.fecha,
            hora: reserva.hora,
            cliente_nombre: reserva.cliente_nombre,
            cliente_telefono: reserva.cliente_telefono,
            cliente_email: reserva.cliente_email,
            barbero_nombre: reserva.barbero_nombre,
            barbero_id: reserva.barbero_id,
            notas: reserva.notas,
            barberia_nombre: window.CURRENT_BARBERIA_DATA?.nombre || 'Barber√≠a',
            estado: reserva.estado,
            id: reserva.id // Para futuras acciones
        }));
        
        return citasFormateadas;
        
    } catch (error) {
        console.error('‚ùå Error cr√≠tico cargando citas:', error);
        return []; // Devolver array vac√≠o en caso de error
    }
}
function mostrarCitasAgenda(citas, periodo) {
    const contenido = document.getElementById('contenidoAgenda');
    
    if (!citas || citas.length === 0) {
        const mensajePeriodo = {
            'hoy': 'hoy',
            'proximas': 'pr√≥ximas',
            'semana': 'esta semana',
            'mes': 'este mes',
            'todas': 'en el hist√≥rico'
        };
        
        contenido.innerHTML = `
            <div class="text-center py-12">
                <i class="fas fa-calendar-times text-6xl text-gray-300 mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-600 mb-2">No hay citas ${mensajePeriodo[periodo] || ''}</h3>
                <p class="text-gray-500">Las citas aparecer√°n aqu√≠ cuando los clientes hagan reservas</p>
            </div>
        `;
        return;
    }
    
    // Ordenar citas por fecha y hora
    citas.sort((a, b) => {
        const fechaA = new Date(a.fecha + 'T' + a.hora);
        const fechaB = new Date(b.fecha + 'T' + b.hora);
        return fechaA - fechaB;
    });
    
    let html = `
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4">
                <h3 class="text-lg font-bold flex items-center">
                    <i class="fas fa-calendar-check mr-2"></i>
                    ${userRole === 'empleado' ? 'Mis Citas Agendadas' : 'Citas Agendadas'}
                    <span class="ml-auto bg-white bg-opacity-20 px-3 py-1 rounded-full text-sm">${citas.length} cita${citas.length !== 1 ? 's' : ''}</span>
                </h3>
            </div>
            
            <div class="divide-y divide-gray-200">
    `;
    
    citas.forEach((cita, index) => {
        const fechaObj = new Date(cita.fecha + 'T00:00:00');
        const fechaFormateada = fechaObj.toLocaleDateString('es-CL', {
            weekday: 'long',
            day: 'numeric',
            month: 'long',
            year: 'numeric'
        });
        
        // Determinar si la cita es hoy, pasada o futura
        const hoy = new Date().toISOString().split('T')[0];
        let estadoColor = '';
        let estadoIcon = '';
        
        if (cita.fecha === hoy) {
            estadoColor = 'bg-green-50 border-l-4 border-l-green-500';
            estadoIcon = 'üü¢';
        } else if (cita.fecha < hoy) {
            estadoColor = 'bg-gray-50 border-l-4 border-l-gray-400';
            estadoIcon = '‚ö´';
        } else {
            estadoColor = 'bg-blue-50 border-l-4 border-l-blue-500';
            estadoIcon = 'üîµ';
        }
        
        html += `
            <div class="p-6 hover:bg-gray-50 transition-colors ${estadoColor}">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                    <div class="flex-1">
                        <!-- Header de la cita -->
                        <div class="flex items-center mb-3">
                            <span class="text-2xl mr-3">${estadoIcon}</span>
                            <div>
                                <h4 class="text-lg font-bold text-gray-800">${cita.cliente_nombre}</h4>
                                <p class="text-sm text-gray-500 capitalize">${fechaFormateada}</p>
                            </div>
                        </div>
                        
                        <!-- Detalles -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                            <div class="flex items-center text-gray-700">
                                <i class="fas fa-clock w-4 mr-2 text-blue-500"></i>
                                <span class="font-semibold">${cita.hora}</span>
                            </div>
                            
                            <div class="flex items-center text-gray-700">
                                <i class="fas fa-phone w-4 mr-2 text-green-500"></i>
                                <span>${cita.cliente_telefono}</span>
                            </div>
                            
                            ${userRole === 'admin' ? `
                            <div class="flex items-center text-gray-700">
                                <i class="fas fa-user-tie w-4 mr-2 text-purple-500"></i>
                                <span>${cita.barbero_nombre}</span>
                            </div>
                            ` : ''}
                            
                            ${cita.cliente_email ? `
                            <div class="flex items-center text-gray-700">
                                <i class="fas fa-envelope w-4 mr-2 text-orange-500"></i>
                                <span>${cita.cliente_email}</span>
                            </div>
                            ` : ''}
                        </div>
                        
                        <!-- Notas -->
                        ${cita.notas ? `
                        <div class="mt-3 p-3 bg-white rounded-lg border border-gray-200">
                            <div class="flex items-start">
                                <i class="fas fa-sticky-note w-4 mr-2 text-yellow-500 mt-0.5"></i>
                                <span class="text-sm text-gray-700">${cita.notas}</span>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- Acciones -->
                    <div class="mt-4 md:mt-0 md:ml-6 flex space-x-2">
                        <button onclick="window.open('tel:${cita.cliente_telefono}')" class="bg-green-500 text-white px-3 py-2 rounded-lg hover:bg-green-600 transition-colors">
                            <i class="fas fa-phone mr-1"></i>Llamar
                        </button>
                        ${cita.cliente_email ? `
                        <button onclick="window.open('mailto:${cita.cliente_email}')" class="bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                            <i class="fas fa-envelope mr-1"></i>Email
                        </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    });
    
    html += `
            </div>
            
            <!-- Footer -->
            <div class="bg-gray-50 px-6 py-4 text-center">
                <p class="text-sm text-gray-600">
                    üí° Las citas se actualizan autom√°ticamente cuando los clientes reservan online
                </p>
            </div>
        </div>
    `;
    
    contenido.innerHTML = html;
}
        
        function mostrarErrorEstadisticas() {
            const elementos = ['topServicios', 'metodosPago', 'productividadBarberos', 'tendenciaSemanal', 'insightsInteligentes'];
            elementos.forEach(id => {
                const elemento = document.getElementById(id);
                if (elemento) {
                    elemento.innerHTML = '<div class="text-center py-4 text-red-600">‚ùå Error al cargar estad√≠sticas</div>';
                }
            });
        }
        
// ===============================
// PESTA√ëA: CONFIGURACI√ìN
// ===============================
        function abrirMercadoPago() {
    window.open('https://link.mercadopago.cl/australprints3d', '_blank');
}

function confirmarPagoWhatsApp() {
    const nombreBarberia = window.CURRENT_BARBERIA_DATA.nombre || 'mi barber√≠a';
    const mensaje = `Hola, soy ${nombreBarberia}. Ya realic√© el pago de $15.000 para la mensualidad del sistema.`;
    const urlWhatsApp = `https://wa.me/56922050705?text=${encodeURIComponent(mensaje)}`;
    window.open(urlWhatsApp, '_blank');
}
        
function loadConfiguracion() {
    console.log('‚öôÔ∏è Cargando configuraci√≥n...');
    
    // Verificar que sea admin
    if (userRole !== 'admin') {
        document.getElementById('contentArea').innerHTML = '<div class="text-red-600">‚ùå Sin permisos de administrador</div>';
        return;
    }
    
    const barberiaData = window.CURRENT_BARBERIA_DATA;
    
    document.getElementById('contentArea').innerHTML = `
        <div class="max-w-4xl mx-auto space-y-6">
            
            <!-- Card de Suscripci√≥n -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-xl font-bold mb-4">üí≥ Gesti√≥n de Suscripci√≥n</h3>
                
                <!-- Info actual -->
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <span class="text-gray-600">Plan:</span>
                            <span id="planActual" class="font-bold ml-2">-</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Estado:</span>
                            <span id="estadoActual" class="font-bold ml-2">-</span>
                        </div>
                    </div>
                    <div id="infoVencimiento" class="mt-2 text-sm text-gray-600"></div>
                </div>
                
                <!-- Botones de pago -->
                <div class="space-y-3">
                    <button onclick="abrirMercadoPago()" 
                        class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700">
                        üí≥ Pagar Mensualidad $15.000 CLP
                    </button>
                    <button onclick="confirmarPagoWhatsApp()" 
                        class="w-full bg-green-500 text-white py-3 rounded-lg font-bold hover:bg-green-600">
                        ‚úÖ Ya pagu√© - Confirmar por WhatsApp
                    </button>
                </div>
                
                <p class="text-sm text-gray-500 mt-4 text-center">
                    El pago se procesa manualmente. Despu√©s de pagar, confirma por WhatsApp.
                </p>
            </div>
            
            <!-- Tabs de Configuraci√≥n -->
<div class="mb-6 border-b border-gray-200">
    <nav class="flex space-x-4">
        <button onclick="mostrarTabConfiguracion('servicios')" id="tabConfigServicios" 
            class="tab-config-btn border-b-2 border-blue-600 text-blue-600 py-3 px-4 font-medium">
            ‚úÇÔ∏è Servicios
        </button>
        <button onclick="mostrarTabConfiguracion('productos')" id="tabConfigProductos" 
            class="tab-config-btn text-gray-600 hover:text-gray-800 py-3 px-4 font-medium">
            üß¥ Productos
        </button>
    </nav>
</div>

<!-- Secci√≥n Servicios (Tab) -->
<div id="configServicios" class="tab-config-content">
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold">
                <i class="fas fa-cut mr-2"></i>Servicios de la Barber√≠a
            </h3>
            <button onclick="mostrarModalAgregarServicio()" 
                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                <i class="fas fa-plus mr-2"></i>Agregar Servicio
            </button>
        </div>
        
        <p class="text-gray-600 mb-4 text-sm">
            Gestiona los servicios que aparecen en el formulario de registro
        </p>
        
        <div id="listaServicios">
            <div class="text-center py-4">
                <div class="loading-spinner mx-auto"></div>
                <p class="mt-2 text-gray-600">Cargando servicios...</p>
            </div>
        </div>
    </div>
</div>

<!-- Secci√≥n Productos (Tab) -->
<div id="configProductos" class="tab-config-content hidden">
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold">
                <i class="fas fa-box mr-2"></i>Productos de la Barber√≠a
            </h3>
            <button onclick="mostrarModalAgregarProducto()" 
                class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                <i class="fas fa-plus mr-2"></i>Agregar Producto
            </button>
        </div>
        
        <p class="text-gray-600 mb-4 text-sm">
            Gestiona los productos que vendes (gel, cera, shampoo, etc)
        </p>
        
        <!-- Alertas de stock bajo -->
        <div id="alertasStockBajo" class="mb-4"></div>
        
        <!-- Lista de productos -->
        <div id="listaProductos">
            <div class="text-center py-4">
                <div class="loading-spinner mx-auto"></div>
                <p class="mt-2 text-gray-600">Cargando productos...</p>
            </div>
        </div>
        
        <!-- Nota informativa -->
        <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="flex items-start">
                <i class="fas fa-info-circle text-blue-500 mt-1 mr-3"></i>
                <div class="text-sm text-blue-800">
                    <p class="font-semibold mb-1">üí° Informaci√≥n importante:</p>
                    <ul class="list-disc list-inside space-y-1 text-blue-700">
                        <li>Los productos se pueden vender en "Registrar Servicio"</li>
                        <li>El stock se resta autom√°ticamente al vender</li>
                        <li><strong>Los productos NO generan comisi√≥n para empleados</strong></li>
                        <li>100% de la venta de productos va para el administrador</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
            
        </div>
    `;
    
    // Llenar informaci√≥n de suscripci√≥n
    mostrarInfoSuscripcion();
    // Llenar informaci√≥n de suscripci√≥n
    mostrarInfoSuscripcion();
    
    // Cargar servicios autom√°ticamente
    setTimeout(() => cargarServiciosConfiguracion(), 500);
}

function mostrarInfoSuscripcion() {
    const barberiaData = window.CURRENT_BARBERIA_DATA;
    
    // Mostrar plan
    const planTexto = barberiaData.plan === 'trial' ? 'Trial (15 d√≠as gratis)' : 'Premium';
    document.getElementById('planActual').textContent = planTexto;
    
    // Mostrar estado
    const estadoTexto = barberiaData.activa ? '‚úÖ Activo' : '‚ùå Vencido';
    const estadoColor = barberiaData.activa ? 'text-green-600' : 'text-red-600';
    const estadoEl = document.getElementById('estadoActual');
    estadoEl.textContent = estadoTexto;
    estadoEl.className = `font-bold ml-2 ${estadoColor}`;
    
    // Mostrar info de vencimiento
    const infoDiv = document.getElementById('infoVencimiento');
    if (barberiaData.plan === 'trial' && barberiaData.trial_hasta) {
        const diasRestantes = calcularDiasRestantes(barberiaData.trial_hasta);
        if (diasRestantes > 0) {
            infoDiv.innerHTML = `‚è∞ Tu trial vence en <strong>${diasRestantes} d√≠as</strong> (${barberiaData.trial_hasta})`;
        } else {
            infoDiv.innerHTML = `‚è∞ Tu trial venci√≥ el ${barberiaData.trial_hasta}`;
            infoDiv.className = 'mt-2 text-sm text-red-600 font-semibold';
        }
    } else if (barberiaData.plan === 'premium') {
        infoDiv.innerHTML = '‚ú® Gracias por tu suscripci√≥n Premium';
    }
}
        // ===============================
// GESTI√ìN DE SERVICIOS - CRUD
// ===============================

async function cargarServiciosConfiguracion() {
    const container = document.getElementById('listaServicios');
    if (!container) return;
    
    try {
        console.log('üîç Cargando servicios para configuraci√≥n...');
        
        const { data: servicios, error } = await supabase
            .from('services')
            .select('*')
            .eq('barberia_id', window.CURRENT_BARBERIA_ID)
            .order('orden', { ascending: true });
        
        if (error) throw error;
        
        if (!servicios || servicios.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-inbox text-4xl mb-3"></i>
                    <p>No hay servicios configurados</p>
                    <p class="text-sm mt-2">Agrega tu primer servicio usando el bot√≥n de arriba</p>
                </div>
            `;
            return;
        }
        
        // Generar tabla de servicios
        let html = `
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Precio Sugerido</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Descripci√≥n</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
        `;
        
        servicios.forEach(servicio => {
            const estadoBadge = servicio.activo 
                ? '<span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full">‚úÖ Activo</span>'
                : '<span class="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded-full">‚õî Inactivo</span>';
            
            html += `
                <tr>
                    <td class="px-4 py-3 text-sm font-medium text-gray-900">${servicio.nombre}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">$${(servicio.precio_sugerido || 0).toLocaleString('es-CL')}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${servicio.descripcion || '-'}</td>
                    <td class="px-4 py-3 text-sm">${estadoBadge}</td>
                    <td class="px-4 py-3 text-sm space-x-2">
                        <button onclick="mostrarModalEditarServicio('${servicio.id}')" 
                            class="text-blue-600 hover:text-blue-800 font-medium">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button onclick="toggleEstadoServicio('${servicio.id}', ${servicio.activo})" 
                            class="text-${servicio.activo ? 'red' : 'green'}-600 hover:text-${servicio.activo ? 'red' : 'green'}-800 font-medium">
                            <i class="fas fa-${servicio.activo ? 'times-circle' : 'check-circle'}"></i> ${servicio.activo ? 'Desactivar' : 'Activar'}
                        </button>
                    </td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
            <div class="mt-4 text-sm text-gray-600 bg-blue-50 p-3 rounded-lg">
                <i class="fas fa-info-circle mr-2"></i>
                <strong>Nota:</strong> Los servicios desactivados no aparecer√°n en el formulario de registro
            </div>
        `;
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('‚ùå Error cargando servicios:', error);
        container.innerHTML = `
            <div class="bg-red-100 p-4 rounded-lg text-red-700 text-center">
                ‚ùå Error al cargar servicios. Intenta recargar la p√°gina.
            </div>
        `;
    }
}

function mostrarModalAgregarServicio() {
    const modalHTML = `
        <div id="modalServicio" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">‚ûï Nuevo Servicio</h3>
                    <button onclick="cerrarModalServicio()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="formServicio">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nombre del Servicio *</label>
                            <input type="text" id="nombreServicio" maxlength="100" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Ej: Corte Fade" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Precio Sugerido *</label>
                            <input type="number" id="precioServicio" min="0" step="1000" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="15000" required>
                            <p class="text-xs text-gray-500 mt-1">Este precio aparecer√° como referencia</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Descripci√≥n (opcional)</label>
                            <textarea id="descripcionServicio" maxlength="500" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Descripci√≥n breve del servicio"></textarea>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3 mt-6">
                        <button type="button" onclick="cerrarModalServicio()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600">
                            Cancelar
                        </button>
                        <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">
                            ‚ûï Agregar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    document.getElementById('formServicio').addEventListener('submit', guardarNuevoServicio);
}

async function guardarNuevoServicio(e) {
    e.preventDefault();
    
    const nombre = document.getElementById('nombreServicio').value.trim();
    const precio = parseInt(document.getElementById('precioServicio').value);
    const descripcion = document.getElementById('descripcionServicio').value.trim();
    
    if (!nombre || precio < 0) {
        alert('‚ùå Por favor completa todos los campos obligatorios correctamente');
        return;
    }
    
    try {
        showLoading();
        console.log('üíæ Guardando nuevo servicio:', nombre);
        
        // Obtener el orden m√°ximo actual
        const { data: maxOrden, error: errorOrden } = await supabase
            .from('services')
            .select('orden')
            .eq('barberia_id', window.CURRENT_BARBERIA_ID)
            .order('orden', { ascending: false })
            .limit(1);
        
        const nuevoOrden = maxOrden && maxOrden.length > 0 ? maxOrden[0].orden + 1 : 1;
        
        const nuevoServicio = {
            nombre: nombre,
            precio_sugerido: precio,
            descripcion: descripcion || null,
            barberia_id: window.CURRENT_BARBERIA_ID,
            activo: true,
            orden: nuevoOrden
        };
        
        const { data, error } = await supabase
            .from('services')
            .insert([nuevoServicio])
            .select();
        
        if (error) {
            console.error('‚ùå Error de Supabase:', error);
            alert(`‚ùå Error al guardar: ${error.message}`);
        } else {
            console.log('‚úÖ Servicio creado:', data);
            alert(`‚úÖ Servicio "${nombre}" creado exitosamente!`);
            
            cerrarModalServicio();
            cargarServiciosConfiguracion();
            
            // Limpiar cache de servicios activos
            window.serviciosActivos = null;
        }
        
    } catch (error) {
        console.error('‚ùå Error cr√≠tico:', error);
        alert('‚ùå Error del sistema. Intenta nuevamente.');
    } finally {
        hideLoading();
    }
}

async function mostrarModalEditarServicio(servicioId) {
    try {
        showLoading();
        
        const { data: servicio, error } = await supabase
            .from('services')
            .select('*')
            .eq('id', servicioId)
            .single();
        
        hideLoading();
        
        if (error || !servicio) {
            alert('‚ùå No se pudo cargar el servicio');
            return;
        }
        
        const modalHTML = `
            <div id="modalServicio" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">‚úèÔ∏è Editar Servicio</h3>
                        <button onclick="cerrarModalServicio()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <form id="formServicio">
                        <input type="hidden" id="servicioId" value="${servicio.id}">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nombre del Servicio *</label>
                                <input type="text" id="nombreServicio" value="${servicio.nombre}" maxlength="100" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Precio Sugerido *</label>
                                <input type="number" id="precioServicio" value="${servicio.precio_sugerido || 0}" min="0" step="1000" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Descripci√≥n (opcional)</label>
                                <textarea id="descripcionServicio" maxlength="500" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">${servicio.descripcion || ''}</textarea>
                            </div>
                        </div>
                        
                        <div class="flex space-x-3 mt-6">
                            <button type="button" onclick="cerrarModalServicio()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600">
                                Cancelar
                            </button>
                            <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">
                                üíæ Guardar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        document.getElementById('formServicio').addEventListener('submit', guardarEdicionServicio);
        
    } catch (error) {
        hideLoading();
        console.error('‚ùå Error:', error);
        alert('‚ùå Error del sistema');
    }
}

async function guardarEdicionServicio(e) {
    e.preventDefault();
    
    const id = document.getElementById('servicioId').value;
    const nombre = document.getElementById('nombreServicio').value.trim();
    const precio = parseInt(document.getElementById('precioServicio').value);
    const descripcion = document.getElementById('descripcionServicio').value.trim();
    
    if (!nombre || precio < 0) {
        alert('‚ùå Por favor completa todos los campos correctamente');
        return;
    }
    
    try {
        showLoading();
        console.log('üíæ Actualizando servicio:', id);
        
        const { data, error } = await supabase
            .from('services')
            .update({
                nombre: nombre,
                precio_sugerido: precio,
                descripcion: descripcion || null
            })
            .eq('id', id)
            .eq('barberia_id', window.CURRENT_BARBERIA_ID)
            .select();
        
        if (error) {
            console.error('‚ùå Error:', error);
            alert(`‚ùå Error al actualizar: ${error.message}`);
        } else {
            console.log('‚úÖ Servicio actualizado:', data);
            alert(`‚úÖ Servicio "${nombre}" actualizado correctamente!`);
            
            cerrarModalServicio();
            cargarServiciosConfiguracion();
            
            // Limpiar cache
            window.serviciosActivos = null;
        }
        
    } catch (error) {
        console.error('‚ùå Error cr√≠tico:', error);
        alert('‚ùå Error del sistema');
    } finally {
        hideLoading();
    }
}

async function toggleEstadoServicio(servicioId, estadoActual) {
    const accion = estadoActual ? 'desactivar' : 'activar';
    const confirmacion = confirm(`¬ø${accion.charAt(0).toUpperCase() + accion.slice(1)} este servicio?\n\n${estadoActual ? '‚ö†Ô∏è No aparecer√° en el formulario de registro' : '‚úÖ Volver√° a aparecer en el formulario'}`);
    
    if (!confirmacion) return;
    
    try {
        showLoading();
        console.log(`üîÑ ${accion} servicio:`, servicioId);
        
        const { data, error } = await supabase
            .from('services')
            .update({ activo: !estadoActual })
            .eq('id', servicioId)
            .eq('barberia_id', window.CURRENT_BARBERIA_ID)
            .select();
        
        if (error) {
            console.error('‚ùå Error:', error);
            alert(`‚ùå Error al ${accion}: ${error.message}`);
        } else {
            console.log(`‚úÖ Servicio ${accion}do:`, data);
            alert(`‚úÖ Servicio ${accion}do correctamente!`);
            
            cargarServiciosConfiguracion();
            
            // Limpiar cache
            window.serviciosActivos = null;
        }
        
    } catch (error) {
        console.error('‚ùå Error cr√≠tico:', error);
        alert('‚ùå Error del sistema');
    } finally {
        hideLoading();
    }
}

function cerrarModalServicio() {
    const modal = document.getElementById('modalServicio');
    if (modal) {
        modal.remove();
    }
}
        // ===============================
        // GESTI√ìN DE PRODUCTOS - TABS Y CRUD
        // ===============================
        
        function mostrarTabConfiguracion(tab) {
            console.log('üîÑ Cambiando a tab:', tab);
            
            // Ocultar todos los contenidos
            document.querySelectorAll('.tab-config-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Desactivar todos los botones
            document.querySelectorAll('.tab-config-btn').forEach(btn => {
                btn.classList.remove('border-b-2', 'border-blue-600', 'text-blue-600');
                btn.classList.add('text-gray-600');
            });
            
            // Mostrar contenido seleccionado
            const contenidoId = `config${tab.charAt(0).toUpperCase() + tab.slice(1)}`;
            const contenido = document.getElementById(contenidoId);
            if (contenido) {
                contenido.classList.remove('hidden');
            }
            
            // Activar bot√≥n seleccionado
            const btnId = `tabConfig${tab.charAt(0).toUpperCase() + tab.slice(1)}`;
            const btn = document.getElementById(btnId);
            if (btn) {
                btn.classList.add('border-b-2', 'border-blue-600', 'text-blue-600');
                btn.classList.remove('text-gray-600');
            }
            
            // Cargar datos seg√∫n tab
            if (tab === 'productos') {
                cargarProductosConfiguracion();
            }
        }

        async function cargarProductosConfiguracion() {
    const container = document.getElementById('listaProductos');
    if (!container) {
        console.error('‚ùå Container listaProductos no encontrado');
        return;
    }
    
    console.log('üß¥ Iniciando carga de productos...');
    console.log('üîç barberia_id:', window.CURRENT_BARBERIA_ID);
    
    try {
        const { data: productos, error } = await supabase
            .from('productos')
            .select('*')
            .eq('barberia_id', window.CURRENT_BARBERIA_ID)
            .order('nombre', { ascending: true });
        
        console.log('üì¶ Respuesta Supabase:', { productos, error });
        console.log('üìä Cantidad de productos:', productos ? productos.length : 0);
        
        if (error) {
            console.error('‚ùå Error de Supabase:', error);
            throw error;
        }
        
        if (!productos || productos.length === 0) {
            console.warn('‚ö†Ô∏è No hay productos en la BD para esta barber√≠a');
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-inbox text-4xl mb-3"></i>
                    <p>No hay productos configurados</p>
                    <p class="text-sm mt-2">Agrega tu primer producto usando el bot√≥n de arriba</p>
                </div>
            `;
            return;
        }
        
        console.log('‚úÖ Productos encontrados:', productos);
        
        // Detectar productos con stock bajo
        const stockBajo = productos.filter(p => p.activo && p.stock_actual < 5);
        const alertasContainer = document.getElementById('alertasStockBajo');
        
        if (stockBajo.length > 0) {
            alertasContainer.innerHTML = `
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <div class="flex items-start">
                        <i class="fas fa-exclamation-triangle text-yellow-600 mt-1 mr-3"></i>
                        <div class="flex-1">
                            <p class="font-semibold text-yellow-800 mb-2">‚ö†Ô∏è Productos con stock bajo:</p>
                            <ul class="text-sm text-yellow-700 space-y-1">
                                ${stockBajo.map(p => `<li>‚Ä¢ <strong>${p.nombre}</strong>: Quedan ${p.stock_actual} unidades</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        } else {
            alertasContainer.innerHTML = '';
        }
        
        // Generar tabla
        let html = `
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Precio</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Stock</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
        `;
        
        productos.forEach(producto => {
            const estadoBadge = producto.activo 
                ? '<span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full">‚úÖ Activo</span>'
                : '<span class="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded-full">‚õî Inactivo</span>';
            
            const stockBadge = producto.stock_actual < 5
                ? `<span class="text-red-600 font-bold">${producto.stock_actual} ‚ö†Ô∏è</span>`
                : `<span class="text-gray-700">${producto.stock_actual}</span>`;
            
            html += `
                <tr>
                    <td class="px-4 py-3 text-sm font-medium text-gray-900">${producto.nombre}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">$${(producto.precio_venta || 0).toLocaleString('es-CL')}</td>
                    <td class="px-4 py-3 text-sm">${stockBadge}</td>
                    <td class="px-4 py-3 text-sm">${estadoBadge}</td>
                    <td class="px-4 py-3 text-sm space-x-2">
                        <button onclick="mostrarModalEditarProducto('${producto.id}')" 
                            class="text-blue-600 hover:text-blue-800 font-medium">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button onclick="mostrarModalAjustarStock('${producto.id}', '${producto.nombre}', ${producto.stock_actual})" 
                            class="text-purple-600 hover:text-purple-800 font-medium">
                            <i class="fas fa-box"></i> Stock
                        </button>
                        <button onclick="toggleEstadoProducto('${producto.id}', ${producto.activo})" 
                            class="text-${producto.activo ? 'red' : 'green'}-600 hover:text-${producto.activo ? 'red' : 'green'}-800 font-medium">
                            <i class="fas fa-${producto.activo ? 'times-circle' : 'check-circle'}"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
        
        html += `</tbody></table></div>`;
        
        console.log('üìù HTML generado, actualizando container...');
        container.innerHTML = html;
        console.log('‚úÖ Container actualizado exitosamente');
        
    } catch (error) {
        console.error('‚ùå Error cr√≠tico:', error);
        console.error('‚ùå Stack:', error.stack);
        container.innerHTML = '<div class="bg-red-100 p-4 rounded-lg text-red-700 text-center">‚ùå Error al cargar productos</div>';
    }
}

        function mostrarModalAgregarProducto() {
            const modalHTML = `
                <div id="modalProducto" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">‚ûï Nuevo Producto</h3>
                            <button onclick="cerrarModalProducto()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        
                        <form id="formProducto">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nombre *</label>
                                    <input type="text" id="nombreProducto" class="w-full px-4 py-2 border rounded-lg" placeholder="Ej: Gel Ultra Hold" required>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Precio *</label>
                                    <input type="number" id="precioProducto" min="0" step="500" class="w-full px-4 py-2 border rounded-lg" placeholder="8000" required>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Stock Inicial *</label>
                                        <input type="number" id="stockProducto" min="0" class="w-full px-4 py-2 border rounded-lg" placeholder="20" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Descripci√≥n</label>
                                        <input type="text" id="descripcionProducto" class="w-full px-4 py-2 border rounded-lg" placeholder="Opcional">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex space-x-3 mt-6">
                                <button type="button" onclick="cerrarModalProducto()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg">
                                    Cancelar
                                </button>
                                <button type="submit" class="flex-1 bg-green-600 text-white py-2 rounded-lg">
                                    ‚ûï Agregar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            document.getElementById('formProducto').addEventListener('submit', guardarNuevoProducto);
        }

        async function guardarNuevoProducto(e) {
            e.preventDefault();
            
            const nombre = document.getElementById('nombreProducto').value.trim();
            const precio = parseFloat(document.getElementById('precioProducto').value);
            const stock = parseInt(document.getElementById('stockProducto').value);
            const descripcion = document.getElementById('descripcionProducto').value.trim();
            
            try {
                showLoading();
                
                const nuevoProducto = {
                    nombre: nombre,
                    precio_venta: precio,
                    stock_actual: stock,
                    descripcion: descripcion || null,
                    barberia_id: window.CURRENT_BARBERIA_ID,
                    activo: true,
                    orden: 999
                };
                
                const { data, error } = await supabase
                    .from('productos')
                    .insert([nuevoProducto])
                    .select();
                
                if (error) throw error;
                
                alert(`‚úÖ Producto "${nombre}" agregado correctamente!`);
                cerrarModalProducto();
                cargarProductosConfiguracion();
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                alert('‚ùå Error al guardar producto');
            } finally {
                hideLoading();
            }
        }

        async function mostrarModalEditarProducto(productoId) {
            try {
                showLoading();
                
                const { data: producto, error } = await supabase
                    .from('productos')
                    .select('*')
                    .eq('id', productoId)
                    .single();
                
                hideLoading();
                
                if (error || !producto) {
                    alert('‚ùå No se pudo cargar el producto');
                    return;
                }
                
                const modalHTML = `
                    <div id="modalProducto" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold">‚úèÔ∏è Editar Producto</h3>
                                <button onclick="cerrarModalProducto()" class="text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-times text-xl"></i>
                                </button>
                            </div>
                            
                            <form id="formProducto">
                                <input type="hidden" id="productoId" value="${producto.id}">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Nombre *</label>
                                        <input type="text" id="nombreProducto" value="${producto.nombre}" class="w-full px-4 py-2 border rounded-lg" required>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Precio *</label>
                                        <input type="number" id="precioProducto" value="${producto.precio_venta}" min="0" step="500" class="w-full px-4 py-2 border rounded-lg" required>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Descripci√≥n</label>
                                        <input type="text" id="descripcionProducto" value="${producto.descripcion || ''}" class="w-full px-4 py-2 border rounded-lg">
                                    </div>
                                    
                                    <div class="bg-gray-50 p-3 rounded">
                                        <p class="text-sm text-gray-600">Stock actual: <strong>${producto.stock_actual}</strong> unidades</p>
                                        <p class="text-xs text-gray-500 mt-1">Usa el bot√≥n "Stock" para ajustar</p>
                                    </div>
                                </div>
                                
                                <div class="flex space-x-3 mt-6">
                                    <button type="button" onclick="cerrarModalProducto()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-lg">
                                        üíæ Guardar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                document.getElementById('formProducto').addEventListener('submit', guardarEdicionProducto);
                
            } catch (error) {
                hideLoading();
                alert('‚ùå Error del sistema');
            }
        }

        async function guardarEdicionProducto(e) {
            e.preventDefault();
            
            const id = document.getElementById('productoId').value;
            const nombre = document.getElementById('nombreProducto').value.trim();
            const precio = parseFloat(document.getElementById('precioProducto').value);
            const descripcion = document.getElementById('descripcionProducto').value.trim();
            
            try {
                showLoading();
                
                const { error } = await supabase
                    .from('productos')
                    .update({
                        nombre: nombre,
                        precio_venta: precio,
                        descripcion: descripcion || null
                    })
                    .eq('id', id)
                    .eq('barberia_id', window.CURRENT_BARBERIA_ID);
                
                if (error) throw error;
                
                alert(`‚úÖ Producto "${nombre}" actualizado!`);
                cerrarModalProducto();
                cargarProductosConfiguracion();
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                alert('‚ùå Error al actualizar');
            } finally {
                hideLoading();
            }
        }

        function mostrarModalAjustarStock(productoId, nombre, stockActual) {
            const modalHTML = `
                <div id="modalStock" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">üì¶ Ajustar Stock</h3>
                            <button onclick="cerrarModalStock()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        
                        <div class="mb-4">
                            <p class="text-gray-700 mb-2"><strong>Producto:</strong> ${nombre}</p>
                            <p class="text-gray-700"><strong>Stock actual:</strong> <span class="text-lg font-bold text-blue-600">${stockActual}</span> unidades</p>
                        </div>
                        
                        <form id="formStock">
                            <input type="hidden" id="productoIdStock" value="${productoId}">
                            <input type="hidden" id="stockActualHidden" value="${stockActual}">
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Ajuste:</label>
                                    <select id="tipoAjuste" class="w-full px-4 py-2 border rounded-lg" onchange="actualizarVistaStock()">
                                        <option value="agregar">‚ûï Agregar unidades (compra)</option>
                                        <option value="quitar">‚ûñ Quitar unidades (merma/error)</option>
                                        <option value="establecer">üî¢ Establecer cantidad exacta</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cantidad:</label>
                                    <input type="number" id="cantidadStock" min="1" class="w-full px-4 py-2 border rounded-lg" placeholder="0" required>
                                </div>
                                
                                <div id="vistaPrevia" class="bg-blue-50 p-3 rounded-lg">
                                    <p class="text-sm text-blue-800">Ingresa una cantidad para ver el resultado</p>
                                </div>
                            </div>
                            
                            <div class="flex space-x-3 mt-6">
                                <button type="button" onclick="cerrarModalStock()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg">
                                    Cancelar
                                </button>
                                <button type="submit" class="flex-1 bg-purple-600 text-white py-2 rounded-lg">
                                    üíæ Guardar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            document.getElementById('formStock').addEventListener('submit', guardarAjusteStock);
            document.getElementById('cantidadStock').addEventListener('input', actualizarVistaStock);
        }

        function actualizarVistaStock() {
            const tipo = document.getElementById('tipoAjuste').value;
            const cantidad = parseInt(document.getElementById('cantidadStock').value) || 0;
            const stockActual = parseInt(document.getElementById('stockActualHidden').value);
            const vista = document.getElementById('vistaPrevia');
            
            if (cantidad === 0) {
                vista.innerHTML = '<p class="text-sm text-blue-800">Ingresa una cantidad para ver el resultado</p>';
                return;
            }
            
            let nuevoStock = stockActual;
            let mensaje = '';
            
            if (tipo === 'agregar') {
                nuevoStock = stockActual + cantidad;
                mensaje = `Stock actual: ${stockActual} + ${cantidad} = <strong>${nuevoStock}</strong> unidades`;
            } else if (tipo === 'quitar') {
                nuevoStock = Math.max(0, stockActual - cantidad);
                mensaje = `Stock actual: ${stockActual} - ${cantidad} = <strong>${nuevoStock}</strong> unidades`;
            } else if (tipo === 'establecer') {
                nuevoStock = cantidad;
                mensaje = `Nuevo stock: <strong>${nuevoStock}</strong> unidades`;
            }
            
            vista.innerHTML = `<p class="text-sm text-blue-800">${mensaje}</p>`;
        }

        async function guardarAjusteStock(e) {
            e.preventDefault();
            
            const productoId = document.getElementById('productoIdStock').value;
            const tipo = document.getElementById('tipoAjuste').value;
            const cantidad = parseInt(document.getElementById('cantidadStock').value);
            const stockActual = parseInt(document.getElementById('stockActualHidden').value);
            
            let nuevoStock = stockActual;
            
            if (tipo === 'agregar') {
                nuevoStock = stockActual + cantidad;
            } else if (tipo === 'quitar') {
                nuevoStock = Math.max(0, stockActual - cantidad);
            } else if (tipo === 'establecer') {
                nuevoStock = cantidad;
            }
            
            try {
                showLoading();
                
                const { error } = await supabase
                    .from('productos')
                    .update({ stock_actual: nuevoStock })
                    .eq('id', productoId)
                    .eq('barberia_id', window.CURRENT_BARBERIA_ID);
                
                if (error) throw error;
                
                alert(`‚úÖ Stock actualizado: ${stockActual} ‚Üí ${nuevoStock} unidades`);
                cerrarModalStock();
                cargarProductosConfiguracion();
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                alert('‚ùå Error al actualizar stock');
            } finally {
                hideLoading();
            }
        }

        async function toggleEstadoProducto(productoId, estadoActual) {
            const accion = estadoActual ? 'desactivar' : 'activar';
            
            if (!confirm(`¬ø${accion.charAt(0).toUpperCase() + accion.slice(1)} este producto?`)) return;
            
            try {
                showLoading();
                
                const { error } = await supabase
                    .from('productos')
                    .update({ activo: !estadoActual })
                    .eq('id', productoId)
                    .eq('barberia_id', window.CURRENT_BARBERIA_ID);
                
                if (error) throw error;
                
                alert(`‚úÖ Producto ${accion}do correctamente!`);
                cargarProductosConfiguracion();
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                alert('‚ùå Error al cambiar estado');
            } finally {
                hideLoading();
            }
        }

        function cerrarModalProducto() {
            const modal = document.getElementById('modalProducto');
            if (modal) modal.remove();
        }

        function cerrarModalStock() {
            const modal = document.getElementById('modalStock');
            if (modal) modal.remove();
        }
        // ===============================
        // LOGOUT
        // ===============================
        function logout() {
            localStorage.removeItem('currentUser');
            localStorage.removeItem('userRole');
            location.reload();
        }
        
        // ===============================
        // VERIFICAR SESI√ìN AL CARGAR
        // ===============================
      window.addEventListener('load', () => {
    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
        currentUser = JSON.parse(savedUser);
        userRole = localStorage.getItem('userRole');
        
        // üîÑ FORZAR RECARGA DE DATOS FRESCOS
        console.log('üîÑ Sesi√≥n existente detectada - validando datos frescos...');
        
        // Recargar datos de barber√≠a para asegurar info actualizada
        window.CURRENT_BARBERIA_DATA = currentUser.barberias;
        window.CURRENT_BARBERIA_ID = currentUser.barberia_id;
        
        initializeApp();
    }
});
    </script>
</body>
</html>
