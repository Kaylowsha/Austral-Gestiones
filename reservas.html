<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservar Cita - Barbería</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .slot-disponible {
    @apply bg-gradient-to-r from-green-400 to-green-500 text-white font-semibold hover:from-green-500 hover:to-green-600 cursor-pointer transition-all duration-300 transform hover:scale-105 shadow-lg relative;
}
.slot-con-info::after {
    content: attr(data-info);
    position: absolute;
    bottom: -5px;
    right: -5px;
    background: rgba(0, 0, 0, 0.6);
    color: white;
    font-size: 9px;
    padding: 2px 5px;
    border-radius: 10px;
    white-space: nowrap;
    transform: scale(0.9);
    opacity: 0.7;
    transition: all 0.2s ease;
}
.slot-con-info:hover::after {
    transform: scale(1);
    opacity: 1;
    bottom: -8px;
    right: -8px;
}
        .slot-ocupado {
            @apply bg-gray-200 text-gray-500 cursor-not-allowed;
        }
        .slot-seleccionado {
            @apply bg-gradient-to-r from-blue-500 to-purple-600 text-white shadow-xl transform scale-105;
        }
        .horarios-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        .barbero-card {
            @apply bg-white border-2 border-gray-200 rounded-xl p-4 cursor-pointer transition-all duration-300 hover:border-blue-500 hover:shadow-lg;
        }
        .barbero-card.selected {
            @apply border-blue-500 bg-blue-50 shadow-lg;
        }
        .step-indicator {
            @apply bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-full w-10 h-10 flex items-center justify-center font-bold text-lg shadow-lg;
        }
        .dia-calendario {
            @apply w-10 h-10 rounded-lg flex items-center justify-center text-sm font-medium cursor-pointer transition-all duration-300;
        }
        .dia-disponible {
            @apply bg-white text-gray-700 hover:bg-gradient-to-r hover:from-blue-400 hover:to-purple-500 hover:text-white shadow-sm hover:shadow-md transform hover:scale-105;
        }
        .dia-pasado {
            @apply bg-gray-100 text-gray-400 cursor-not-allowed;
        }
        .dia-domingo {
            @apply bg-red-100 text-red-500 cursor-not-allowed;
        }
        .dia-seleccionado {
            @apply bg-gradient-to-r from-blue-500 to-purple-600 text-white shadow-lg transform scale-105;
        }
        .mes-otro {
            @apply text-gray-300;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header Atractivo -->
    <div class="gradient-bg text-white relative overflow-hidden">
        <div class="absolute inset-0 bg-black opacity-10"></div>
        <div class="relative max-w-md mx-auto text-center py-8 px-6">
            <div class="mb-4">
                <i class="fas fa-cut text-4xl mb-3 animate-pulse"></i>
                <h1 class="text-3xl font-bold mb-2">¡Reserva tu Cita!</h1>
                <p class="text-purple-100 text-lg" id="nombreBarberia">Cargando...</p>
                <p class="text-purple-200 text-sm mt-2" id="debugInfo" style="display:none;"></p>
            </div>
            <!-- Progress Bar -->
            <div class="mt-6">
                <div class="flex justify-between items-center">
                    <div id="indicator1" class="step-indicator">1</div>
                    <div class="flex-1 h-2 bg-purple-300 mx-2 rounded-full">
                        <div id="progress1" class="h-full bg-white rounded-full transition-all duration-500" style="width: 33%"></div>
                    </div>
                    <div id="indicator2" class="step-indicator opacity-50">2</div>
                    <div class="flex-1 h-2 bg-purple-300 mx-2 rounded-full">
                        <div id="progress2" class="h-full bg-white rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <div id="indicator3" class="step-indicator opacity-50">3</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contenido Principal -->
    <div class="max-w-md mx-auto px-4 -mt-4 relative z-10">
        
        <!-- PASO 1: Fecha y Horario -->
        <div id="paso1" class="bg-white rounded-2xl card-shadow mb-6 overflow-hidden">
            <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4">
                <h2 class="text-xl font-bold flex items-center">
                    <i class="fas fa-calendar-alt mr-3"></i>
                    ¿Cuándo te vemos?
                </h2>
            </div>
            
            <div class="p-6">
                <div class="mb-6">
                    <label class="block text-sm font-bold text-gray-700 mb-3">📅 Selecciona la fecha</label>
                    
                    <!-- Calendario Visual -->
                    <div class="bg-gradient-to-br from-blue-50 to-purple-50 rounded-xl p-4 border-2 border-blue-200">
                        <!-- Header del Calendario -->
                        <div class="flex items-center justify-between mb-4">
                            <button type="button" onclick="cambiarMes(-1)" class="p-2 rounded-full bg-white shadow-md hover:shadow-lg transition-all">
                                <i class="fas fa-chevron-left text-gray-600"></i>
                            </button>
                            <h3 id="mesActual" class="text-lg font-bold text-gray-700"></h3>
                            <button type="button" onclick="cambiarMes(1)" class="p-2 rounded-full bg-white shadow-md hover:shadow-lg transition-all">
                                <i class="fas fa-chevron-right text-gray-600"></i>
                            </button>
                        </div>
                        
                        <!-- Días de la Semana -->
                        <div class="grid grid-cols-7 gap-1 mb-2">
                            <div class="text-center text-xs font-bold text-gray-500 py-2">LUN</div>
                            <div class="text-center text-xs font-bold text-gray-500 py-2">MAR</div>
                            <div class="text-center text-xs font-bold text-gray-500 py-2">MIE</div>
                            <div class="text-center text-xs font-bold text-gray-500 py-2">JUE</div>
                            <div class="text-center text-xs font-bold text-gray-500 py-2">VIE</div>
                            <div class="text-center text-xs font-bold text-gray-500 py-2">SAB</div>
                            <div class="text-center text-xs font-bold text-red-400 py-2">DOM</div>
                        </div>
                        
                        <!-- Grid de Días -->
                        <div id="calendarioDias" class="grid grid-cols-7 gap-1">
                            <!-- Se llenará dinámicamente -->
                        </div>
                    </div>
                    
                    <!-- Input oculto para compatibilidad -->
                    <input type="date" id="fechaSeleccionada" class="hidden" onchange="cargarHorarios()">
                </div>

                <div id="horariosContainer" style="display:none;">
                   <!-- Horarios Mañana -->
                <div class="mb-6">
                    <div class="flex items-center mb-3">
                        <i class="fas fa-sun text-yellow-500 mr-2"></i>
                        <span class="font-bold text-gray-700">Mañana</span>
                        <span class="text-xs text-gray-500 ml-2 duracion-cita"></span>
                    </div>
                    <div id="horariosMañana" class="horarios-grid">
                        <!-- Se llenará dinámicamente -->
                    </div>
                </div>

                <!-- Horarios Tarde -->
                <div class="mb-4">
                    <div class="flex items-center mb-3">
                        <i class="fas fa-moon text-indigo-500 mr-2"></i>
                        <span class="font-bold text-gray-700">Tarde</span>
                        <span class="text-xs text-gray-500 ml-2 duracion-cita"></span>
                    </div>
                    <div id="horariosTarde" class="horarios-grid">
                        <!-- Se llenará dinámicamente -->
                    </div>
                </div>
                </div>
            </div>
        </div>

        <!-- PASO 2: Seleccionar Barbero -->
        <div id="paso2" class="bg-white rounded-2xl card-shadow mb-6 overflow-hidden" style="display:none;">
            <div class="bg-gradient-to-r from-green-500 to-teal-600 text-white p-4">
                <h2 class="text-xl font-bold flex items-center">
                    <i class="fas fa-user-tie mr-3"></i>
                    ¿Con quién prefieres?
                </h2>
            </div>
            
            <div class="p-6">
                <div id="barberosContainer" class="space-y-3">
                    <!-- Se llenará dinámicamente con cards -->
                </div>
            </div>
        </div>

        <!-- PASO 3: Datos del Cliente -->
        <div id="paso3" class="bg-white rounded-2xl card-shadow mb-6 overflow-hidden" style="display:none;">
            <div class="bg-gradient-to-r from-purple-500 to-pink-600 text-white p-4">
                <h2 class="text-xl font-bold flex items-center">
                    <i class="fas fa-user-edit mr-3"></i>
                    Cuéntanos de ti
                </h2>
            </div>
            
            <div class="p-6">
                <form id="formReserva">
                    <div class="space-y-5">
                        <div class="relative">
                            <i class="fas fa-user absolute left-3 top-4 text-gray-400"></i>
                            <input type="text" id="clienteNombre" 
                                class="w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent text-lg" 
                                placeholder="Tu nombre completo" required>
                        </div>
                        
                        <div class="relative">
                            <i class="fas fa-phone absolute left-3 top-4 text-gray-400"></i>
                            <input type="tel" id="clienteTelefono" 
                                class="w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent text-lg" 
                                placeholder="+56 9 1234 5678" required>
                        </div>
                        
                        <div class="relative">
                            <i class="fas fa-envelope absolute left-3 top-4 text-gray-400"></i>
                            <input type="email" id="clienteEmail" 
                                class="w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent text-lg" 
                                placeholder="tu@email.com (opcional)">
                            <span class="text-xs text-gray-500 mt-1 block">📧 Para enviarte la confirmación</span>
                        </div>
                        
                        <div class="relative">
                            <i class="fas fa-comment absolute left-3 top-4 text-gray-400"></i>
                            <textarea id="clienteNotas" rows="3" 
                                class="w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none" 
                                placeholder="¿Algún estilo especial? (opcional)"></textarea>
                        </div>
                    </div>
                    
                    <button type="submit" class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:from-green-600 hover:to-green-700 transition-all duration-300 transform hover:scale-105 mt-6">
                        <i class="fas fa-check mr-2"></i>¡Confirmar mi Cita!
                    </button>
                </form>
            </div>
        </div>

        <!-- Resumen Final -->
        <div id="resumenFinal" class="bg-gradient-to-br from-green-400 to-green-600 rounded-2xl card-shadow text-white overflow-hidden" style="display:none;">
            <div class="p-6 text-center">
                <div class="mb-4">
                    <i class="fas fa-check-circle text-6xl mb-4 animate-bounce"></i>
                    <h2 class="text-3xl font-bold mb-2">¡Listo! 🎉</h2>
                    <p class="text-green-100 text-lg">Tu cita está confirmada</p>
                </div>
                
                <div id="detallesReserva" class="bg-white bg-opacity-20 backdrop-blur-sm rounded-xl p-5 mb-4 text-left">
                    <!-- Se llenará con los detalles -->
                </div>
                
                <div id="mensajeEmail" class="bg-white bg-opacity-20 backdrop-blur-sm rounded-xl p-3 mb-4" style="display:none;">
                    <i class="fas fa-envelope mr-2"></i>
                    <span class="text-sm">Confirmación enviada a tu email</span>
                </div>
                
                <div class="space-y-3">
                    <p class="text-green-100 font-medium text-lg">¡Nos vemos pronto! 👋</p>
                    <p class="text-green-200 text-sm">
                        💡 Guarda esta pantalla o toma screenshot
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Debug Info -->
        <div id="debugPanel" class="bg-gray-800 text-white p-4 rounded-lg mt-4" style="display:none;">
            <h3 class="font-bold mb-2">🔍 Debug Info</h3>
            <div id="debugContent" class="text-sm space-y-1">
                <!-- Se llenará con info de debug -->
            </div>
        </div>
    </div>

    <!-- Loading Moderno -->
    <div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 text-center card-shadow">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-purple-200 border-t-purple-600 mx-auto mb-4"></div>
            <p class="text-gray-700 font-medium">Confirmando tu cita...</p>
            <p class="text-gray-500 text-sm mt-1">Solo un momento ✨</p>
        </div>
    </div>

    <script>
      // Variables globales
let barberiaData = null;
let barberosDisponibles = [];
let fechaSeleccionada = null;
let horarioSeleccionado = null;
let barberoSeleccionado = null;
let fechaActual = new Date();
let mesVisualizando = new Date();
let configuracionHorarios = null;
let duracionCita = 30; // Duración por defecto en minutos
let origenInterno = false;
        
        // Configuración CORREGIDA
        const SUPABASE_URL = 'https://uzmdreqbcacwkkfwpkui.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_z5aNne74P9pZeMeUkFEyrg_857LNNBh';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

       // Obtener parámetros de URL
const urlParams = new URLSearchParams(window.location.search);
const barberiaId = urlParams.get('barberia') || '450e5ba0-6771-41fd-9003-2706aac125af'; // Rulos por defecto
const preseleccionarFecha = urlParams.get('fecha'); // Opcional: fecha preseleccionada YYYY-MM-DD
const preseleccionarBarbero = urlParams.get('barbero'); // Opcional: ID del barbero preseleccionado

        // Se mantendrán como fallback
const HORARIOS_MAÑANA = ['10:00', '10:30', '11:00', '11:30', '12:00', '12:30'];
const HORARIOS_TARDE = ['15:00', '15:30', '16:00', '16:30', '17:00', '17:30', '18:00', '18:30', '19:00', '19:30'];

// Función para obtener horarios según configuración
function obtenerHorariosPorDia(fecha) {
    if (!configuracionHorarios) return { manana: HORARIOS_MAÑANA, tarde: HORARIOS_TARDE };
    
    const diaSemana = fecha.getDay(); // 0=domingo, 1=lunes, ...
    const nombresDias = ['domingo', 'lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado'];
    const nombreDia = nombresDias[diaSemana];
    
    debug('🗓️ Obteniendo horarios para', nombreDia);
    
    // Si el día no está activo, devolver arrays vacíos
    if (configuracionHorarios.diasActivos && configuracionHorarios.diasActivos[nombreDia] === false) {
        debug('❌ Día inactivo según configuración');
        return { manana: [], tarde: [] };
    }
    
    // Si hay horarios configurados para este día
    if (configuracionHorarios.horarios && configuracionHorarios.horarios[nombreDia]) {
        const horariosDia = configuracionHorarios.horarios[nombreDia];
        debug('✅ Horarios configurados encontrados', horariosDia);
        return {
            manana: horariosDia.manana || [],
            tarde: horariosDia.tarde || []
        };
    }
    
    // Fallback a horarios por defecto
    debug('⚠️ Sin horarios configurados, usando valores por defecto');
    return { manana: HORARIOS_MAÑANA, tarde: HORARIOS_TARDE };
}

// Función para verificar si un día está activo
function esDiaActivo(fecha) {
    if (!configuracionHorarios || !configuracionHorarios.diasActivos) return true;
    
    const diaSemana = fecha.getDay(); // 0=domingo, 1=lunes, ...
    const nombresDias = ['domingo', 'lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado'];
    const nombreDia = nombresDias[diaSemana];
    
    return configuracionHorarios.diasActivos[nombreDia] !== false;
}

        // Debug function
        function debug(mensaje, data = null) {
            console.log(`🔍 ${mensaje}`, data);
            const debugContent = document.getElementById('debugContent');
            if (debugContent) {
                const timestamp = new Date().toLocaleTimeString();
                const debugLine = document.createElement('div');
                debugLine.innerHTML = `[${timestamp}] ${mensaje}${data ? ': ' + JSON.stringify(data, null, 2) : ''}`;
                debugContent.appendChild(debugLine);
            }
        }

        // Mostrar/ocultar debug
        function toggleDebug() {
            const panel = document.getElementById('debugPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

     // Inicializar (MEJORADO)
window.addEventListener('load', async () => {
    debug('🚀 Iniciando aplicación');
    debug('URL actual', window.location.href);
    debug('Barbería ID detectada', barberiaId);
    
    // Verificar si viene desde el sistema interno
    origenInterno = urlParams.get('origen') === 'interno';
    debug('Origen interno:', origenInterno);
    
    await cargarDatosBarberia();
    await cargarBarberos();
    generarCalendario();
    
    // Double-click en header para mostrar debug completo
    document.querySelector('.gradient-bg').addEventListener('dblclick', toggleDebug);
});

    // FUNCIÓN CORREGIDA: Cargar datos barbería
async function cargarDatosBarberia() {
    debug('📊 Cargando datos de barbería...');
    
    try {
        // QUERY SIMPLIFICADA - Sin filtro activa
        const { data, error } = await supabase
            .from('barberias')
            .select('*')  // Seleccionar todo para debug
            .eq('id', barberiaId);
            // ❌ REMOVIDO: .eq('activa', true)
            // ❌ REMOVIDO: .single()

        debug('Respuesta Supabase', { data, error });

        if (error) {
            debug('❌ Error Supabase', error);
            throw error;
        }

        if (data && data.length > 0) {
            const barberia = data[0];  // Tomar primer resultado
            debug('✅ Barbería encontrada', barberia);
            
            document.getElementById('nombreBarberia').textContent = barberia.nombre;
            barberiaData = barberia;
            
            // Cargar configuración de horarios
            cargarConfiguracionHorarios(barberia);
            
            // Verificar si está activa (sin bloquear)
            if (!barberia.activa) {
                debug('⚠️ Barbería inactiva pero permitiendo continuar');
                const warningDiv = document.createElement('div');
                warningDiv.className = 'bg-yellow-100 text-yellow-800 p-2 rounded-lg text-sm mt-2';
                warningDiv.textContent = '⚠️ Barbería en mantenimiento - Reservas limitadas';
                document.querySelector('.gradient-bg .relative').appendChild(warningDiv);
            }
            
            // Mostrar mensaje promocional global si existe
            if (configuracionHorarios && configuracionHorarios.mensajeGlobal) {
                const mensajeDiv = document.createElement('div');
                mensajeDiv.className = 'bg-blue-100 text-blue-800 p-2 rounded-lg text-sm mt-2';
                mensajeDiv.innerHTML = `<i class="fas fa-bullhorn mr-2"></i>${configuracionHorarios.mensajeGlobal}`;
                document.querySelector('.gradient-bg .relative').appendChild(mensajeDiv);
            }
        } else {
            debug('❌ No se encontró barbería con ID', barberiaId);
            document.getElementById('nombreBarberia').textContent = 'Barbería no encontrada';
            
            // Mostrar IDs disponibles para debug
            const { data: todasBarberias } = await supabase
                .from('barberias')
                .select('id, nombre');
            
            debug('Barberías disponibles', todasBarberias);
        }
        
    } catch (error) {
        debug('❌ Error crítico cargando barbería', error);
        console.error('Error cargando barbería:', error);
        document.getElementById('nombreBarberia').textContent = 'Error de conexión';
    }
}


// Función para cargar la configuración de horarios
function cargarConfiguracionHorarios(barberia) {
    try {
        // Configuración por defecto
        const configDefault = {
            diasActivos: {
                lunes: true,
                martes: true,
                miercoles: true,
                jueves: true,
                viernes: true,
                sabado: true,
                domingo: false
            },
            horarios: {
                lunes: { manana: ['10:00', '10:30', '11:00', '11:30', '12:00', '12:30'], 
                         tarde: ['15:00', '15:30', '16:00', '16:30', '17:00', '17:30', '18:00', '18:30', '19:00', '19:30'] },
                martes: { manana: ['10:00', '10:30', '11:00', '11:30', '12:00', '12:30'], 
                          tarde: ['15:00', '15:30', '16:00', '16:30', '17:00', '17:30', '18:00', '18:30', '19:00', '19:30'] },
                miercoles: { manana: ['10:00', '10:30', '11:00', '11:30', '12:00', '12:30'], 
                             tarde: ['15:00', '15:30', '16:00', '16:30', '17:00', '17:30', '18:00', '18:30', '19:00', '19:30'] },
                jueves: { manana: ['10:00', '10:30', '11:00', '11:30', '12:00', '12:30'], 
                          tarde: ['15:00', '15:30', '16:00', '16:30', '17:00', '17:30', '18:00', '18:30', '19:00', '19:30'] },
                viernes: { manana: ['10:00', '10:30', '11:00', '11:30', '12:00', '12:30'], 
                           tarde: ['15:00', '15:30', '16:00', '16:30', '17:00', '17:30', '18:00', '18:30', '19:00', '19:30'] },
                sabado: { manana: ['10:00', '10:30', '11:00', '11:30', '12:00', '12:30'], 
                          tarde: ['15:00', '15:30', '16:00', '16:30', '17:00', '17:30', '18:00'] },
                domingo: { manana: [], tarde: [] }
            },
            mensajes: {
                lunes: '',
                martes: '',
                miercoles: '',
                jueves: '',
                viernes: '',
                sabado: '',
                domingo: ''
            },
            mensajeGlobal: '',
            duracionCita: 30
        };
        
        // Si existe configuración personalizada en la BD
        if (barberia.configuracion_horarios) {
            // Log de la configuración original
            debug('🔍 Configuración original:', barberia.configuracion_horarios);
            
            let config = barberia.configuracion_horarios;
            
            // Si la configuración es un string (JSON), intentar parsearlo
            if (typeof config === 'string') {
                try {
                    config = JSON.parse(config);
                    debug('✅ Configuración parseada de string JSON');
                } catch (e) {
                    debug('❌ Error parseando JSON de configuración', e);
                    config = {}; // Resetear a objeto vacío si hay error
                }
            }
            
            // Convertir el nuevo formato al formato que espera el sistema
            if (config.dias && !config.diasActivos) {
                debug('🔄 Detectado formato nuevo de configuración, convirtiendo...');
                
                try {
                    // Duración de citas
                    const duracionCitasConfig = parseInt(config.duracion_citas) || 30;
                    
                    // Crear estructura base convertida
                    const nuevaConfig = {
                        diasActivos: {},
                        horarios: {},
                        mensajes: {},
                        duracionCita: duracionCitasConfig,
                        mensajeGlobal: ''
                    };
                    
                    // Convertir cada día
                    const dias = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'];
                    dias.forEach(dia => {
                        if (!config.dias[dia]) {
                            // Si no existe el día, usar valores por defecto
                            nuevaConfig.diasActivos[dia] = configDefault.diasActivos[dia];
                            nuevaConfig.horarios[dia] = configDefault.horarios[dia];
                            nuevaConfig.mensajes[dia] = '';
                            return; // Continuar con el siguiente día
                        }
                        
                        // Estado activo del día
                        nuevaConfig.diasActivos[dia] = config.dias[dia].activo || false;
                        
                        // Inicializar horarios para este día
                        nuevaConfig.horarios[dia] = { manana: [], tarde: [] };
                        
                        // Procesar horarios de mañana
                        if (config.dias[dia].manana && config.dias[dia].manana.activo) {
                            const desde = config.dias[dia].manana.desde || '10:00';
                            const hasta = config.dias[dia].manana.hasta || '13:00';
                            nuevaConfig.horarios[dia].manana = generarHorariosEnRango(desde, hasta, duracionCitasConfig);
                            
                            // Mensaje de mañana
                            if (config.dias[dia].manana.mensaje) {
                                nuevaConfig.mensajes[dia] = config.dias[dia].manana.mensaje;
                            }
                        }
                        
                        // Procesar horarios de tarde
                        if (config.dias[dia].tarde && config.dias[dia].tarde.activo) {
                            const desde = config.dias[dia].tarde.desde || '15:00';
                            const hasta = config.dias[dia].tarde.hasta || '20:00';
                            nuevaConfig.horarios[dia].tarde = generarHorariosEnRango(desde, hasta, duracionCitasConfig);
                            
                            // Si no hay mensaje de mañana, usar el de tarde
                            if (config.dias[dia].tarde.mensaje && !nuevaConfig.mensajes[dia]) {
                                nuevaConfig.mensajes[dia] = config.dias[dia].tarde.mensaje;
                            }
                        }
                    });
                    
                    debug('✅ Configuración convertida exitosamente:', nuevaConfig);
                    config = nuevaConfig;
                } catch (e) {
                    debug('❌ Error convirtiendo formato de configuración', e);
                    // Mantener el objeto original y continuar
                }
            }
            
            // Validar estructura completa y normalizar
            let configNormalizada = {
                diasActivos: config.diasActivos || configDefault.diasActivos,
                horarios: config.horarios || configDefault.horarios,
                mensajes: config.mensajes || configDefault.mensajes,
                mensajeGlobal: config.mensajeGlobal || '',
                duracionCita: parseInt(config.duracionCita) || 30
            };
            
            // Asegurarse que cada día tiene estructura correcta
            const dias = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'];
            dias.forEach(dia => {
                // Si no existe el día en horarios, usar default
                if (!configNormalizada.horarios[dia]) {
                    configNormalizada.horarios[dia] = configDefault.horarios[dia];
                }
                
                // Asegurar que manana y tarde sean arrays
                if (!Array.isArray(configNormalizada.horarios[dia].manana)) {
                    configNormalizada.horarios[dia].manana = configDefault.horarios[dia].manana;
                }
                
                if (!Array.isArray(configNormalizada.horarios[dia].tarde)) {
                    configNormalizada.horarios[dia].tarde = configDefault.horarios[dia].tarde;
                }
                
                // Si no existe el día en mensajes, usar default
                if (typeof configNormalizada.mensajes[dia] === 'undefined') {
                    configNormalizada.mensajes[dia] = '';
                }
                
                // Si no existe el día en diasActivos, usar default
                if (typeof configNormalizada.diasActivos[dia] === 'undefined') {
                    configNormalizada.diasActivos[dia] = configDefault.diasActivos[dia];
                }
            });
            
            configuracionHorarios = configNormalizada;
            debug('✅ Configuración normalizada', configuracionHorarios);
            
            // Establecer duración de cita
            duracionCita = configuracionHorarios.duracionCita;
            debug('⏱️ Duración de cita:', duracionCita + ' minutos');
            
        } else {
            // Usar configuración por defecto
            debug('⚠️ No hay configuración personalizada, usando valores por defecto');
            configuracionHorarios = configDefault;
        }
        
        // Log final para debug
        debug('📊 Configuración final:', {
            tieneHorarios: !!configuracionHorarios.horarios,
            tieneDiasActivos: !!configuracionHorarios.diasActivos,
            tieneMensajes: !!configuracionHorarios.mensajes,
            horarioLunes: JSON.stringify(configuracionHorarios.horarios?.lunes || {}),
            diasActivos: JSON.stringify(configuracionHorarios.diasActivos || {})
        });
        
    } catch (error) {
        debug('❌ Error procesando configuración de horarios', error);
        // En caso de error, usar configuración por defecto
        configuracionHorarios = {
            diasActivos: {
                lunes: true,
                martes: true,
                miercoles: true,
                jueves: true,
                viernes: true,
                sabado: true,
                domingo: false
            },
            horarios: {
                lunes: { manana: HORARIOS_MAÑANA, tarde: HORARIOS_TARDE },
                martes: { manana: HORARIOS_MAÑANA, tarde: HORARIOS_TARDE },
                miercoles: { manana: HORARIOS_MAÑANA, tarde: HORARIOS_TARDE },
                jueves: { manana: HORARIOS_MAÑANA, tarde: HORARIOS_TARDE },
                viernes: { manana: HORARIOS_MAÑANA, tarde: HORARIOS_TARDE },
                sabado: { manana: HORARIOS_MAÑANA, tarde: HORARIOS_TARDE },
                domingo: { manana: [], tarde: [] }
            },
            mensajes: {
                lunes: '',
                martes: '',
                miercoles: '',
                jueves: '',
                viernes: '',
                sabado: '',
                domingo: ''
            },
            mensajeGlobal: '',
            duracionCita: 30
        };
    }
}

// Función para generar horarios en un rango
function generarHorariosEnRango(desde, hasta, duracion) {
    const horarios = [];
    
    // Validar entrada
    if (!desde || !hasta || !duracion) {
        debug('⚠️ Parámetros inválidos para generarHorariosEnRango');
        return horarios;
    }
    
    try {
        // Convertir strings a objetos Date
        let [horaDesde, minDesde] = desde.split(':').map(Number);
        let [horaHasta, minHasta] = hasta.split(':').map(Number);
        
        // Validar horas
        if (isNaN(horaDesde) || isNaN(minDesde) || isNaN(horaHasta) || isNaN(minHasta)) {
            debug('⚠️ Formato de hora inválido en generarHorariosEnRango');
            return horarios;
        }
        
        // Tiempo actual en minutos desde el inicio del día
        let tiempoActual = horaDesde * 60 + minDesde;
        const tiempoFin = horaHasta * 60 + minHasta;
        
        // Generar horarios
        while (tiempoActual < tiempoFin) {
            const hora = Math.floor(tiempoActual / 60);
            const minuto = tiempoActual % 60;
            horarios.push(`${hora.toString().padStart(2, '0')}:${minuto.toString().padStart(2, '0')}`);
            tiempoActual += duracion;
        }
        
        debug(`✅ Generados ${horarios.length} horarios entre ${desde} y ${hasta}`);
    } catch (e) {
        debug('❌ Error en generarHorariosEnRango', e);
    }
    
    return horarios;
}

        // FUNCIÓN CORREGIDA: Cargar barberos  
        async function cargarBarberos() {
            debug('👥 Cargando barberos...');
            
            try {
                // QUERY SIMPLIFICADA
                const { data, error } = await supabase
                    .from('usuarios')
                    .select('*')  // Todo para debug
                    .eq('barberia_id', barberiaId);
                    // ❌ REMOVIDO filtro activo por ahora

                debug('Respuesta barberos', { data, error });

                if (error) {
                    debug('❌ Error cargando barberos', error);
                    throw error;
                }

                if (data && data.length > 0) {
                    // Filtrar solo activos en JavaScript
                    const barberosActivos = data.filter(b => b.activo === true);
                    debug('✅ Barberos activos encontrados', barberosActivos);
                    
                    barberosDisponibles = barberosActivos;
                    
                    // 🆕 CARGAR HORARIOS DE CADA BARBERO
                    await cargarHorariosBarberos(barberosActivos);
                    
                    generarCardsBarberos(barberosActivos);
                } else {
                    debug('❌ No hay barberos para esta barbería');
                    const container = document.getElementById('barberosContainer');
                    container.innerHTML = '<div class="text-center text-red-500 p-4">❌ No hay barberos disponibles</div>';
                }
                
            } catch (error) {
                debug('❌ Error crítico cargando barberos', error);
                console.error('Error cargando barberos:', error);
            }
        }
        // 🆕 FUNCIÓN: Cargar horarios configurados de los barberos
async function cargarHorariosBarberos(barberos) {
    debug('📅 Cargando horarios de barberos...');
    
    try {
        // Cargar horarios de TODOS los barberos de una vez
        const { data: horarios, error } = await supabase
            .from('horarios_barberos')
            .select('*')
            .eq('barberia_id', barberiaId)
            .eq('activo', true);
        
        if (error) {
            debug('❌ Error cargando horarios', error);
            return;
        }
        
        debug('✅ Horarios cargados', horarios);
        
        // Organizar horarios por barbero_id
        const horariosPorBarbero = {};
        
        if (horarios && horarios.length > 0) {
            horarios.forEach(h => {
                if (!horariosPorBarbero[h.barbero_id]) {
                    horariosPorBarbero[h.barbero_id] = {};
                }
                horariosPorBarbero[h.barbero_id][h.dia_semana] = h;
            });
        }
        
        // Asignar horarios a cada barbero
        barberos.forEach(barbero => {
            barbero.horarios = horariosPorBarbero[barbero.id] || {};
        });
        
        debug('✅ Horarios asignados a barberos', barberos);
        
    } catch (error) {
        debug('❌ Error crítico cargando horarios', error);
        console.error('Error cargando horarios:', error);
    }
}

        function generarCardsBarberos(barberos) {
            const container = document.getElementById('barberosContainer');
            container.innerHTML = '';

            if (!barberos || barberos.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 p-4">❌ No hay barberos disponibles</div>';
                return;
            }

            barberos.forEach((barbero, index) => {
                const iconos = ['fas fa-user-tie', 'fas fa-male', 'fas fa-user-graduate'];
                const colores = ['from-blue-400 to-blue-600', 'from-purple-400 to-purple-600', 'from-green-400 to-green-600'];
                
                const card = document.createElement('div');
                card.className = 'barbero-card';
                card.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <div class="bg-gradient-to-r ${colores[index % colores.length]} w-12 h-12 rounded-full flex items-center justify-center text-white">
                            <i class="${iconos[index % iconos.length]}"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-bold text-gray-800">${barbero.nombre}</h3>
                            <p class="text-gray-500 text-sm">Barbero profesional</p>
                        </div>
                        <div class="text-green-500">
                            <i class="fas fa-check-circle hidden selected-icon"></i>
                        </div>
                    </div>
                `;
                card.onclick = () => seleccionarBarbero(barbero.id, card);
                container.appendChild(card);
            });
        }

        function seleccionarBarbero(barberoId, cardElement) {
            debug('👤 Barbero seleccionado', barberoId);
            
            // Limpiar selección previa
            document.querySelectorAll('.barbero-card').forEach(card => {
                card.classList.remove('selected');
                card.querySelector('.selected-icon').classList.add('hidden');
            });

            // Seleccionar nuevo barbero
            cardElement.classList.add('selected');
            cardElement.querySelector('.selected-icon').classList.remove('hidden');
            
            barberoSeleccionado = barberoId;
            actualizarProgreso(3);
            mostrarPaso3();
        }

       function generarCalendario() {
    const año = mesVisualizando.getFullYear();
    const mes = mesVisualizando.getMonth();
    
    // Actualizar header
    const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                  'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
    document.getElementById('mesActual').textContent = `${meses[mes]} ${año}`;
    
    // Obtener primer día del mes y días en el mes
    const primerDia = new Date(año, mes, 1);
    const ultimoDia = new Date(año, mes + 1, 0);
    const diasEnMes = ultimoDia.getDate();
    
    // Ajustar inicio del calendario (Lunes = 0)
    const inicioSemana = primerDia.getDay();
    const diasInicioCalendario = inicioSemana === 0 ? 6 : inicioSemana - 1;
    
    const container = document.getElementById('calendarioDias');
    container.innerHTML = '';
    
    // Días del mes anterior
    const mesAnterior = new Date(año, mes, 0);
    for (let i = diasInicioCalendario; i > 0; i--) {
        const dia = mesAnterior.getDate() - i + 1;
        const btn = crearDiaCalendario(dia, true, false, false);
        container.appendChild(btn);
    }
    
    // Días del mes actual
    const hoy = new Date();
    for (let dia = 1; dia <= diasEnMes; dia++) {
        const fechaDia = new Date(año, mes, dia);
        const esPasado = fechaDia < hoy;
        const esHoy = fechaDia.toDateString() === hoy.toDateString();
        
        // Verificar si el día está activo según configuración
        const esInactivo = !esDiaActivo(fechaDia);
        
        // Un día está inhabilitado si es pasado o está inactivo en la configuración
        const estaInhabilitado = esPasado || esInactivo;
        
        const btn = crearDiaCalendario(dia, false, estaInhabilitado, esHoy);
        
        // Si no está inhabilitado, permitir la selección
        if (!estaInhabilitado) {
            btn.onclick = () => seleccionarFecha(año, mes, dia);
            
            // Si hay un mensaje para este día, agregar tooltip
            if (configuracionHorarios && configuracionHorarios.mensajes) {
                const diaSemana = fechaDia.getDay();
                const nombresDias = ['domingo', 'lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado'];
                const nombreDia = nombresDias[diaSemana];
                
                if (configuracionHorarios.mensajes[nombreDia]) {
                    btn.title = configuracionHorarios.mensajes[nombreDia];
                    btn.classList.add('tiene-mensaje');
                    // Añadir indicador visual sutil
                    const indicador = document.createElement('div');
                    indicador.className = 'w-1 h-1 bg-green-500 rounded-full absolute bottom-1 right-1';
                    btn.appendChild(indicador);
                }
            }
        }
        
        container.appendChild(btn);
    }
    
    // Días del mes siguiente para completar la grilla
    const diasEnCalendario = container.children.length;
    const diasFaltantes = 42 - diasEnCalendario; // 6 semanas × 7 días
    for (let dia = 1; dia <= Math.min(diasFaltantes, 14); dia++) {
        const btn = crearDiaCalendario(dia, true, false, false);
        container.appendChild(btn);
    }
}

        function crearDiaCalendario(dia, esOtroMes, esInhabilitado, esHoy) {
            const btn = document.createElement('div');
            btn.className = 'dia-calendario';
            btn.textContent = dia;
            
            if (esOtroMes) {
                btn.classList.add('mes-otro', 'dia-pasado');
            } else if (esInhabilitado) {
                const esDomingo = new Date(mesVisualizando.getFullYear(), mesVisualizando.getMonth(), dia).getDay() === 0;
                btn.classList.add(esDomingo ? 'dia-domingo' : 'dia-pasado');
            } else {
                btn.classList.add('dia-disponible');
                if (esHoy) {
                    btn.classList.add('ring-2', 'ring-yellow-400');
                }
            }
            
            return btn;
        }

        function cambiarMes(direccion) {
            mesVisualizando.setMonth(mesVisualizando.getMonth() + direccion);
            
            // No permitir ir a meses pasados
            const hoy = new Date();
            if (mesVisualizando.getFullYear() < hoy.getFullYear() || 
                (mesVisualizando.getFullYear() === hoy.getFullYear() && mesVisualizando.getMonth() < hoy.getMonth())) {
                mesVisualizando = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
            }
            
            generarCalendario();
        }

        function seleccionarFecha(año, mes, dia) {
            debug('📅 Fecha seleccionada', `${año}-${mes+1}-${dia}`);
            
            // Limpiar selección previa
            document.querySelectorAll('.dia-seleccionado').forEach(el => {
                el.classList.remove('dia-seleccionado');
                el.classList.add('dia-disponible');
            });
            
            // Seleccionar nuevo día
            event.target.classList.remove('dia-disponible');
            event.target.classList.add('dia-seleccionado');
            
            // Establecer fecha seleccionada
            const fecha = new Date(año, mes, dia);
            const fechaString = fecha.toISOString().split('T')[0];
            
            document.getElementById('fechaSeleccionada').value = fechaString;
            fechaSeleccionada = fechaString;
            
            // Cargar horarios después de un pequeño delay para el efecto visual
            setTimeout(() => {
                cargarHorarios();
            }, 300);
        }

      function cargarHorarios() {
    const fecha = document.getElementById('fechaSeleccionada').value;
    if (!fecha) return;

    debug('⏰ Cargando horarios para', fecha);
    
    fechaSeleccionada = fecha;
    const fechaObj = new Date(fecha + 'T00:00:00');
    
    // Verificar si el día está activo según configuración
    if (!esDiaActivo(fechaObj)) {
        alert('❌ Este día no está disponible para reservas. Por favor selecciona otro día.');
        document.getElementById('fechaSeleccionada').value = '';
        return;
    }

    // Obtener horarios según configuración
    const horariosConfiguracion = obtenerHorariosPorDia(fechaObj);
    
    // Usar horarios de la configuración o los valores por defecto
    let horariosMañanaDisponibles = horariosConfiguracion.manana.length > 0 
                                  ? horariosConfiguracion.manana 
                                  : HORARIOS_MAÑANA;
    
    let horariosTardeDisponibles = horariosConfiguracion.tarde.length > 0 
                                 ? horariosConfiguracion.tarde 
                                 : HORARIOS_TARDE;
    
    debug('📅 Horarios cargados de configuración:', {
        mañana: horariosMañanaDisponibles,
        tarde: horariosTardeDisponibles
    });
    
    // Verificar si es hoy para filtrar horarios pasados
    const hoy = new Date().toISOString().split('T')[0];
    const esHoy = fecha === hoy;
    
    // Si es HOY, filtrar horarios que ya pasaron
    if (esHoy) {
        const ahora = new Date();
        const horaActual = ahora.getHours();
        const minutoActual = ahora.getMinutes();
        const tiempoActual = horaActual * 60 + minutoActual;
        
        debug('🕐 Es hoy - Hora actual:', `${horaActual}:${minutoActual.toString().padStart(2, '0')}`);
        
        // Filtrar horarios mañana
        horariosMañanaDisponibles = horariosMañanaDisponibles.filter(hora => {
            const [h, m] = hora.split(':').map(Number);
            const tiempoHorario = h * 60 + m;
            return tiempoHorario > tiempoActual + 30; // 30 min de buffer
        });
        
        // Filtrar horarios tarde
        horariosTardeDisponibles = horariosTardeDisponibles.filter(hora => {
            const [h, m] = hora.split(':').map(Number);
            const tiempoHorario = h * 60 + m;
            return tiempoHorario > tiempoActual + 30; // 30 min de buffer
        });
        
        debug('⏰ Horarios disponibles hoy después de filtrar:', {
            mañana: horariosMañanaDisponibles.length,
            tarde: horariosTardeDisponibles.length
        });
    }
    
    // Mostrar mensaje del día si existe
    const nombresDias = ['domingo', 'lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado'];
    const nombreDia = nombresDias[fechaObj.getDay()];
    const mensajeDia = configuracionHorarios?.mensajes?.[nombreDia];
    
    if (mensajeDia) {
        // Crear o actualizar el mensaje del día
        let mensajeDiv = document.getElementById('mensajeDia');
        if (!mensajeDiv) {
            mensajeDiv = document.createElement('div');
            mensajeDiv.id = 'mensajeDia';
            mensajeDiv.className = 'bg-purple-100 text-purple-800 p-3 rounded-lg text-sm mb-4';
            document.getElementById('horariosContainer').prepend(mensajeDiv);
        }
        
        mensajeDiv.innerHTML = `<i class="fas fa-info-circle mr-2"></i>${mensajeDia}`;
        mensajeDiv.style.display = 'block';
    } else {
        // Ocultar mensaje si no hay
        const mensajeDiv = document.getElementById('mensajeDia');
        if (mensajeDiv) {
            mensajeDiv.style.display = 'none';
        }
    }

    // Mostrar contenedor de horarios
    document.getElementById('horariosContainer').style.display = 'block';
    
    // Generar slots de horarios según duración configurada
    if (horariosMañanaDisponibles.length > 0) {
        document.querySelector('#horariosContainer > div:first-child').style.display = 'block';
        generarHorarios('horariosMañana', horariosMañanaDisponibles);
    } else {
        document.querySelector('#horariosContainer > div:first-child').style.display = 'none';
    }
    
    if (horariosTardeDisponibles.length > 0) {
        document.querySelector('#horariosContainer > div:nth-child(2)').style.display = 'block';
        generarHorarios('horariosTarde', horariosTardeDisponibles);
    } else {
        document.querySelector('#horariosContainer > div:nth-child(2)').style.display = 'none';
    }
}

 function generarHorarios(containerId, horarios) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    
    if (horarios.length === 0) {
        container.innerHTML = '<div class="text-gray-500 text-center p-3">No hay horarios disponibles</div>';
        return;
    }
    
    // Actualizar el título del contenedor con la duración
    const tituloContainer = container.closest('div').querySelector('.flex.items-center');
    if (tituloContainer) {
        const spanDuracion = tituloContainer.querySelector('.duracion-cita');
        if (spanDuracion && duracionCita) {
            spanDuracion.textContent = `(${duracionCita} min por cita)`;
        }
    }

    // Determinar los horarios principales en función del contenedor
    let horariosTexto = '10:00 - 12:30';
    if (containerId === 'horariosTarde') {
        horariosTexto = '15:00 - 20:00';
    }
    
    // Determinar el primer y último horario
    if (horarios.length > 0) {
        const horariosSorted = [...horarios].sort();
        const primero = horariosSorted[0];
        const ultimo = horariosSorted[horariosSorted.length - 1];
        horariosTexto = `${primero} - ${ultimo}`;
    }
    
    // Actualizar el título con el rango real de horarios
    if (tituloContainer) {
        const spanPrincipal = tituloContainer.querySelector('span.font-bold');
        if (spanPrincipal) {
            spanPrincipal.textContent = 
                containerId === 'horariosMañana' ? `Mañana (${horariosTexto})` : `Tarde (${horariosTexto})`;
        }
    }

    horarios.forEach(hora => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'slot-disponible px-3 py-3 rounded-xl text-sm font-bold';
        btn.textContent = hora;
        
        // Si hay duración configurada, añadir información
        if (duracionCita && duracionCita > 0) {
            const [horas, minutos] = hora.split(':').map(Number);
            const finMinutos = minutos + duracionCita;
            const finHoras = horas + Math.floor(finMinutos / 60);
            const finMinutosAjustados = finMinutos % 60;
            
            const horaFin = `${finHoras.toString().padStart(2, '0')}:${finMinutosAjustados.toString().padStart(2, '0')}`;
            
            // Título para tooltip nativo
            btn.title = `${hora} - ${horaFin} (${duracionCita} min)`;
            
            // Añadir clase para badge visual y atributo data-info
            btn.classList.add('slot-con-info');
            btn.setAttribute('data-info', `${duracionCita}m`);
            
            // Para duraciones largas (45+ min) mostrar rango completo
            if (duracionCita >= 45) {
                btn.innerHTML = `${hora}<br><span class="text-xs text-gray-100">hasta ${horaFin}</span>`;
            }
        }
        
        btn.onclick = () => seleccionarHorario(hora, btn);
        container.appendChild(btn);
    });
}

function seleccionarHorario(hora, elemento) {
    debug('⏰ Horario seleccionado', hora);
    
    document.querySelectorAll('.slot-seleccionado').forEach(el => {
        el.classList.remove('slot-seleccionado');
        el.classList.add('slot-disponible');
    });

    elemento.classList.remove('slot-disponible');
    elemento.classList.add('slot-seleccionado');
    
    // Guardar hora seleccionada y calcular hora fin
    horarioSeleccionado = hora;
    
    // Calcular hora fin para mostrar en pasos siguientes
    if (duracionCita > 0) {
        const [horas, minutos] = hora.split(':').map(Number);
        const finMinutos = minutos + duracionCita;
        const finHoras = horas + Math.floor(finMinutos / 60);
        const finMinutosAjustados = finMinutos % 60;
        const horaFin = `${finHoras.toString().padStart(2, '0')}:${finMinutosAjustados.toString().padStart(2, '0')}`;
        
        // Guardar en sessionStorage para uso posterior
        window.sessionStorage.setItem('horaFinSeleccionada', horaFin);
        window.sessionStorage.setItem('duracionCita', duracionCita.toString());
    }
    
    // Verificar disponibilidad de barberos antes de mostrar paso 2
    verificarBarberosDisponibles(fechaSeleccionada, hora);
}

       function mostrarPaso2() {
    if (!horarioSeleccionado) return;
    debug('➡️ Mostrando paso 2 - Barberos');
    document.getElementById('paso2').style.display = 'block';
    document.getElementById('paso2').scrollIntoView({ behavior: 'smooth', block: 'center' });
}

// Función para verificar disponibilidad de barberos
function verificarBarberosDisponibles(fecha, hora) {
    debug('👥 Verificando barberos disponibles para', fecha, hora);
    
    // Mostrar indicador de carga en el contenedor de barberos
    const barberosContainer = document.getElementById('barberosContainer');
    barberosContainer.innerHTML = `
        <div class="text-center p-4">
            <div class="animate-spin rounded-full h-8 w-8 border-2 border-blue-500 border-t-transparent mx-auto mb-2"></div>
            <p class="text-gray-600">Verificando disponibilidad...</p>
        </div>
    `;
    
    // 1. Obtener todos los barberos activos
    supabase.from('usuarios')
        .select('*')
        .eq('barberia_id', barberiaId)
        .eq('activo', true)
        .then(respuestaBarberos => {
            if (respuestaBarberos.error) {
                debug('❌ Error al cargar barberos:', respuestaBarberos.error);
                mostrarErrorBarberos('Error al cargar barberos');
                return;
            }
            
            const todosBarberos = respuestaBarberos.data || [];
            
            if (todosBarberos.length === 0) {
                debug('⚠️ No hay barberos activos');
                mostrarErrorBarberos('No hay barberos disponibles');
                return;
            }
            
            // 2. Obtener reservas existentes para esa fecha y hora
            supabase.from('reservas')
                .select('barbero_id')
                .eq('fecha', fecha)
                .eq('hora', hora)
                .neq('estado', 'cancelada')
                .then(respuestaReservas => {
                    if (respuestaReservas.error) {
                        debug('❌ Error al verificar reservas:', respuestaReservas.error);
                        // Mostramos todos los barberos si hay error en la verificación
                        generarCardsBarberos(todosBarberos);
                        mostrarPaso2();
                        return;
                    }
                    
                    const reservasExistentes = respuestaReservas.data || [];
                    const barberosOcupados = reservasExistentes.map(r => r.barbero_id);
                    
                    debug('👥 Barberos ocupados:', barberosOcupados);
                    
                    // Filtrar solo barberos disponibles
                    const barberosDisponibles = todosBarberos.filter(
                        barbero => !barberosOcupados.includes(barbero.id)
                    );
                    
                    debug('👥 Barberos disponibles:', barberosDisponibles);
                    
                    if (barberosDisponibles.length === 0) {
                        // Ningún barbero disponible en este horario
                        mostrarMensajeNingunBarberoDisponible();
                        return;
                    }
                    
                    // Actualizar la lista global de barberos disponibles
                    window.barberosDisponibles = barberosDisponibles;
                    
                    // Generar cards con barberos disponibles
                    generarCardsBarberos(barberosDisponibles);
                    mostrarPaso2();
                });
        });
}

// Función para mostrar mensaje cuando no hay barberos disponibles
function mostrarMensajeNingunBarberoDisponible() {
    const barberosContainer = document.getElementById('barberosContainer');
    barberosContainer.innerHTML = `
        <div class="text-center p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
            <i class="fas fa-exclamation-circle text-yellow-500 text-xl mb-2"></i>
            <h3 class="font-bold text-gray-700 mb-1">Sin disponibilidad en este horario</h3>
            <p class="text-gray-600 mb-3">Todos los barberos están ocupados a esta hora.</p>
            <button onclick="volverAHorarios()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                <i class="fas fa-clock mr-2"></i>Elegir otro horario
            </button>
        </div>
    `;
    mostrarPaso2();
}

// Función para volver a selección de horarios
function volverAHorarios() {
    // Ocultar paso 2
    document.getElementById('paso2').style.display = 'none';
    
    // Limpiar selección de horario
    document.querySelectorAll('.slot-seleccionado').forEach(el => {
        el.classList.remove('slot-seleccionado');
        el.classList.add('slot-disponible');
    });
    
    horarioSeleccionado = null;
    
    // Actualizar progreso
    actualizarProgreso(1);
    
    // Scroll al contenedor de horarios
    document.getElementById('horariosContainer').scrollIntoView({ behavior: 'smooth' });
}

// Función para mostrar error de barberos
function mostrarErrorBarberos(mensaje) {
    const barberosContainer = document.getElementById('barberosContainer');
    barberosContainer.innerHTML = `
        <div class="text-center p-4 bg-red-50 border border-red-200 rounded-lg">
            <i class="fas fa-times-circle text-red-500 text-xl mb-2"></i>
            <h3 class="font-bold text-gray-700 mb-1">Error</h3>
            <p class="text-gray-600">${mensaje}</p>
        </div>
    `;
    mostrarPaso2();
}

        function mostrarPaso3() {
            if (!barberoSeleccionado) return;
            debug('➡️ Mostrando paso 3 - Datos cliente');
            document.getElementById('paso3').style.display = 'block';
            document.getElementById('paso3').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function actualizarProgreso(paso) {
            debug(`📊 Actualizando progreso a paso ${paso}`);
            
            // Actualizar indicadores
            for (let i = 1; i <= paso; i++) {
                const indicator = document.getElementById(`indicator${i}`);
                indicator.classList.add('paso-completado');
                indicator.classList.remove('opacity-50');
            }

            // Actualizar barras de progreso
            const progresos = {1: '33%', 2: '66%', 3: '100%'};
            for (let i = 1; i <= paso; i++) {
                const progressBar = document.getElementById(`progress${i}`);
                if (progressBar) {
                    progressBar.style.width = progresos[i] || '0%';
                }
            }
        }

        // Inicializar EmailJS
        emailjs.init("SjpK9JgdTw7BDd637"); // Tu Public Key
// Configuración de Email IDs
const EMAIL_CONFIG = {
    SERVICE_ID: "service_17obuvl", // Volver al servicio original
    TEMPLATE_CLIENTE_ID: "template_kawuoqv", // Usar la plantilla original
    TEMPLATE_ADMIN_ID: "template_lo8zvu5" // O el ID que corresponda para admin
};
        // Manejar envío del formulario
        document.getElementById('formReserva').addEventListener('submit', async (e) => {
            e.preventDefault();
            await procesarReserva();
        });

      async function procesarReserva() {
    debug('📝 Procesando reserva...');
    
    const loading = document.getElementById('loading');
    loading.classList.remove('hidden');

    try {
        const nombre = document.getElementById('clienteNombre').value;
        const telefono = document.getElementById('clienteTelefono').value;
        const email = document.getElementById('clienteEmail').value;
        const notas = document.getElementById('clienteNotas').value;

        const barbero = barberosDisponibles.find(b => b.id === barberoSeleccionado);
        
        // Recuperar datos adicionales de horario
        const horaFin = window.sessionStorage.getItem('horaFinSeleccionada') || '';
        
        const reserva = {
            fecha: fechaSeleccionada,
            hora: horarioSeleccionado,
            hora_fin: horaFin,
            duracion_minutos: duracionCita || 30,
            barberia_id: barberiaId,
            barberia_nombre: barberiaData.nombre,
            barbero_id: barberoSeleccionado,
            barbero_nombre: barbero.nombre,
            cliente_nombre: nombre,
            cliente_telefono: telefono,
            cliente_email: email || null,
            notas: notas || null,
            origen: origenInterno ? 'interno' : 'web',
            created_at: new Date().toISOString()
        };

        debug('💾 Datos de reserva a guardar', reserva);

        // Guardar en Supabase
        const reservaGuardada = await guardarReserva(reserva);
        
        // Enviar email al cliente si proporcionó dirección
        let emailClienteEnviado = false;
        if (email) {
            debug('📧 Enviando confirmación por email al cliente...');
            emailClienteEnviado = await enviarEmailConfirmacion(reserva);
        }
        
     // Enviar notificación al administrador/barbería siempre
if (barberiaData.email_avisos) {
    debug('📧 Enviando notificación al administrador...');
    debug('📧 Email de notificación de la barbería: ' + barberiaData.email_avisos);
    await enviarEmailNotificacionAdmin(reserva, emailClienteEnviado);
}

        mostrarResumen(reserva);

    } catch (error) {
        debug('❌ Error procesando reserva', error);
        console.error('Error:', error);
        alert('❌ Error al procesar la reserva. Intenta nuevamente.');
    } finally {
        loading.classList.add('hidden');
    }
}

async function enviarEmailNotificacionAdmin(reserva, emailEnviado) {
    // Si no hay email de administrador/barbería, salir
    if (!barberiaData.email_avisos) {
        debug('⚠️ No hay email de administrador configurado');
        return false;
    }
    
    debug('📧 Email del administrador: ' + barberiaData.email_avisos);
    debug('📧 Service ID: ' + EMAIL_CONFIG.SERVICE_ID);
    debug('📧 Template ID Admin: ' + EMAIL_CONFIG.TEMPLATE_ADMIN_ID);
    
    try {
        debug('📧 Preparando notificación para administrador...');
        
        // Formatear fecha
        const fechaFormateada = new Date(reserva.fecha + 'T00:00:00').toLocaleDateString('es-CL', {
            weekday: 'long',
            day: 'numeric', 
            month: 'long',
            year: 'numeric'
        });
        
        // Recuperar datos adicionales de horario
        const horaFin = reserva.hora_fin || window.sessionStorage.getItem('horaFinSeleccionada') || '';
        const duracionMostrar = reserva.duracion_minutos || duracionCita || 30;
        
        // Construir texto de horario completo
        let horarioCompleto = reserva.hora;
        if (horaFin) {
            horarioCompleto += ` - ${horaFin}`;
        }
        if (duracionMostrar) {
            horarioCompleto += ` (${duracionMostrar} min)`;
        }

// Parámetros para el template de EmailJS - necesitan coincidir con los campos en la plantilla
const templateParams = {
    to_email: barberiaData.email_avisos, // Campo crítico para EmailJS - destinatario (CORREGIDO)
    to_name: 'Administrador', // Nombre del destinatario
    from_name: 'Sistema de Reservas', // Nombre del remitente
    origen: origenInterno ? 'Sistema interno' : 'Web pública',
    cliente_nombre: reserva.cliente_nombre,
    cliente_telefono: reserva.cliente_telefono,
    cliente_email: reserva.cliente_email || 'No proporcionado',
    fecha_formateada: fechaFormateada,
    hora: horarioCompleto,
    barbero_nombre: reserva.barbero_nombre,
    notas: reserva.notas || 'Sin notas',
    email_enviado: emailEnviado ? 'Sí' : 'No',
    barberia_nombre: barberiaData.nombre || 'Barbería'
};

debug('📧 Parámetros exactos para admin:', templateParams);
        
      try {
    // Enviar email usando EmailJS con IDs de la nueva cuenta
    const response = await emailjs.send(
        EMAIL_CONFIG.SERVICE_ID,         // Service ID
        EMAIL_CONFIG.TEMPLATE_ADMIN_ID,  // Template ID para ADMINISTRADOR
        templateParams
    );
    
    debug('✅ Notificación al admin enviada exitosamente', response);
    return true;
} catch (emailError) {
    // Capturar específicamente errores del envío de email
    debug('❌ Error específico enviando email al administrador', emailError);
    debug('❌ Mensaje de error: ' + emailError.message);
    throw emailError; // Re-lanzar para el manejo en el catch principal
}
        
    } catch (error) {
        debug('⚠️ Error enviando notificación al administrador', error);
        console.error('Error enviando notificación:', error);
        // No lanzar error - la notificación es opcional
        return false;
    }
}

async function guardarReserva(reserva) {
    debug('💾 Guardando reserva en Supabase...', reserva);
    
    try {
        // Preparar datos para Supabase (solo campos que existen en la tabla)
        const reservaData = {
            barberia_id: reserva.barberia_id,
            barbero_id: reserva.barbero_id,
            barbero_nombre: reserva.barbero_nombre,
            fecha: reserva.fecha,
            hora: reserva.hora,
            cliente_nombre: reserva.cliente_nombre,
            cliente_telefono: reserva.cliente_telefono,
            cliente_email: reserva.cliente_email || null,
            notas: reserva.notas || null,
            estado: 'pendiente',
            confirmada: false
            // Removidos los campos duracion_minutos y origen que no existen en la tabla
        };
        
        debug('📤 Enviando a Supabase:', reservaData);
        
        // Insertar en Supabase
        const { data, error } = await supabase
            .from('reservas')
            .insert([reservaData])
            .select()
            .single();
        
        if (error) {
            debug('❌ Error de Supabase', error);
            throw new Error('Error guardando reserva: ' + error.message);
        }
        
        debug('✅ Reserva guardada exitosamente en Supabase', data);
        
        // Si la reserva viene del sistema interno, marcarla como confirmada
        if (origenInterno) {
            const { error: errorUpdate } = await supabase
                .from('reservas')
                .update({ confirmada: true, estado: 'confirmada' })
                .eq('id', data.id);
                
            if (errorUpdate) {
                debug('⚠️ Error actualizando estado de confirmación', errorUpdate);
                // No lanzar error, ya que la reserva se guardó correctamente
            } else {
                debug('✅ Reserva marcada como confirmada (origen interno)');
            }
        }
        
        return data;
        
    } catch (error) {
        debug('❌ Error crítico guardando reserva', error);
        throw error; // Re-lanzar para manejo en procesarReserva
    }
}

  async function enviarEmailConfirmacion(reserva) {
    try {
        debug('📧 Preparando email de confirmación para cliente...');
        
        // Verificar si el email es válido
        if (!reserva.cliente_email) {
            debug('⚠️ No hay email de cliente para enviar confirmación');
            return false;
        }
        
        debug('📧 Email del cliente: ' + reserva.cliente_email);
        debug('📧 Service ID: ' + EMAIL_CONFIG.SERVICE_ID);
        debug('📧 Template ID Cliente: ' + EMAIL_CONFIG.TEMPLATE_CLIENTE_ID);
        
        // Formatear fecha para el email
        const fechaFormateada = new Date(reserva.fecha + 'T00:00:00').toLocaleDateString('es-CL', {
            weekday: 'long',
            day: 'numeric', 
            month: 'long',
            year: 'numeric'
        });
        
        // Recuperar datos adicionales de horario
        const horaFin = window.sessionStorage.getItem('horaFinSeleccionada') || '';
        const duracionMostrar = duracionCita || 30;
        
        // Construir texto de horario completo
        let horarioCompleto = reserva.hora;
        if (horaFin) {
            horarioCompleto += ` - ${horaFin}`;
        }
        if (duracionMostrar) {
            horarioCompleto += ` (${duracionMostrar} min)`;
        }
        
        // Parámetros para el template de EmailJS - necesitan coincidir con los campos en la plantilla
        const templateParams = {
            to_email: reserva.cliente_email, // Campo crítico para EmailJS - destinatario (CORREGIDO)
            to_name: reserva.cliente_nombre, // Nombre del destinatario
            from_name: barberiaData.nombre || 'Barbería', // Nombre del remitente
            cliente_nombre: reserva.cliente_nombre, 
            barberia_nombre: barberiaData.nombre || 'Barbería',
            barbero_nombre: reserva.barbero_nombre,
            fecha_formateada: fechaFormateada,
            hora: horarioCompleto,
            cliente_telefono: reserva.cliente_telefono,
            notas: reserva.notas || 'Sin notas especiales',
            origen: origenInterno ? 'Reserva realizada por el sistema' : 'Reserva realizada por el cliente'
        };

        debug('📧 Parámetros exactos:', templateParams);
        
        try {
            // Enviar email usando EmailJS con IDs de la nueva cuenta
            const response = await emailjs.send(
                EMAIL_CONFIG.SERVICE_ID,           // Usa el Service ID configurado
                EMAIL_CONFIG.TEMPLATE_CLIENTE_ID,  // Usa el Template ID para clientes  
                templateParams
            );
            
            debug('✅ Email enviado exitosamente al cliente', response);
            
            // Mostrar mensaje en la interfaz
            document.getElementById('mensajeEmail').style.display = 'block';
            document.getElementById('mensajeEmail').className = 'bg-green-100 bg-opacity-20 backdrop-blur-sm rounded-xl p-3 mb-4';
            document.getElementById('mensajeEmail').innerHTML = `
                <i class="fas fa-envelope mr-2"></i>
                <span class="text-sm">Confirmación enviada a ${reserva.cliente_email}</span>
            `;
            
            return true;
        } catch (emailError) {
            // Capturar específicamente errores del envío de email
            debug('❌ Error específico enviando email al cliente', emailError);
            debug('❌ Mensaje de error: ' + emailError.message);
            throw emailError; // Re-lanzar para el manejo en el catch principal
        }
        
    } catch (error) {
        debug('❌ Error enviando email al cliente', error);
        console.error('Error enviando email al cliente:', error);
        
        // Mostrar mensaje de error en la interfaz, pero no bloquear el flujo
        if (document.getElementById('mensajeEmail')) {
            document.getElementById('mensajeEmail').style.display = 'block';
            document.getElementById('mensajeEmail').className = 'bg-red-100 bg-opacity-20 backdrop-blur-sm rounded-xl p-3 mb-4';
            document.getElementById('mensajeEmail').innerHTML = `
                <i class="fas fa-exclamation-triangle text-red-300 mr-2"></i>
                <span class="text-sm">No se pudo enviar email de confirmación</span>
            `;
        }
        
        // No lanzar error - el email es opcional
        return false;
    }
}

  function mostrarResumen(reserva) {
    debug('📋 Mostrando resumen final');
    
    const fechaFormateada = new Date(reserva.fecha + 'T00:00:00').toLocaleDateString('es-CL', {
        weekday: 'long',
        day: 'numeric',
        month: 'long',
        year: 'numeric'
    });
    
    // Recuperar datos de duración y hora fin
    const duracionMostrar = window.sessionStorage.getItem('duracionCita') || duracionCita || 30;
    const horaFin = window.sessionStorage.getItem('horaFinSeleccionada') || '';
    
    // Construir texto de horario
    let horarioTexto = reserva.hora;
    if (horaFin) {
        horarioTexto += ` - ${horaFin}`;
    }
    if (duracionMostrar) {
        horarioTexto += ` (${duracionMostrar} min)`;
    }

    document.getElementById('detallesReserva').innerHTML = `
        <div class="space-y-3 text-white">
            <div class="flex items-center">
                <i class="fas fa-calendar-day w-6 text-white mr-3"></i>
                <span><strong>Fecha:</strong> ${fechaFormateada}</span>
            </div>
            <div class="flex items-center">
                <i class="fas fa-clock w-6 text-white mr-3"></i>
                <span><strong>Hora:</strong> ${horarioTexto}</span>
            </div>
            <div class="flex items-center">
                <i class="fas fa-user-tie w-6 text-white mr-3"></i>
                <span><strong>Barbero:</strong> ${reserva.barbero_nombre}</span>
            </div>
            <div class="flex items-center">
                <i class="fas fa-user w-6 text-white mr-3"></i>
                <span><strong>Cliente:</strong> ${reserva.cliente_nombre}</span>
            </div>
            <div class="flex items-center">
                <i class="fas fa-store w-6 text-white mr-3"></i>
                <span><strong>Barbería:</strong> ${reserva.barberia_nombre}</span>
            </div>
            ${reserva.notas ? `
                <div class="flex items-start">
                    <i class="fas fa-comment w-6 text-white mr-3 mt-1"></i>
                    <span><strong>Notas:</strong> ${reserva.notas}</span>
                </div>
            ` : ''}
        </div>
    `;

    if (reserva.cliente_email) {
        document.getElementById('mensajeEmail').style.display = 'block';
    }

    // Ocultar pasos y mostrar resumen
    document.getElementById('paso1').style.display = 'none';
    document.getElementById('paso2').style.display = 'none';
    document.getElementById('paso3').style.display = 'none';
    document.getElementById('resumenFinal').style.display = 'block';

    document.getElementById('resumenFinal').scrollIntoView({ behavior: 'smooth' });
    
    // Si viene del origen interno, añadir botón para volver al sistema
    if (origenInterno) {
        const botonesDiv = document.createElement('div');
        botonesDiv.className = 'mt-4';
        botonesDiv.innerHTML = `
            <button onclick="window.close()" class="w-full bg-white text-green-600 py-3 rounded-xl font-bold shadow-lg hover:bg-gray-100 transition-all duration-300 mt-2">
                <i class="fas fa-arrow-left mr-2"></i>Volver al Sistema
            </button>
        `;
        document.getElementById('resumenFinal').querySelector('.p-6').appendChild(botonesDiv);
    }
    
    debug('🎉 Proceso completado exitosamente');
}

       // Event listeners adicionales
document.addEventListener('DOMContentLoaded', () => {
    debug('🎬 DOM completamente cargado');
    
    // Comprobar si hay fecha preseleccionada en URL
    if (preseleccionarFecha) {
        debug('📅 Fecha preseleccionada detectada', preseleccionarFecha);
        try {
            const fechaObj = new Date(preseleccionarFecha + 'T00:00:00');
            if (!isNaN(fechaObj.getTime())) {
                // Establecer el mes visualizado a la fecha preseleccionada
                mesVisualizando = new Date(fechaObj.getFullYear(), fechaObj.getMonth(), 1);
                
                // Actualizar el calendario
                generarCalendario();
                
                // Simular clic en el día
                setTimeout(() => {
                    const dias = document.querySelectorAll('#calendarioDias .dia-calendario');
                    const diaObjetivo = Array.from(dias).find(dia => 
                        !dia.classList.contains('mes-otro') && 
                        parseInt(dia.textContent) === fechaObj.getDate()
                    );
                    
                    if (diaObjetivo && !diaObjetivo.classList.contains('dia-pasado') && !diaObjetivo.classList.contains('dia-domingo')) {
                        diaObjetivo.click();
                        debug('✅ Fecha preseleccionada aplicada automáticamente');
                    } else {
                        debug('⚠️ No se pudo aplicar la fecha preseleccionada (día no disponible)');
                    }
                }, 500);
            } else {
                debug('❌ Formato de fecha preseleccionada inválido');
            }
        } catch (error) {
            debug('❌ Error procesando fecha preseleccionada', error);
        }
    }
});

// Función para preseleccionar barbero automáticamente
function preseleccionarBarberoAutomaticamente() {
    if (preseleccionarBarbero && barberosDisponibles.length > 0) {
        debug('👤 Barbero preseleccionado detectado', preseleccionarBarbero);
        
        // Buscar el barbero en la lista
        const barberoBuscado = barberosDisponibles.find(b => b.id === preseleccionarBarbero);
        
        if (barberoBuscado) {
            setTimeout(() => {
                // Buscar la card del barbero y simular clic
                const barberosCards = document.querySelectorAll('.barbero-card');
                const index = barberosDisponibles.findIndex(b => b.id === preseleccionarBarbero);
                
                if (index >= 0 && barberosCards[index]) {
                    barberosCards[index].click();
                    debug('✅ Barbero preseleccionado aplicado automáticamente');
                    
                    // Forzar scroll al paso 3
                    document.getElementById('paso3').scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    debug('⚠️ No se encontró la card del barbero preseleccionado');
                }
            }, 1000);
        } else {
            debug('⚠️ ID de barbero preseleccionado no encontrado en la lista');
        }
    }
}

// Manejo de errores globales
window.addEventListener('error', (e) => {
    debug('❌ Error global capturado', e.error);
});
    </script>
</body>
</html>
